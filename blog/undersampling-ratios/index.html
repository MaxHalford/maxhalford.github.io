<!doctype html><html lang=en><head><script async defer data-website-id=6023252a-3a97-470f-b4ee-5082d242bb9a src=https://umami.pourtan.eu/umami.js></script><meta charset=utf-8><meta name=generator content="Hugo 0.109.0"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Max Halford"><meta property="og:url" content="https://maxhalford.github.io/blog/undersampling-ratios/"><link rel=canonical href=https://maxhalford.github.io/blog/undersampling-ratios/><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦”</text></svg>"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/maxhalford.github.io\/"},"articleSection":"blog","name":"Under-sampling a dataset with desired ratios","headline":"Under-sampling a dataset with desired ratios","description":"Introduction I\u0026rsquo;ve just spent a few hours looking at under-sampling and how it can help a classifier learn from an imbalanced dataset. The idea is quite simple: randomly sample the majority class and leave the minority class untouched. There are more sophisticated ways to do this \u0026ndash; for instance by creating synthetic observations from the minority class Ã  la SMOTE \u0026ndash; but I won\u0026rsquo;t be discussing that here.\nI checked out the imblearn library and noticed they have an implementation of random under-sampling aptly named RandomUnderSampler.","inLanguage":"en-US","author":"Max Halford","creator":"Max Halford","publisher":"Max Halford","accountablePerson":"Max Halford","copyrightHolder":"Max Halford","copyrightYear":"2019","datePublished":"2019-12-17 00:00:00 \u002b0000 UTC","dateModified":"2019-12-17 00:00:00 \u002b0000 UTC","url":"https:\/\/maxhalford.github.io\/blog\/undersampling-ratios\/","keywords":["machine-learning"]}</script><title>Under-sampling a dataset with desired ratios â€¢ Max Halford</title><meta property="og:title" content="Under-sampling a dataset with desired ratios â€¢ Max Halford"><meta property="og:type" content="article"><meta name=description content="Introduction I&rsquo;ve just spent a few hours looking at under-sampling and how it can help a classifier learn from an imbalanced dataset. The idea is quite simple: randomly sample the majority class and leave the minority class untouched. There are more sophisticated ways to do this &ndash; for instance by creating synthetic observations from the minority class Ã  la SMOTE &ndash; but I won&rsquo;t be discussing that here.
I checked out the imblearn library and noticed they have an implementation of random under-sampling aptly named RandomUnderSampler."><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/github-markdown.min.css><link rel=stylesheet href=/css/highlight/github.css><link rel=stylesheet href=/css/index.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Permanent+Marker&display=swap" rel=stylesheet><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0,tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><article class=post id=article><div class="row center-xs" style=text-align:left><div class="col-xs-12 col-sm-10 col-md-7 col-lg-5"><div class=header><header class=header-parts><div class="signatures site-title"><a href=/>Max Halford ðŸ¦”</a></div><div class=header-links><a class=header-link href=/>Blog</a>
<a class=header-link href=/links/>Links</a>
<a class=header-link href=/bio/>Bio</a></div></header></div><header class=post-header><h1 class=post-title>Under-sampling a dataset with desired ratios</h1><div class="row post-desc"><div class="col-xs-12 post-desc-items"><time class=post-date datetime="2019-12-17 00:00:00 UTC">2019-12-17</time>
<span class=posts-line-tag>machine-learning</span></div></div></header><div class="post-content markdown-body"><h2 id=introduction>Introduction</h2><p>I&rsquo;ve just spent a few hours looking at under-sampling and how it can help a classifier learn from an imbalanced dataset. The idea is quite simple: randomly sample the majority class and leave the minority class untouched. There are more sophisticated ways to do this &ndash; for instance by creating synthetic observations from the minority class <em>Ã  la</em> <a href=http://rikunert.com/SMOTE_explained>SMOTE</a> &ndash; but I won&rsquo;t be discussing that here.</p><p>I checked out the <a href=https://imbalanced-learn.readthedocs.io/en/stable/index.html><code>imblearn</code></a> library and noticed they have an implementation of random under-sampling aptly named <a href=https://imbalanced-learn.readthedocs.io/en/stable/generated/imblearn.under_sampling.RandomUnderSampler.html#imblearn.under_sampling.RandomUnderSampler><code>RandomUnderSampler</code></a>. It contains a <code>sampling_strategy</code> parameter which gives some control over the sampling. By the default the observations are resampled so that each class is equally represented:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>collections</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn</span> <span class=kn>import</span> <span class=n>datasets</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>imblearn</span> <span class=kn>import</span> <span class=n>under_sampling</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>X</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=n>datasets</span><span class=o>.</span><span class=n>make_classification</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>n_classes</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>weights</span><span class=o>=</span><span class=p>[</span><span class=mf>.1</span><span class=p>,</span> <span class=mf>.6</span><span class=p>,</span> <span class=mf>.3</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>n_informative</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>n_samples</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Original dataset shape </span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>collections</span><span class=o>.</span><span class=n>Counter</span><span class=p>(</span><span class=n>y</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rus</span> <span class=o>=</span> <span class=n>under_sampling</span><span class=o>.</span><span class=n>RandomUnderSampler</span><span class=p>(</span><span class=n>sampling_strategy</span><span class=o>=</span><span class=s1>&#39;auto&#39;</span><span class=p>,</span> <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_res</span><span class=p>,</span> <span class=n>y_res</span> <span class=o>=</span> <span class=n>rus</span><span class=o>.</span><span class=n>fit_resample</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Resampled dataset shape </span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>collections</span><span class=o>.</span><span class=n>Counter</span><span class=p>(</span><span class=n>y_res</span><span class=p>))</span>
</span></span></code></pre></div><p>On my machine this outputs the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>Original</span> <span class=n>dataset</span> <span class=n>shape</span> <span class=n>Counter</span><span class=p>({</span><span class=mi>1</span><span class=p>:</span> <span class=mi>597</span><span class=p>,</span> <span class=mi>2</span><span class=p>:</span> <span class=mi>301</span><span class=p>,</span> <span class=mi>0</span><span class=p>:</span> <span class=mi>102</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>Resampled</span> <span class=n>dataset</span> <span class=n>shape</span> <span class=n>Counter</span><span class=p>({</span><span class=mi>0</span><span class=p>:</span> <span class=mi>102</span><span class=p>,</span> <span class=mi>1</span><span class=p>:</span> <span class=mi>102</span><span class=p>,</span> <span class=mi>2</span><span class=p>:</span> <span class=mi>102</span><span class=p>})</span>
</span></span></code></pre></div><p>The <code>sampling_strategy</code> parameter also accepts a dictionary which specifies the desired counts of each class. For example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>X</span><span class=p>,</span> <span class=n>y</span> <span class=o>=</span> <span class=n>datasets</span><span class=o>.</span><span class=n>make_classification</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>n_classes</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>weights</span><span class=o>=</span><span class=p>[</span><span class=mf>.1</span><span class=p>,</span> <span class=mf>.6</span><span class=p>,</span> <span class=mf>.3</span><span class=p>],</span>  <span class=c1># The actual class ratios</span>
</span></span><span class=line><span class=cl>    <span class=n>n_informative</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>n_samples</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>rus</span> <span class=o>=</span> <span class=n>under_sampling</span><span class=o>.</span><span class=n>RandomUnderSampler</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>sampling_strategy</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=mi>0</span><span class=p>:</span> <span class=mi>50</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mi>1</span><span class=p>:</span> <span class=mi>300</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=mi>2</span><span class=p>:</span> <span class=mi>100</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>X_res</span><span class=p>,</span> <span class=n>y_res</span> <span class=o>=</span> <span class=n>rus</span><span class=o>.</span><span class=n>fit_resample</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Resampled dataset shape </span><span class=si>%s</span><span class=s1>&#39;</span> <span class=o>%</span> <span class=n>collections</span><span class=o>.</span><span class=n>Counter</span><span class=p>(</span><span class=n>y_res</span><span class=p>))</span>
</span></span></code></pre></div><p>Which gives:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>Resampled</span> <span class=n>dataset</span> <span class=n>shape</span> <span class=n>Counter</span><span class=p>({</span><span class=mi>1</span><span class=p>:</span> <span class=mi>300</span><span class=p>,</span> <span class=mi>2</span><span class=p>:</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>0</span><span class=p>:</span> <span class=mi>50</span><span class=p>})</span>
</span></span></code></pre></div><p>Now how about if we want to specify desired ratios instead of counts? For instance we might want class 0 to appear 20% of the time, class 1 30%, and class 2 50%. I was surprised to find out that as of writing this blog post <code>imblearn</code> doesn&rsquo;t support this &ndash; I&rsquo;m using version <code>0.5.0</code>. For instance you can&rsquo;t specify <code>sampling_strategy={0: .2, 1: .3, 2: .5}</code>. It does however allow to do this for binary classification, albeit not directly.</p><p>I was initially interested in doing this for online machine learning purposes. I thus went to <code>imblearn</code> for inspiration and found out that specifying a desired class distribution in terms of ratios wasn&rsquo;t supported. In batch learning this isn&rsquo;t so much an issue because you know how many observations you have and can thus specify class counts instead. However in an online context you don&rsquo;t know how many observations you will encounter and thus need to be able to specify a class distribution in terms of ratios and not in terms of counts. I did some Googling, alas in vain, and thus decided to work it out myself. I found a solution which works for both the batch and online situations.</p><h2 id=the-case-of-2-classes>The case of 2 classes</h2><p>I&rsquo;ll start with the case where there are 2 classes. I&rsquo;ll be reasoning in terms of ratios because it makes sense for both the batch and online situations. Now suppose you have a dataset with the following actual class distribution:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>actual</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kc>True</span><span class=p>:</span> <span class=mf>.1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kc>False</span><span class=p>:</span> <span class=mf>.9</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Your dataset is somewhat imbalanced because there are more <code>False</code>s than <code>True</code>s. Now say you would like your dataset to have the following desired distribution:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>desired</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kc>True</span><span class=p>:</span> <span class=mf>.4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kc>False</span><span class=p>:</span> <span class=mf>.6</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This would make your dataset more balanced. Intuitively, by comparing <code>actual</code> and <code>desired</code>, we can understand that we have to remove some <code>False</code> observations in order to balance the dataset. Indeed, because <code>.4</code> is higher than <code>.1</code>, we might as well keep all the <code>True</code> observations and only discard <code>False</code> observations. The question is thus, how many <code>False</code> observations do we have to remove to obtain the desired class distribution? The question can be reformulated as so: out of 90% percent of <code>False</code>s in the initial dataset, how many do I need to pick in order to obtain 60% in the resampled dataset? Well it&rsquo;s actually <code>.6 / (.4 / .1) / .9</code>. I actually can&rsquo;t remember how I got to the formula but I mostly found it by playing around with the numbers in my head.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=p>(</span><span class=n>desired</span><span class=p>[</span><span class=kc>False</span><span class=p>]</span> <span class=o>*</span> <span class=n>actual</span><span class=p>[</span><span class=kc>True</span><span class=p>])</span> <span class=o>/</span> <span class=p>(</span><span class=n>desired</span><span class=p>[</span><span class=kc>True</span><span class=p>]</span> <span class=o>*</span> <span class=n>actual</span><span class=p>[</span><span class=kc>False</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=mf>0.16666666666666663</span>
</span></span></code></pre></div><p>This means that for each <code>False</code> observation in the dataset, we can pick a random number between 0 and 1, and keep the observation only if the random number is lower than <code>0.166...</code>. Let&rsquo;s try this out; we&rsquo;ll first simulate a stream of <code>True</code>s and <code>False</code>s:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rng</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>Random</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>stream_values</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=n>rng</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=mf>.1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=mi>100000</span>
</span></span><span class=line><span class=cl><span class=n>values</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>stream_values</span><span class=p>(</span><span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>v</span><span class=p>,</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>collections</span><span class=o>.</span><span class=n>Counter</span><span class=p>(</span><span class=n>values</span><span class=p>)</span><span class=o>.</span><span class=n>items</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s1>: </span><span class=si>{</span><span class=n>c</span><span class=si>}</span><span class=s1> (</span><span class=si>{</span><span class=n>c</span> <span class=o>/</span> <span class=n>n</span><span class=si>}</span><span class=s1>)&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>This gives me:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kc>False</span><span class=p>:</span> <span class=mi>89951</span> <span class=p>(</span><span class=mf>0.89951</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kc>True</span><span class=p>:</span> <span class=mi>10049</span> <span class=p>(</span><span class=mf>0.10049</span><span class=p>)</span>
</span></span></code></pre></div><p>Now let&rsquo;s sample the values using our methodology:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>rng</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>Random</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>rates</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kc>True</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kc>False</span><span class=p>:</span> <span class=p>(</span><span class=n>desired</span><span class=p>[</span><span class=kc>False</span><span class=p>]</span> <span class=o>*</span> <span class=n>actual</span><span class=p>[</span><span class=kc>True</span><span class=p>])</span> <span class=o>/</span> <span class=p>(</span><span class=n>desired</span><span class=p>[</span><span class=kc>True</span><span class=p>]</span> <span class=o>*</span> <span class=n>actual</span><span class=p>[</span><span class=kc>False</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sample</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>values</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>rng</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=n>rates</span><span class=p>[</span><span class=n>v</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>sample</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>v</span><span class=p>,</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>collections</span><span class=o>.</span><span class=n>Counter</span><span class=p>(</span><span class=n>sample</span><span class=p>)</span><span class=o>.</span><span class=n>items</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s1>: </span><span class=si>{</span><span class=n>c</span><span class=si>}</span><span class=s1> (</span><span class=si>{</span><span class=n>c</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>sample</span><span class=p>)</span><span class=si>}</span><span class=s1>)&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>This gives us:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kc>False</span><span class=p>:</span> <span class=mi>14867</span> <span class=p>(</span><span class=mf>0.5966848611334082</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kc>True</span><span class=p>:</span> <span class=mi>10049</span> <span class=p>(</span><span class=mf>0.40331513886659176</span><span class=p>)</span>
</span></span></code></pre></div><p>This works well because we can see that the obtained distribution is very close to distribution we want.</p><h2 id=handling-3-classes-and-more>Handling 3 classes and more</h2><p>Let&rsquo;s now move on to the case where there are multiple classes. Let us first notice that the method we just presented for two cases doesn&rsquo;t work if we want to lower the ratio of <code>True</code>s instead of increasing it. Indeed the formula just wouldn&rsquo;t make sense. However, it would work if we reversed <code>False</code> and <code>True</code> in the equation. This stems from the fact that if we are reducing the ratio of <code>True</code>s, then automatically we are increasing the ratio of <code>False</code>s. There is thus always a class ratio which you want to increase. I like to call this class the &ldquo;pivot&rdquo;. We will now see how using a pivot class enables us to balance a dataset with more than two classes. Let&rsquo;s simulate some data:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>rng</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>Random</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>stream_values</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=n>rng</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=mf>.1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=s1>&#39;a&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=mf>0.7</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=s1>&#39;b&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=s1>&#39;c&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=mi>100000</span>
</span></span><span class=line><span class=cl><span class=n>values</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>stream_values</span><span class=p>(</span><span class=n>n</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>v</span><span class=p>,</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>collections</span><span class=o>.</span><span class=n>Counter</span><span class=p>(</span><span class=n>values</span><span class=p>)</span><span class=o>.</span><span class=n>items</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s1>: </span><span class=si>{</span><span class=n>c</span><span class=si>}</span><span class=s1> (</span><span class=si>{</span><span class=n>c</span> <span class=o>/</span> <span class=n>n</span><span class=si>}</span><span class=s1>)&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>Here are the ratios:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>a</span><span class=p>:</span> <span class=mi>10039</span> <span class=p>(</span><span class=mf>0.10039</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>b</span><span class=p>:</span> <span class=mi>59903</span> <span class=p>(</span><span class=mf>0.59903</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=p>:</span> <span class=mi>30058</span> <span class=p>(</span><span class=mf>0.30058</span><span class=p>)</span>
</span></span></code></pre></div><p>The actual distribution is thus:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>actual</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;a&#39;</span><span class=p>:</span> <span class=mf>.1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;b&#39;</span><span class=p>:</span> <span class=mf>.6</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;c&#39;</span><span class=p>:</span> <span class=mf>.3</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now let&rsquo;s say we want to attain the following distribution:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>desired</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;a&#39;</span><span class=p>:</span> <span class=mf>.2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;b&#39;</span><span class=p>:</span> <span class=mf>.4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;c&#39;</span><span class=p>:</span> <span class=mf>.4</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We thus want to increase the percentage of <code>a</code>s as well as of <code>c</code>s. However, the relative increase for <code>a</code> is larger than that of <code>c</code>, and <code>a</code> will thus act as the pivot. We can thus select the pivot by selecting the value with the highest multiplicative increase.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>pivot</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>actual</span><span class=o>.</span><span class=n>keys</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>desired</span><span class=p>[</span><span class=n>x</span><span class=p>]</span> <span class=o>/</span> <span class=n>actual</span><span class=p>[</span><span class=n>x</span><span class=p>])</span>
</span></span></code></pre></div><p>Now we can calculate the sampling rates:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>rates</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>k</span><span class=p>:</span> <span class=p>(</span><span class=n>desired</span><span class=p>[</span><span class=n>k</span><span class=p>]</span> <span class=o>*</span> <span class=n>actual</span><span class=p>[</span><span class=n>pivot</span><span class=p>])</span> <span class=o>/</span> <span class=p>(</span><span class=n>desired</span><span class=p>[</span><span class=n>pivot</span><span class=p>]</span> <span class=o>*</span> <span class=n>actual</span><span class=p>[</span><span class=n>k</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=n>actual</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In our case this gives us:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;a&#39;</span><span class=p>:</span> <span class=mf>1.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;b&#39;</span><span class=p>:</span> <span class=mf>0.3333333333333334</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;c&#39;</span><span class=p>:</span> <span class=mf>0.6666666666666669</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now let&rsquo;s sample:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>rng</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>Random</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sample</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>values</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>rng</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=n>rates</span><span class=p>[</span><span class=n>v</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>sample</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>v</span><span class=p>,</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>collections</span><span class=o>.</span><span class=n>Counter</span><span class=p>(</span><span class=n>sample</span><span class=p>)</span><span class=o>.</span><span class=n>items</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s1>: </span><span class=si>{</span><span class=n>c</span><span class=si>}</span><span class=s1> (</span><span class=si>{</span><span class=n>c</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>sample</span><span class=p>)</span><span class=si>}</span><span class=s1>)&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>Which gives us:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>a</span><span class=p>:</span> <span class=mi>10039</span> <span class=p>(</span><span class=mf>0.2004752775780813</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>b</span><span class=p>:</span> <span class=mi>19928</span> <span class=p>(</span><span class=mf>0.3979551082354821</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=p>:</span> <span class=mi>20109</span> <span class=p>(</span><span class=mf>0.4015696141864366</span><span class=p>)</span>
</span></span></code></pre></div><p>It worked! 10039 <code>a</code>s have been sampled, which is exactly the number of actual <code>a</code>s in the initial set of values. This is because <code>a</code> is the pivot: it is the value that does not have to be under-sampled.</p><h2 id=the-online-setting>The online setting</h2><p>In the examples we just saw the actual value distribution is known. However, in an online setting we don&rsquo;t know it. It can be provided, but in general it has to estimated online. In Python we can do this by incrementing a <code>collections.defaultdict(int)</code> &ndash; or a <code>collections.Counter</code>, as you wish. Naturally this means the pivot can change, which has to be taken care of. I haven&rsquo;t thought about it too much and thus in the following example I simply recalculate the pivot at each iteration. There might be a more efficient way to go about it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>rng</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>Random</span><span class=p>(</span><span class=mi>42</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=mi>100000</span>
</span></span><span class=line><span class=cl><span class=n>sample_counts</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>actual</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>desired</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;a&#39;</span><span class=p>:</span> <span class=mf>.5</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>:</span> <span class=mf>.3</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>:</span> <span class=mf>.2</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>stream_values</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span> <span class=o>=</span> <span class=n>rng</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=mf>.1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=s1>&#39;a&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=mf>.7</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=s1>&#39;b&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=s1>&#39;c&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>stream_values</span><span class=p>(</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>actual</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=n>pivot</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>actual</span><span class=o>.</span><span class=n>keys</span><span class=p>(),</span> <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>desired</span><span class=p>[</span><span class=n>x</span><span class=p>]</span> <span class=o>/</span> <span class=n>actual</span><span class=p>[</span><span class=n>x</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>ratio</span> <span class=o>=</span> <span class=p>(</span><span class=n>desired</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>*</span> <span class=n>actual</span><span class=p>[</span><span class=n>pivot</span><span class=p>])</span> <span class=o>/</span> <span class=p>(</span><span class=n>desired</span><span class=p>[</span><span class=n>pivot</span><span class=p>]</span> <span class=o>*</span> <span class=n>actual</span><span class=p>[</span><span class=n>v</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>rng</span><span class=o>.</span><span class=n>random</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=n>ratio</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>sample_counts</span><span class=p>[</span><span class=n>v</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>v</span><span class=p>,</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span><span class=n>sample_counts</span><span class=o>.</span><span class=n>items</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s1>: </span><span class=si>{</span><span class=n>c</span><span class=si>}</span><span class=s1> (</span><span class=si>{</span><span class=n>c</span> <span class=o>/</span> <span class=nb>sum</span><span class=p>(</span><span class=n>sample_counts</span><span class=o>.</span><span class=n>values</span><span class=p>())</span><span class=si>}</span><span class=s1>)&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>This gives us:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>a</span><span class=p>:</span> <span class=mi>10022</span> <span class=p>(</span><span class=mf>0.500999800039992</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>b</span><span class=p>:</span> <span class=mi>6021</span> <span class=p>(</span><span class=mf>0.3009898020395921</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>c</span><span class=p>:</span> <span class=mi>3961</span> <span class=p>(</span><span class=mf>0.19801039792041591</span><span class=p>)</span>
</span></span></code></pre></div><p>I&rsquo;m quite satisfied by this result. I&rsquo;ll probably be adding an implementation to <a href=https://github.com/creme-ml/creme><code>creme</code></a> in the next few days.</p><p>I&rsquo;ve written this post in a hurry because I&rsquo;m very busy but I wanted to jot something down. If you have any questions/remarks feel free to get in touch!</p></div><script type=text/javascript>var s=document.createElement("script");s.setAttribute("src","https://utteranc.es/client.js"),s.setAttribute("repo","MaxHalford/maxhalford.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",null),s.setAttribute("theme","github-light"),document.body.appendChild(s)</script><div class=footer><div class=do-the-thing><div class=elevator><svg class="sweet-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" enable-background="new 0 0 100 100" height="100" width="100"><path d="M70 47.5H30c-1.4.0-2.5 1.1-2.5 2.5v40c0 1.4 1.1 2.5 2.5 2.5h40c1.4.0 2.5-1.1 2.5-2.5V50C72.5 48.6 71.4 47.5 70 47.5zm-22.5 40h-5v-25h5v25zm10 0h-5v-25h5v25zm10 0h-5V60c0-1.4-1.1-2.5-2.5-2.5H40c-1.4.0-2.5 1.1-2.5 2.5v27.5h-5v-35h35v35z"/><path d="M50 42.5c1.4.0 2.5-1.1 2.5-2.5V16l5.7 5.7c.5.5 1.1.7 1.8.7s1.3-.2 1.8-.7c1-1 1-2.6.0-3.5l-10-10c-1-1-2.6-1-3.5.0l-10 10c-1 1-1 2.6.0 3.5 1 1 2.6 1 3.5.0l5.7-5.7v24c0 1.4 1.1 2.5 2.5 2.5z"/></svg>Back to the top</div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script>
<script>var elementButton=document.querySelector(".elevator"),elevator=new Elevator({element:elementButton,mainAudio:"/music/elevator.mp3",endAudio:"/music/ding.mp3"})</script><style>.down-arrow{font-size:120px;margin-top:90px;margin-bottom:90px;text-shadow:0 -20px #0c1f31,0 0 #c33329;color:transparent;-webkit-transform:scaleY(.8);-moz-transform:scaleY(.8);transform:scaleY(.8)}.elevator{text-align:center;cursor:pointer;width:140px;margin:auto;margin-bottom:30px}.elevator:hover{opacity:.7}.elevator svg{width:40px;height:40px;display:block;margin:auto;margin-bottom:5px}</style><div class=related-content><h3 style=margin-top:10px!important;margin-bottom:10px!important>Related posts</h3><ul style=margin-top:0><li><a href=/blog/machine-learning-production/>A smooth approach to putting machine learning into production</a></li><li><a href=/blog/naive-bayes/>The NaÃ¯ve Bayes classifier</a></li><li><a href=/blog/subsampling-1/>Subsampling a training set to match a test set - Part 1</a></li></ul></div></div></div></article><script></script></body></html>