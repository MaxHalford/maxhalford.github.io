<!doctype html><html lang=en><head><script defer src=https://unpkg.com/@tinybirdco/flock.js data-host=https://api.tinybird.co data-token=p.eyJ1IjogImMwMjJhMjg1LWJmY2YtNDc0OC1hYzczLTJhMDQ1Njk3NTI0YyIsICJpZCI6ICIzNjc3NjQ3Ny04MTE2LTRmYWQtYjcwMy1iZmM3YjMwZGJjMjMifQ.A0vHm-VWbXG6uBFZiwuspN_AyfSYNrdZE3IgwgWSt4g></script><meta charset=utf-8><meta name=generator content="Hugo 0.112.3"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Max Halford"><meta property="og:url" content="https://maxhalford.github.io/blog/sympy-doctests/"><link rel=canonical href=https://maxhalford.github.io/blog/sympy-doctests/><meta property="og:title" content="Using SymPy in Python doctests"><meta property="og:description" content="A program which compiles and runs without errors isn&rsquo;t necessarily correct. I find this to be especially true for statistical software, both as a developer and as a user. Small but nasty bugs creep up on me every week. I keep sane in the membrane by writing many unit tests üêõüî®
I make heavy use of doctests. These are unit tests which you write as Python docstrings. They&rsquo;re really handy because they kill two birds with one stone: the unit tests you write for a function also act as documentation."><meta property="og:type" content="article"><meta property="og:url" content="https://maxhalford.github.io/blog/sympy-doctests/"><meta property="og:image" content="https://maxhalford.github.io/img/beach.jpg"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-02-15T00:00:00+00:00"><meta property="article:modified_time" content="2023-02-15T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maxhalford.github.io/img/beach.jpg"><meta name=twitter:title content="Using SymPy in Python doctests"><meta name=twitter:description content="A program which compiles and runs without errors isn&rsquo;t necessarily correct. I find this to be especially true for statistical software, both as a developer and as a user. Small but nasty bugs creep up on me every week. I keep sane in the membrane by writing many unit tests üêõüî®
I make heavy use of doctests. These are unit tests which you write as Python docstrings. They&rsquo;re really handy because they kill two birds with one stone: the unit tests you write for a function also act as documentation."><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü¶î</text></svg>"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/maxhalford.github.io\/"},"articleSection":"blog","name":"Using SymPy in Python doctests","headline":"Using SymPy in Python doctests","description":"A program which compiles and runs without errors isn\u0026rsquo;t necessarily correct. I find this to be especially true for statistical software, both as a developer and as a user. Small but nasty bugs creep up on me every week. I keep sane in the membrane by writing many unit tests üêõüî®\nI make heavy use of doctests. These are unit tests which you write as Python docstrings. They\u0026rsquo;re really handy because they kill two birds with one stone: the unit tests you write for a function also act as documentation.","inLanguage":"en-US","author":"Max Halford","creator":"Max Halford","publisher":"Max Halford","accountablePerson":"Max Halford","copyrightHolder":"Max Halford","copyrightYear":"2023","datePublished":"2023-02-15 00:00:00 \u002b0000 UTC","dateModified":"2023-02-15 00:00:00 \u002b0000 UTC","url":"https:\/\/maxhalford.github.io\/blog\/sympy-doctests\/","keywords":["python"]}</script><title>Using SymPy in Python doctests ‚Ä¢ Max Halford</title><meta property="og:title" content="Using SymPy in Python doctests ‚Ä¢ Max Halford"><meta property="og:type" content="article"><meta name=description content="A program which compiles and runs without errors isn&rsquo;t necessarily correct. I find this to be especially true for statistical software, both as a developer and as a user. Small but nasty bugs creep up on me every week. I keep sane in the membrane by writing many unit tests üêõüî®
I make heavy use of doctests. These are unit tests which you write as Python docstrings. They&rsquo;re really handy because they kill two birds with one stone: the unit tests you write for a function also act as documentation."><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/github-markdown.min.css><link rel=stylesheet href=/css/highlight/github.css><link rel=stylesheet href=/css/index.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Permanent+Marker&display=swap" rel=stylesheet><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0,tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><article class=post id=article><div class="row center-xs" style=text-align:left><div class="col-xs-12 col-sm-10 col-md-7 col-lg-5"><div class=header><header class=header-parts><div class="signatures site-title"><a href=/>Max Halford ü¶î</a></div><div class=header-links><a class=header-link href=/>Blog</a>
<a class=header-link href=/links/>Links</a>
<a class=header-link href=/bio/>Bio</a></div></header></div><header class=post-header><h1 class=post-title>Using SymPy in Python doctests</h1><div class="row post-desc"><div class="col-xs-12 post-desc-items"><time class=post-date datetime="2023-02-15 00:00:00 UTC">2023-02-15</time>
<span class=posts-line-tag>python</span></div></div></header><div class="post-content markdown-body"><p>A program which compiles and runs without errors isn&rsquo;t necessarily correct. I find this to be especially true for statistical software, both as a developer and as a user. Small but nasty bugs creep up on me every week. I keep sane in the membrane by writing many unit tests üêõüî®</p><p>I make heavy use of <a href=https://docs.python.org/3/library/doctest.html>doctests</a>. These are unit tests which you write as Python <a href=https://realpython.com/documenting-python-code/#documenting-your-python-code-base-using-docstrings>docstrings</a>. They&rsquo;re really handy because they kill two birds with one stone: the unit tests you write for a function also act as documentation.</p><p>A nice trick I&rsquo;ve found is to use <a href=https://www.sympy.org/en/index.html>SymPy</a> to test mathematical formulas. As you know, Python is a dynamic language. This allows functions to consume different types of inputs. The typical example are <a href=https://numpy.org/>NumPy</a> routines, which work with numbers, lists, arrays, series, or a mix of these:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=mi>17</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>22</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>add</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=mi>22</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>array</span><span class=p>([</span><span class=mi>23</span><span class=p>,</span> <span class=mi>24</span><span class=p>,</span> <span class=mi>25</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]),</span> <span class=n>pd</span><span class=o>.</span><span class=n>Series</span><span class=p>([</span><span class=mi>22</span><span class=p>,</span> <span class=mi>23</span><span class=p>,</span> <span class=mi>24</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=mi>0</span>    <span class=mi>23</span>
</span></span><span class=line><span class=cl><span class=mi>1</span>    <span class=mi>25</span>
</span></span><span class=line><span class=cl><span class=mi>2</span>    <span class=mi>27</span>
</span></span><span class=line><span class=cl><span class=n>dtype</span><span class=p>:</span> <span class=n>int64</span>
</span></span></code></pre></div><p>The above code block can be treated as a doctest. For instance, if you put it in a <code>test_add.py</code> file and place <code>"""</code> quotes around it, you can run <code>pytest</code> from the CLI to execute the tests, as so:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>pytest --doctest-modules
</span></span></code></pre></div><pre tabindex=0><code>================ test session starts =======================
platform darwin -- Python 3.11.0, pytest-7.2.0, pluggy-1.0.0
rootdir: /Users/max/projects/maxhalford.github.io
plugins: anyio-3.6.2
collected 1 item

test_add.py .                                         [100%]

================ 1 passed in 0.58s =========================
</code></pre><p>As I was saying, I like using SymPy to test mathematical functions. If a function uses mathematical operators, then there is a good chance you can feed it with SymPy variables as well as numbers and arrays.</p><p>I&rsquo;ll provide an example. A year ago, I added an online version of <a href=https://www.wikiwand.com/en/Autoregressive_integrated_moving_average>ARIMA</a> to <a href=https://riverml.xyz/0.14.0/>River</a>. ARIMA is a time series forecasting model. Like other forecasting models, it assumes the time series is stationary. If it isn&rsquo;t, <a href=https://www.wikiwand.com/en/Autoregressive_integrated_moving_average#Differencing>differencing</a> has to be applied.</p><p>The idea behind differencing is quite intuitive, but the implementation is easy to get wrong. I&rsquo;ve included down below the <code>Differencer</code> class which is currently used in River.</p><details><summary>Click to see the <code>Differencer</code> class</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>collections</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>itertools</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>math</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Differencer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;A time series differencer.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    References
</span></span></span><span class=line><span class=cl><span class=s2>    ----------
</span></span></span><span class=line><span class=cl><span class=s2>    [^1]: [Stationarity and differencing](https://otexts.com/fpp2/stationarity.html)
</span></span></span><span class=line><span class=cl><span class=s2>    [^2]: [Backshift notation](https://otexts.com/fpp2/backshift.html)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>d</span><span class=p>,</span> <span class=n>m</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>d</span> <span class=o>=</span> <span class=n>d</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>m</span> <span class=o>=</span> <span class=n>m</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>n_choose_k</span><span class=p>(</span><span class=n>n</span><span class=p>,</span> <span class=n>k</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>f</span> <span class=o>=</span> <span class=n>math</span><span class=o>.</span><span class=n>factorial</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>f</span><span class=p>(</span><span class=n>n</span><span class=p>)</span> <span class=o>//</span> <span class=n>f</span><span class=p>(</span><span class=n>k</span><span class=p>)</span> <span class=o>//</span> <span class=n>f</span><span class=p>(</span><span class=n>n</span> <span class=o>-</span> <span class=n>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>coeffs</span> <span class=o>=</span> <span class=p>{</span><span class=mi>0</span><span class=p>:</span> <span class=mi>1</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>d</span> <span class=o>+</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>t</span> <span class=o>=</span> <span class=n>k</span> <span class=o>*</span> <span class=n>m</span>
</span></span><span class=line><span class=cl>            <span class=n>coeff</span> <span class=o>=</span> <span class=p>(</span><span class=o>-</span><span class=mi>1</span> <span class=k>if</span> <span class=n>k</span> <span class=o>%</span> <span class=mi>2</span> <span class=k>else</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>n_choose_k</span><span class=p>(</span><span class=n>n</span><span class=o>=</span><span class=n>d</span><span class=p>,</span> <span class=n>k</span><span class=o>=</span><span class=n>k</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>coeffs</span><span class=p>[</span><span class=n>t</span><span class=p>]</span> <span class=o>=</span> <span class=n>coeff</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>n_required_past_values</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>max</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>coeffs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>from_coeffs</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>coeffs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>obj</span> <span class=o>=</span> <span class=bp>cls</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>obj</span><span class=o>.</span><span class=n>coeffs</span> <span class=o>=</span> <span class=n>coeffs</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>obj</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__mul__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>other</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Compose two differencers together.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>coeffs</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=n>t1</span><span class=p>,</span> <span class=n>c1</span><span class=p>),</span> <span class=p>(</span><span class=n>t2</span><span class=p>,</span> <span class=n>c2</span><span class=p>)</span> <span class=ow>in</span> <span class=n>itertools</span><span class=o>.</span><span class=n>product</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>coeffs</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span> <span class=n>other</span><span class=o>.</span><span class=n>coeffs</span><span class=o>.</span><span class=n>items</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>            <span class=n>coeffs</span><span class=p>[</span><span class=n>t1</span> <span class=o>+</span> <span class=n>t2</span><span class=p>]</span> <span class=o>+=</span> <span class=n>c1</span> <span class=o>*</span> <span class=n>c2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Remove 0 coefficients</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>t</span><span class=p>,</span> <span class=n>c</span> <span class=ow>in</span> <span class=nb>list</span><span class=p>(</span><span class=n>coeffs</span><span class=o>.</span><span class=n>items</span><span class=p>()):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>c</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>del</span> <span class=n>coeffs</span><span class=p>[</span><span class=n>t</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Differencer</span><span class=o>.</span><span class=n>from_coeffs</span><span class=p>(</span><span class=nb>dict</span><span class=p>(</span><span class=n>coeffs</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>diff</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>Y</span><span class=p>:</span> <span class=nb>list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Differentiate by applying each coefficient c at each index t.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Parameters
</span></span></span><span class=line><span class=cl><span class=s2>        ----------
</span></span></span><span class=line><span class=cl><span class=s2>        Y
</span></span></span><span class=line><span class=cl><span class=s2>            The window of previous values. The first element is assumed to be the most recent
</span></span></span><span class=line><span class=cl><span class=s2>            value.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>total</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>t</span><span class=p>,</span> <span class=n>c</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>coeffs</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>total</span> <span class=o>+=</span> <span class=p>(</span><span class=n>c</span> <span class=o>*</span> <span class=n>Y</span><span class=p>[</span><span class=n>t</span> <span class=o>-</span> <span class=mi>1</span><span class=p>])</span> <span class=k>if</span> <span class=n>t</span> <span class=k>else</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>IndexError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>total</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>undiff</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>Y</span><span class=p>:</span> <span class=nb>list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Differentiate by applying each coefficient c at each index t.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        Parameters
</span></span></span><span class=line><span class=cl><span class=s2>        ----------
</span></span></span><span class=line><span class=cl><span class=s2>        Y
</span></span></span><span class=line><span class=cl><span class=s2>            The window of previous values. The first element is assumed to be the most recent
</span></span></span><span class=line><span class=cl><span class=s2>            value.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>total</span> <span class=o>=</span> <span class=n>p</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>t</span><span class=p>,</span> <span class=n>c</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>coeffs</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>t</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>total</span> <span class=o>-=</span> <span class=n>c</span> <span class=o>*</span> <span class=n>Y</span><span class=p>[</span><span class=n>t</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>IndexError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>total</span>
</span></span></code></pre></div></details><p>Here are some usage examples:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Differencer</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=p>[</span><span class=mi>7</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>12</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=mi>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Differencer</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=p>[</span><span class=mi>7</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>12</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=mi>7</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Differencer</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=p>[</span><span class=mi>7</span><span class=p>,</span> <span class=mi>11</span><span class=p>,</span> <span class=mi>12</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=o>-</span><span class=mi>2</span>
</span></span></code></pre></div><p>How do we know these doctests are correct? We could check with pen and paper. But that&rsquo;s not fully satisfying because we&rsquo;d only be testing a limited range of inputs. Moreover, the above doctests don&rsquo;t really give any insight as to how the algorithm works, which is one of the selling points of doctests.</p><p>Let&rsquo;s write these unit tests with SymPy. The way it works is by defining symbols. I&rsquo;ll start with a $p$ symbol, which stands for the value which we want to differentiate.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=kn>import</span> <span class=nn>sympy</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>p</span> <span class=o>=</span> <span class=n>sympy</span><span class=o>.</span><span class=n>symbols</span><span class=p>(</span><span class=s1>&#39;p&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>p</span>
</span></span><span class=line><span class=cl><span class=n>p</span>
</span></span></code></pre></div><p>Differentiating a value involves subtracting and adding past values $Y$ to the current value $p$. The last observed value is $Y_t$, while the penultimate one is $Y_{t-1}$. This goes all the way back to $Y_0$, which is the first value in the time series. To implement this variable which supports indexing, I made a little <code>IndexedSymbol</code> class with SymPy:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>class</span> <span class=nc>IndexedSymbol</span><span class=p>(</span><span class=n>sympy</span><span class=o>.</span><span class=n>IndexedBase</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>sympy</span><span class=o>.</span><span class=n>symbols</span><span class=p>(</span><span class=s2>&#34;t&#34;</span><span class=p>,</span> <span class=bp>cls</span><span class=o>=</span><span class=n>sympy</span><span class=o>.</span><span class=n>Idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__getitem__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>idx</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__getitem__</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>t</span> <span class=o>-</span> <span class=n>idx</span><span class=p>)</span>
</span></span></code></pre></div><p>This variable can be accessed at any time <code>t</code> thanks to the <code>__getitem__</code> implementation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Y</span> <span class=o>=</span> <span class=n>IndexedSymbol</span><span class=p>(</span><span class=s1>&#39;Y&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Y</span>
</span></span><span class=line><span class=cl><span class=n>Y</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Y</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>Y</span><span class=p>[</span><span class=n>t</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>y</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>Y</span><span class=p>[</span><span class=n>t</span> <span class=o>-</span> <span class=mi>2</span><span class=p>]</span>
</span></span></code></pre></div><p>Now we have everything we need to write pretty unit tests. The first case is a differencer which does nothing. Here I&rsquo;ll use <a href=https://www.wikiwand.com/en/Lag_operator>backshift notation</a> to describe lag operations. I&rsquo;ll actually reproduce the <a href=https://otexts.com/fpp2/backshift.html>examples</a> Rob J. Hyndman and George Athanasopoulos provide in their <a href=https://otexts.com/fpp2/><em>Forecasting: Principles and Practice</em></a> textbook.</p><p>$$(1 - B)^0 = 1$$</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Differencer</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>Y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span>
</span></span></code></pre></div><p>As expected, the output is just $p$, because no differencing is applied. Note that the inputs are SymPy objects, and the output is also a SymPy object. In other words, we&rsquo;re writing tests with mathematical variables, and not just numbers. What about if we want to apply one level of differentiation?</p><p>$$(1 - B)^1$$</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Differencer</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>Y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>-</span> <span class=n>Y</span><span class=p>[</span><span class=n>t</span><span class=p>]</span>
</span></span></code></pre></div><p>We see that this subtracts the last value to the current value, which is correct. What about a second level of differentiation?</p><p>$$(1 - B)^2$$</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=n>Differencer</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>Y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>+</span> <span class=n>Y</span><span class=p>[</span><span class=n>t</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>-</span> <span class=mi>2</span><span class=o>*</span><span class=n>Y</span><span class=p>[</span><span class=n>t</span><span class=p>]</span>
</span></span></code></pre></div><p>What about seasonal differencing? That is, we want to differentiate the current value with respect to the time series $m$ periods ago. For instance, with monthly data, it&rsquo;s typical to subtract the value 12 periods ago to the current value. The <code>Differencer</code> class has a <code>__mul__</code> method, which means we can multiply two <code>Differencer</code>s together to get a new one.</p><p>$$(1 - B)(1 - B^{12})$$</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=o>&gt;&gt;&gt;</span> <span class=p>(</span><span class=n>Differencer</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=n>Differencer</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>12</span><span class=p>))</span><span class=o>.</span><span class=n>diff</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>Y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>-</span> <span class=n>Y</span><span class=p>[</span><span class=n>t</span> <span class=o>-</span> <span class=mi>11</span><span class=p>]</span> <span class=o>+</span> <span class=n>Y</span><span class=p>[</span><span class=n>t</span> <span class=o>-</span> <span class=mi>12</span><span class=p>]</span> <span class=o>-</span> <span class=n>Y</span><span class=p>[</span><span class=n>t</span><span class=p>]</span>
</span></span></code></pre></div><p>This is cool because we can tell the output is correct, regardless of the actual values <code>Y</code> contains. If you test using numbers, then there is a chance the output is correct due to luck. In other words, your implementation might be correct for the values you test it with, but not for all possible values. Testing with SymPy variables takes this uncertainty away.</p></div><script type=text/javascript>var s=document.createElement("script");s.setAttribute("src","https://utteranc.es/client.js"),s.setAttribute("repo","MaxHalford/maxhalford.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",null),s.setAttribute("theme","github-light"),document.body.appendChild(s)</script><div style=display:flex;flex-direction:row;justify-content:center;align-items:center;gap:20px;margin-bottom:30px><div class=do-the-thing><div class=elevator><svg class="sweet-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" enable-background="new 0 0 100 100" height="100" width="100"><path d="M70 47.5H30c-1.4.0-2.5 1.1-2.5 2.5v40c0 1.4 1.1 2.5 2.5 2.5h40c1.4.0 2.5-1.1 2.5-2.5V50C72.5 48.6 71.4 47.5 70 47.5zm-22.5 40h-5v-25h5v25zm10 0h-5v-25h5v25zm10 0h-5V60c0-1.4-1.1-2.5-2.5-2.5H40c-1.4.0-2.5 1.1-2.5 2.5v27.5h-5v-35h35v35z"/><path d="M50 42.5c1.4.0 2.5-1.1 2.5-2.5V16l5.7 5.7c.5.5 1.1.7 1.8.7s1.3-.2 1.8-.7c1-1 1-2.6.0-3.5l-10-10c-1-1-2.6-1-3.5.0l-10 10c-1 1-1 2.6.0 3.5 1 1 2.6 1 3.5.0l5.7-5.7v24c0 1.4 1.1 2.5 2.5 2.5z"/></svg>Back to the top</div></div><iframe src=https://github.com/sponsors/MaxHalford/button title="Sponsor MaxHalford" height=32 width=114 style=border:0;border-radius:6px></iframe></div><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script>
<script>var elementButton=document.querySelector(".elevator"),elevator=new Elevator({element:elementButton,mainAudio:"/music/elevator.mp3",endAudio:"/music/ding.mp3"})</script><style>.down-arrow{font-size:120px;margin-top:90px;margin-bottom:90px;text-shadow:0 -20px #0c1f31,0 0 #c33329;color:transparent;-webkit-transform:scaleY(.8);-moz-transform:scaleY(.8);transform:scaleY(.8)}.elevator{text-align:center;cursor:pointer;width:140px;margin:auto}.elevator:hover{opacity:.7}.elevator svg{width:40px;height:40px;display:block;margin:auto;margin-bottom:5px}</style><div class=related-content><h3 style=margin-top:10px!important;margin-bottom:10px!important>Related posts</h3><ul style=margin-top:0><li><a href=/blog/weighted-sampling-without-replacement/>Weighted sampling without replacement in pure Python</a></li></ul></div></div></div></article><script></script></body></html>