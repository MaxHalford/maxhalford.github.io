<!doctype html><html lang=en><head><script defer src=https://unpkg.com/@tinybirdco/flock.js data-host=https://api.tinybird.co data-token=p.eyJ1IjogImMwMjJhMjg1LWJmY2YtNDc0OC1hYzczLTJhMDQ1Njk3NTI0YyIsICJpZCI6ICIzNjc3NjQ3Ny04MTE2LTRmYWQtYjcwMy1iZmM3YjMwZGJjMjMifQ.A0vHm-VWbXG6uBFZiwuspN_AyfSYNrdZE3IgwgWSt4g></script><meta charset=utf-8><meta name=generator content="Hugo 0.123.6"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Max Halford"><meta property="og:url" content="https://maxhalford.github.io/blog/dbt-ref-rant/"><link rel=canonical href=https://maxhalford.github.io/blog/dbt-ref-rant/><meta property="og:title" content="A rant against dbt ref"><meta property="og:description" content="Disclaimer Let me be absolutely clear: I think dbt is a great tool. Although this post is a rant, the goal is to be constructive and suggest an improvement.
dbt in a nutshell dbt is a workflow orchestrator for SQL. In other words, it&rsquo;s a fancy Make for data analytics. What makes dbt special is that it is the first workflow orchestrator that is dedicated to the SQL language. It said out loud what many data teams were thinking: you can get a lot done with SQL."><meta property="og:type" content="article"><meta property="og:url" content="https://maxhalford.github.io/blog/dbt-ref-rant/"><meta property="og:image" content="https://maxhalford.github.io/img/belle-ile.jpg"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-06-28T00:00:00+00:00"><meta property="article:modified_time" content="2022-06-28T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maxhalford.github.io/img/belle-ile.jpg"><meta name=twitter:title content="A rant against dbt ref"><meta name=twitter:description content="Disclaimer Let me be absolutely clear: I think dbt is a great tool. Although this post is a rant, the goal is to be constructive and suggest an improvement.
dbt in a nutshell dbt is a workflow orchestrator for SQL. In other words, it&rsquo;s a fancy Make for data analytics. What makes dbt special is that it is the first workflow orchestrator that is dedicated to the SQL language. It said out loud what many data teams were thinking: you can get a lot done with SQL."><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦†</text></svg>"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/maxhalford.github.io\/"},"articleSection":"blog","name":"A rant against dbt ref","headline":"A rant against dbt ref","description":"Disclaimer Let me be absolutely clear: I think dbt is a great tool. Although this post is a rant, the goal is to be constructive and suggest an improvement.\ndbt in a nutshell dbt is a workflow orchestrator for SQL. In other words, it\u0026rsquo;s a fancy Make for data analytics. What makes dbt special is that it is the first workflow orchestrator that is dedicated to the SQL language. It said out loud what many data teams were thinking: you can get a lot done with SQL.","inLanguage":"en-US","author":"Max Halford","creator":"Max Halford","publisher":"Max Halford","accountablePerson":"Max Halford","copyrightHolder":"Max Halford","copyrightYear":"2022","datePublished":"2022-06-28 00:00:00 \u002b0000 UTC","dateModified":"2022-06-28 00:00:00 \u002b0000 UTC","url":"https:\/\/maxhalford.github.io\/blog\/dbt-ref-rant\/","keywords":["data-eng","sql","rant"]}</script><title>A rant against dbt ref â€¢ Max Halford</title>
<meta property="og:title" content="A rant against dbt ref â€¢ Max Halford"><meta property="og:type" content="article"><meta name=description content="Disclaimer Let me be absolutely clear: I think dbt is a great tool. Although this post is a rant, the goal is to be constructive and suggest an improvement.
dbt in a nutshell dbt is a workflow orchestrator for SQL. In other words, it&rsquo;s a fancy Make for data analytics. What makes dbt special is that it is the first workflow orchestrator that is dedicated to the SQL language. It said out loud what many data teams were thinking: you can get a lot done with SQL."><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/github-markdown.min.css><link rel=stylesheet href=/css/highlight/github.css><link rel=stylesheet href=/css/index.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Permanent+Marker&display=swap" rel=stylesheet><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0,tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><article class=post id=article><div class="row center-xs" style=text-align:left><div class="col-xs-12 col-sm-10 col-md-7 col-lg-5"><div class=header><header class=header-parts><div class="signatures site-title"><a href=/>Max Halford ðŸ¦†</a></div><div class=header-links><a class=header-link href=/>Blog</a>
<a class=header-link href=/links/>Links</a>
<a class=header-link href=/bio/>Bio</a></div></header></div><header class=post-header><h1 class=post-title>A rant against dbt ref</h1><div class="row post-desc"><div class="col-xs-12 post-desc-items"><time class=post-date datetime="2022-06-28 00:00:00 UTC">2022-06-28
</time><span class=posts-line-tag>data-eng</span>
<span class=posts-line-tag>sql</span>
<span class=posts-line-tag>rant</span></div></div></header><div class="post-content markdown-body"><h2 id=toc>Table of contents</h2><nav id=TableOfContents><ul><li><a href=#disclaimer>Disclaimer</a></li><li><a href=#dbt-in-a-nutshell>dbt in a nutshell</a></li><li><a href=#the-good>The good</a></li><li><a href=#the-bad>The bad</a></li><li><a href=#the-ugly>The ugly</a></li><li><a href=#a-humble-suggestion>A humble suggestion</a></li></ul></nav><h2 id=disclaimer>Disclaimer</h2><p><em>Let me be absolutely clear: I think dbt is a great tool. Although this post is a rant, the goal is to be constructive and suggest an improvement.</em></p><h2 id=dbt-in-a-nutshell>dbt in a nutshell</h2><p><a href=https://www.getdbt.com/>dbt</a> is a workflow orchestrator for SQL. In other words, it&rsquo;s a fancy <a href=https://www.wikiwand.com/en/Make_(software)>Make</a> for data analytics. What makes dbt special is that it is the first workflow orchestrator that is dedicated to the SQL language. It said out loud what many data teams were thinking: you can get a lot done with SQL.</p><p>A workflow orchestrator is necessary to organise tasks into a DAG, and then execute (a subset of) tasks in the correct order. Some orchestrators need to be told which tasks depend on other tasks. Other might determine dependencies automatically. A good orchestrator should trivialise this operation and make you feel productive.</p><div align=center><figure><img src=/img/blog/dbt-ref-rant/dag-example.png style=box-shadow:none><figcaption><i>A typical workflow DAG. Boxes are tasks. Arrows are dependencies.</i></figcaption></figure></div><h2 id=the-good>The good</h2><p>The emergence of dbt is one of the nicest things that happened to the data analytics field in recent years.</p><p>There&rsquo;s no doubt about dbt being an influencial tool. Instead of improving an existing workflow, it created its own paradigm. To me, it feels like what scikit-learn did for machine learning with its fit/predict concept, or what columnar databases did when they ousted Hadoop. dbt is setting a standard which most of its users seem to agree on.</p><p>dbt encourages you to massage your data in SQL rather than in, say, Python. SQL is a language that <a href=https://www.wikiwand.com/en/SQL>was designed</a> to manipulate data, which is likely why dbt feels so natural. The rumors that <a href=https://www.getdbt.com/blog/next-layer-of-the-modern-data-stack/>many teams are adopting it</a> is a testimony to dbt&rsquo;s pervasiveness.</p><p>Just this week I chuckled while reading <a href=https://www.blef.fr/>blef.fr</a>, when I learned about a new tool called <a href=https://github.com/fal-ai/fal>fal</a>. The latter presents itself as &ldquo;dbt for Python&rdquo;. To me that&rsquo;s just a sexier way to say &ldquo;Airflow&rdquo;. The fact that dbt is generating offsprings tells you it caught the Zeitgeist. In short, dbt is <em>Ã  la mode</em>.</p><h2 id=the-bad>The bad</h2><p>And yet, from where I stand, all that glitters is not gold.</p><p>One of dbt&rsquo;s central features is the <code>ref</code> function. In fact, to quote their <a href=https://docs.getdbt.com/reference/dbt-jinja-functions/ref>documentation</a>:</p><blockquote><p>The most important function in dbt is ref(); it&rsquo;s impossible to build even moderately complex models without it.</p></blockquote><p>With dbt, instead of writing literal table names, you reference them:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- before
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>user_id</span><span class=p>,</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>purchases</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>user_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- after
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=err>{{</span><span class=w> </span><span class=k>ref</span><span class=p>(</span><span class=s1>&#39;users&#39;</span><span class=p>)</span><span class=w> </span><span class=err>}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=err>{{</span><span class=w> </span><span class=k>ref</span><span class=p>(</span><span class=s1>&#39;purchases&#39;</span><span class=p>)</span><span class=w> </span><span class=err>}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>user_id</span><span class=w>
</span></span></span></code></pre></div><p>What&rsquo;s the point? Again, I&rsquo;ll quote the documentation:</p><blockquote><p><code>ref()</code> is, under the hood, actually doing two important things. <span style=color:#228b22>First, it is interpolating the schema into your model file to allow you to change your deployment schema via configuration.</span> <span style=color:#cd5c5c>Second, it is using these references between models to automatically build the dependency graph. This will enable dbt to deploy models in the correct order when using <code>dbt run</code>.</span></p></blockquote><p>The crux of my rant is around their <span style=color:#cd5c5c>second point</span>. I hate that you have to specify dependencies by hard-coding them with <code>ref(something)</code>. It feels like the opposite of magic. I shouldn&rsquo;t have to hold dbt&rsquo;s hand and tell it what my query depends on. I would instead expect dbt to parse my SQL and determine the dependencies by itself. From my experience, you can already get a lot covered with a bit of regex:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>SELECT user_id, COUNT(*)
</span></span></span><span class=line><span class=cl><span class=s2>FROM users
</span></span></span><span class=line><span class=cl><span class=s2>LEFT JOIN purchases
</span></span></span><span class=line><span class=cl><span class=s2>GROUP BY user_id
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pattern</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=sa>r</span><span class=s1>&#39;(FROM|(LEFT|RIGHT|INNER|OUTER)? JOIN) (?P&lt;table&gt;\w+)&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dependencies</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=s2>&#34;table&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=k>match</span> <span class=ow>in</span> <span class=n>re</span><span class=o>.</span><span class=n>finditer</span><span class=p>(</span><span class=n>pattern</span><span class=p>,</span> <span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The thing I dislike about <code>ref</code> is that I can&rsquo;t just copy/paste my SQL query into my database client and execute it. I have to fiddle about and remove the curly braces and single quotes by hand for it to run. It&rsquo;s annoying to me because I like debugging queries that way. Granted, you can access the compiled SQL in the <code>target</code> directory which dbt generates. In fact, there&rsquo;s <a href=https://docs.getdbt.com/docs/faqs/checking-logs>a section</a> in dbt&rsquo;s FAQ about this. But this isn&rsquo;t a design decision which pushes you into <a href=https://blog.codinghorror.com/falling-into-the-pit-of-success/>The Pit Of Success</a>.</p><p>I do however agree with their <span style=color:#228b22>first point</span>. It&rsquo;s important to be able to build your tables in different environments, such as development or staging, as well as in production. However, I would argue there are alternative ways to do this. At Alan we had our own dbt-like tool, and we just prepended a schema to our output tables. We didn&rsquo;t need anything like this <code>ref</code> function.</p><h2 id=the-ugly>The ugly</h2><p>Rant aside, the real problem with the <code>ref</code> function is that you <em>can</em> still write your queries without it. The issue is that when dbt determines the dependencies, builds the execution DAG, and runs the queries in the resulting order, it won&rsquo;t magically indicate you forgot to specify a <code>ref</code>. Therefore, if your query $Q$ depends on a table $X$, there&rsquo;s no guarantee that said table $X$ will be refreshed when $Q$ is executed.</p><p>This can lead to silent bugs, akin to what Donald Rumsfeld would call <a href=https://www.wikiwand.com/en/There_are_known_knowns><em>unknown unknowns</em></a>. Things get even worse if you start executing views in parallel. Indeed, the bug will become transient and you won&rsquo;t be able to reproduce it in a reliable manner. The result is a recipe for headaches.</p><p>Sure, there are ways to avoid this issue. You could visually inspect the execution DAG. You could rely on your colleagues, if you have any, to review your code. You could also add a linter in your CI routine to check this for you. But all these options feel like duct tape to me. By design, a good workflow orchestrator should have guardrails which prevent this issue in the first place.</p><h2 id=a-humble-suggestion>A humble suggestion</h2><p>In my opinion, dbt should determine dependencies by parsing the raw SQL code. The <code>ref</code> function shouldn&rsquo;t exist. I gave a piece of Python code above to do this with a regex pattern. But SQL is a formal language, so instead of messing about with regexes, you can use a dedicated parser such as <a href=https://github.com/andialbrecht/sqlparse>sqlparse</a>. There&rsquo;s also an example of <a href=https://github.com/macbre/sql-metadata#extracting-tables-from-query>extracting table names</a> from a query in <a href=https://github.com/macbre/sql-metadata>sql-metadata</a>.</p><p>Of course, I don&rsquo;t understand all the ramifications the change I suggest would imply. And I&rsquo;m sure there are some good reasons why the <code>ref</code> function was introduced. Still, I would much rather use a version of dbt that doesn&rsquo;t have the <code>ref</code> function. Actually, I&rsquo;m so adamant on this that I wrote my own dbt-like tool at my day job. It&rsquo;s 240 lines of Python, including empty lines and comments. It doesn&rsquo;t have the all the templating bells and whistles dbt has, but it does the job and makes me feel productive. In particular, it works with views written in SQL as well as Python. Here is the code for posterity:</p><details><summary>minidbt.py</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Usage example:
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>python minidbt.py
</span></span></span><span class=line><span class=cl><span class=s2>python minidbt.py --only view_A --only view_B
</span></span></span><span class=line><span class=cl><span class=s2>python minidbt.py --start view_A
</span></span></span><span class=line><span class=cl><span class=s2>python minidbt.py --end view_B
</span></span></span><span class=line><span class=cl><span class=s2>python minidbt.py --viz
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>This works for SQL (.sql) as well as Python (.py) views.
</span></span></span><span class=line><span class=cl><span class=s2>The views are assumed to be stored in a views directory.
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>abc</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>ast</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>dataclasses</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>importlib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>itertools</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pathlib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>typing</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>networkx</span> <span class=k>as</span> <span class=nn>nx</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>typer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>google.cloud</span> <span class=kn>import</span> <span class=n>bigquery</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclasses.dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>View</span><span class=p>(</span><span class=n>abc</span><span class=o>.</span><span class=n>ABC</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>path</span><span class=p>:</span> <span class=n>pathlib</span><span class=o>.</span><span class=n>Path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>__post_init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=n>pathlib</span><span class=o>.</span><span class=n>Path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>path</span> <span class=o>=</span> <span class=n>pathlib</span><span class=o>.</span><span class=n>Path</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>name</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>stem</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>from_path</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>path</span><span class=o>.</span><span class=n>suffix</span> <span class=o>==</span> <span class=s2>&#34;.py&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>PythonView</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>path</span><span class=o>.</span><span class=n>suffix</span> <span class=o>==</span> <span class=s2>&#34;.sql&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>SQLView</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=nd>@abc.abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>dependencies</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>typing</span><span class=o>.</span><span class=n>Set</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@abc.abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>client</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SQLView</span><span class=p>(</span><span class=n>View</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>query</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>read_text</span><span class=p>()</span><span class=o>.</span><span class=n>rstrip</span><span class=p>()</span><span class=o>.</span><span class=n>rstrip</span><span class=p>(</span><span class=s2>&#34;;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>cte_names</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>pattern</span> <span class=o>=</span> <span class=sa>r</span><span class=s1>&#39;&#34;?(?P&lt;table&gt;\w+)&#34;? AS \(&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=s2>&#34;table&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=k>match</span> <span class=ow>in</span> <span class=n>re</span><span class=o>.</span><span class=n>finditer</span><span class=p>(</span><span class=n>pattern</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>query</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>IGNORECASE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@classmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_parse_sql_dependencies</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>query</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>pattern</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=sa>r</span><span class=s1>&#39;(FROM|(LEFT|RIGHT|INNER|OUTER)? JOIN) &#34;?(?P&lt;schema&gt;\w+)\.(?P&lt;table&gt;\w+)&#34;?&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>match</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=s2>&#34;table&#34;</span><span class=p>)</span> <span class=k>for</span> <span class=k>match</span> <span class=ow>in</span> <span class=n>re</span><span class=o>.</span><span class=n>finditer</span><span class=p>(</span><span class=n>pattern</span><span class=p>,</span> <span class=n>query</span><span class=p>,</span> <span class=n>re</span><span class=o>.</span><span class=n>IGNORECASE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>dependencies</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_parse_sql_dependencies</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span> <span class=o>=</span> <span class=n>bigquery</span><span class=o>.</span><span class=n>Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>job</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>create_job</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;destinationTable&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;projectId&#34;</span><span class=p>:</span> <span class=s2>&#34;carbonfact&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;datasetId&#34;</span><span class=p>:</span> <span class=s2>&#34;analytics&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;tableId&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;createDisposition&#34;</span><span class=p>:</span> <span class=s2>&#34;CREATE_IF_NEEDED&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;writeDisposition&#34;</span><span class=p>:</span> <span class=s2>&#34;WRITE_TRUNCATE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>job</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PythonView</span><span class=p>(</span><span class=n>View</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@property</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>dependencies</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>_dependencies</span><span class=p>():</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>code</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>read_text</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>ast</span><span class=o>.</span><span class=n>walk</span><span class=p>(</span><span class=n>ast</span><span class=o>.</span><span class=n>parse</span><span class=p>(</span><span class=n>code</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>                <span class=c1># pd.read_gbq</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=nb>isinstance</span><span class=p>(</span><span class=n>node</span><span class=p>,</span> <span class=n>ast</span><span class=o>.</span><span class=n>Call</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=ow>and</span> <span class=n>node</span><span class=o>.</span><span class=n>func</span><span class=o>.</span><span class=n>value</span><span class=o>.</span><span class=n>id</span> <span class=o>==</span> <span class=s2>&#34;pd&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=ow>and</span> <span class=n>node</span><span class=o>.</span><span class=n>func</span><span class=o>.</span><span class=n>attr</span> <span class=o>==</span> <span class=s2>&#34;read_gbq&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=k>yield from</span> <span class=n>SQLView</span><span class=o>.</span><span class=n>_parse_sql_dependencies</span><span class=p>(</span><span class=n>node</span><span class=o>.</span><span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=ne>AttributeError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1># .query</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>node</span><span class=p>,</span> <span class=n>ast</span><span class=o>.</span><span class=n>Call</span><span class=p>)</span> <span class=ow>and</span> <span class=n>node</span><span class=o>.</span><span class=n>func</span><span class=o>.</span><span class=n>attr</span> <span class=o>==</span> <span class=s2>&#34;query&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>yield from</span> <span class=n>SQLView</span><span class=o>.</span><span class=n>_parse_sql_dependencies</span><span class=p>(</span><span class=n>node</span><span class=o>.</span><span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=ne>AttributeError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>set</span><span class=p>(</span><span class=n>_dependencies</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>client</span> <span class=o>=</span> <span class=n>bigquery</span><span class=o>.</span><span class=n>Client</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>mod</span> <span class=o>=</span> <span class=n>importlib</span><span class=o>.</span><span class=n>import_module</span><span class=p>(</span><span class=s2>&#34;views&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span> <span class=o>=</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>mod</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=p>)</span><span class=o>.</span><span class=n>output</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>job_config</span> <span class=o>=</span> <span class=n>bigquery</span><span class=o>.</span><span class=n>LoadJobConfig</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>schema</span><span class=o>=</span><span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=n>write_disposition</span><span class=o>=</span><span class=s2>&#34;WRITE_TRUNCATE&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>job</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>load_table_from_dataframe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>output</span><span class=p>,</span> <span class=sa>f</span><span class=s2>&#34;carbonfact.analytics.</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>job_config</span><span class=o>=</span><span class=n>job_config</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>job</span><span class=o>.</span><span class=n>result</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DAGOfViews</span><span class=p>(</span><span class=n>nx</span><span class=o>.</span><span class=n>DiGraph</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>views</span><span class=p>:</span> <span class=n>typing</span><span class=o>.</span><span class=n>List</span><span class=p>[</span><span class=n>View</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>dependency</span><span class=p>,</span> <span class=n>view</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>view</span> <span class=ow>in</span> <span class=n>views</span> <span class=ow>or</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>dependency</span> <span class=ow>in</span> <span class=n>view</span><span class=o>.</span><span class=n>dependencies</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># Some views have no dependencies but still have to be included</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>view</span> <span class=ow>in</span> <span class=n>views</span> <span class=ow>or</span> <span class=p>[]:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>add_node</span><span class=p>(</span><span class=n>view</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>only</span><span class=p>:</span> <span class=n>typing</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=n>typing</span><span class=o>.</span><span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=n>typer</span><span class=o>.</span><span class=n>Option</span><span class=p>(</span><span class=kc>None</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span><span class=p>:</span> <span class=n>typing</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>typer</span><span class=o>.</span><span class=n>Option</span><span class=p>(</span><span class=kc>None</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>end</span><span class=p>:</span> <span class=n>typing</span><span class=o>.</span><span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>typer</span><span class=o>.</span><span class=n>Option</span><span class=p>(</span><span class=kc>None</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>inclusive</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>viz</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Enumerate the views</span>
</span></span><span class=line><span class=cl>    <span class=n>here</span> <span class=o>=</span> <span class=n>pathlib</span><span class=o>.</span><span class=n>Path</span><span class=p>(</span><span class=vm>__file__</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>views</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>View</span><span class=o>.</span><span class=n>from_path</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>itertools</span><span class=o>.</span><span class=n>chain</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>here</span><span class=o>.</span><span class=n>parent</span><span class=o>.</span><span class=n>glob</span><span class=p>(</span><span class=s2>&#34;views/*.py&#34;</span><span class=p>),</span> <span class=n>here</span><span class=o>.</span><span class=n>parent</span><span class=o>.</span><span class=n>glob</span><span class=p>(</span><span class=s2>&#34;views/*.sql&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>path</span><span class=o>.</span><span class=n>name</span> <span class=o>!=</span> <span class=s2>&#34;__init__.py&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>dag</span> <span class=o>=</span> <span class=n>DAGOfViews</span><span class=p>(</span><span class=n>views</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>views</span> <span class=o>=</span> <span class=p>{</span><span class=n>view</span><span class=o>.</span><span class=n>name</span><span class=p>:</span> <span class=n>view</span> <span class=k>for</span> <span class=n>view</span> <span class=ow>in</span> <span class=n>views</span> <span class=k>if</span> <span class=n>view</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Determine the execution order</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>only</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=n>only</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>start</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=p>[</span><span class=n>start</span><span class=p>]</span> <span class=k>if</span> <span class=n>inclusive</span> <span class=k>else</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>src</span><span class=p>,</span> <span class=n>dst</span> <span class=ow>in</span> <span class=n>nx</span><span class=o>.</span><span class=n>bfs_edges</span><span class=p>(</span><span class=n>dag</span><span class=p>,</span> <span class=n>start</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>order</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>order</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>end</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>subset</span> <span class=o>=</span> <span class=p>{</span><span class=n>end</span><span class=p>}</span> <span class=k>if</span> <span class=n>inclusive</span> <span class=k>else</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>src</span><span class=p>,</span> <span class=n>dst</span> <span class=ow>in</span> <span class=n>nx</span><span class=o>.</span><span class=n>bfs_edges</span><span class=p>(</span><span class=n>dag</span><span class=p>,</span> <span class=n>end</span><span class=p>,</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>dst</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>subset</span> <span class=ow>and</span> <span class=n>dst</span> <span class=ow>in</span> <span class=n>views</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>subset</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>nx</span><span class=o>.</span><span class=n>topological_sort</span><span class=p>(</span><span class=n>dag</span><span class=o>.</span><span class=n>subgraph</span><span class=p>(</span><span class=n>subset</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>order</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>nx</span><span class=o>.</span><span class=n>topological_sort</span><span class=p>(</span><span class=n>dag</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Visualize dependencies</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>viz</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>graphviz</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>dot</span> <span class=o>=</span> <span class=n>graphviz</span><span class=o>.</span><span class=n>Digraph</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>dag</span><span class=o>.</span><span class=n>nodes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>style</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>            <span class=c1># Source tables</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>node</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>views</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                <span class=n>style</span><span class=p>[</span><span class=s2>&#34;shape&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;box&#34;</span>
</span></span><span class=line><span class=cl>            <span class=c1># Views</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>views</span><span class=p>[</span><span class=n>node</span><span class=p>],</span> <span class=n>PythonView</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>style</span><span class=p>[</span><span class=s2>&#34;color&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;darkgoldenrod2&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=n>style</span><span class=p>[</span><span class=s2>&#34;fontcolor&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;dodgerblue4&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>node</span> <span class=ow>in</span> <span class=n>order</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>style</span><span class=p>[</span><span class=s2>&#34;style&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;filled&#34;</span>
</span></span><span class=line><span class=cl>                <span class=n>style</span><span class=p>[</span><span class=s2>&#34;fillcolor&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;lightgreen&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>dot</span><span class=o>.</span><span class=n>node</span><span class=p>(</span><span class=n>node</span><span class=p>,</span> <span class=o>**</span><span class=n>style</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Dependencies</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>dst</span> <span class=ow>in</span> <span class=n>dag</span><span class=o>.</span><span class=n>nodes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>src</span> <span class=ow>in</span> <span class=n>dag</span><span class=o>.</span><span class=n>predecessors</span><span class=p>(</span><span class=n>dst</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>dot</span><span class=o>.</span><span class=n>edge</span><span class=p>(</span><span class=n>src</span><span class=p>,</span> <span class=n>dst</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>dot</span><span class=o>.</span><span class=n>render</span><span class=p>(</span><span class=n>view</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>cleanup</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Run views</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>view_name</span> <span class=ow>in</span> <span class=n>order</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>view</span> <span class=o>:=</span> <span class=n>views</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>view_name</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>view</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34;</span><span class=se>\r</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>view</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\033</span><span class=s2>[92m&#34;</span> <span class=o>+</span> <span class=n>view</span><span class=o>.</span><span class=n>name</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\033</span><span class=s2>[0m&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>typer</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>)</span>
</span></span></code></pre></div></details><p><em>Thank you <a href=https://clementc.github.io/pages/about.html>ClÃ©ment Chastagnol</a> for proofreading and suggesting edits.</em></p></div><script type=text/javascript>var s=document.createElement("script");s.setAttribute("src","https://utteranc.es/client.js"),s.setAttribute("repo","MaxHalford/maxhalford.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",null),s.setAttribute("theme","github-light"),document.body.appendChild(s)</script><div style=display:flex;flex-direction:row;justify-content:center;align-items:center;gap:20px;margin-bottom:30px><div class=do-the-thing><div class=elevator><svg class="sweet-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" enable-background="new 0 0 100 100" height="100" width="100"><path d="M70 47.5H30c-1.4.0-2.5 1.1-2.5 2.5v40c0 1.4 1.1 2.5 2.5 2.5h40c1.4.0 2.5-1.1 2.5-2.5V50C72.5 48.6 71.4 47.5 70 47.5zm-22.5 40h-5v-25h5v25zm10 0h-5v-25h5v25zm10 0h-5V60c0-1.4-1.1-2.5-2.5-2.5H40c-1.4.0-2.5 1.1-2.5 2.5v27.5h-5v-35h35v35z"/><path d="M50 42.5c1.4.0 2.5-1.1 2.5-2.5V16l5.7 5.7c.5.5 1.1.7 1.8.7s1.3-.2 1.8-.7c1-1 1-2.6.0-3.5l-10-10c-1-1-2.6-1-3.5.0l-10 10c-1 1-1 2.6.0 3.5 1 1 2.6 1 3.5.0l5.7-5.7v24c0 1.4 1.1 2.5 2.5 2.5z"/></svg>
Back to the top</div></div><iframe src=https://github.com/sponsors/MaxHalford/button title="Sponsor MaxHalford" height=32 width=114 style=border:0;border-radius:6px></iframe></div><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script><script>var elementButton=document.querySelector(".elevator"),elevator=new Elevator({element:elementButton,mainAudio:"/music/elevator.mp3",endAudio:"/music/ding.mp3"})</script><style>.down-arrow{font-size:120px;margin-top:90px;margin-bottom:90px;text-shadow:0 -20px #0c1f31,0 0 #c33329;color:transparent;-webkit-transform:scaleY(.8);-moz-transform:scaleY(.8);transform:scaleY(.8)}.elevator{text-align:center;cursor:pointer;width:140px;margin:auto}.elevator:hover{opacity:.7}.elevator svg{width:40px;height:40px;display:block;margin:auto;margin-bottom:5px}</style><div class=related-content><h3 style=margin-top:10px!important;margin-bottom:10px!important>Related posts</h3><ul style=margin-top:0><li><a href=/blog/skyline-queries/>Skyline queries in Python</a></li><li><a href=/blog/sql-subquery-enumeration/>SQL subquery enumeration</a></li><li><a href=/blog/machine-learning-production/>A smooth approach to putting machine learning into production</a></li></ul></div></div></div></article></body></html>