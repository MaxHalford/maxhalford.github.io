<!doctype html><html lang=en><head><script defer src=https://unpkg.com/@tinybirdco/flock.js data-host=https://api.tinybird.co data-token=p.eyJ1IjogImMwMjJhMjg1LWJmY2YtNDc0OC1hYzczLTJhMDQ1Njk3NTI0YyIsICJpZCI6ICIzNjc3NjQ3Ny04MTE2LTRmYWQtYjcwMy1iZmM3YjMwZGJjMjMifQ.A0vHm-VWbXG6uBFZiwuspN_AyfSYNrdZE3IgwgWSt4g></script><meta charset=utf-8><meta name=generator content="Hugo 0.121.1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Max Halford"><meta property="og:url" content="https://maxhalford.github.io/blog/funnel-decomposition/"><link rel=canonical href=https://maxhalford.github.io/blog/funnel-decomposition/><meta property="og:title" content="Funnel decomposition"><meta property="og:description" content="Funnel metrics as products I talked about metric decomposition in a previous article, and how it can be used to explain why metrics change values over time. That article explained how to decompose a sum, as well as a ratio. In this article, I&rsquo;ll explain how to decompose a product.
revenue = impressions * click_rate * conversion_rate * spend The decomposition in this article isn&rsquo;t limited to funnels. It can be applied to any metric that is expressed as a product of factors."><meta property="og:type" content="article"><meta property="og:url" content="https://maxhalford.github.io/blog/funnel-decomposition/"><meta property="og:image" content="https://maxhalford.github.io/img/blog/funnel-decomposition/revenue-funnel.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-12-14T00:00:00+00:00"><meta property="article:modified_time" content="2023-12-14T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maxhalford.github.io/img/blog/funnel-decomposition/revenue-funnel.png"><meta name=twitter:title content="Funnel decomposition"><meta name=twitter:description content="Funnel metrics as products I talked about metric decomposition in a previous article, and how it can be used to explain why metrics change values over time. That article explained how to decompose a sum, as well as a ratio. In this article, I&rsquo;ll explain how to decompose a product.
revenue = impressions * click_rate * conversion_rate * spend The decomposition in this article isn&rsquo;t limited to funnels. It can be applied to any metric that is expressed as a product of factors."><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦”</text></svg>"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/maxhalford.github.io\/"},"articleSection":"blog","name":"Funnel decomposition","headline":"Funnel decomposition","description":"Funnel metrics as products I talked about metric decomposition in a previous article, and how it can be used to explain why metrics change values over time. That article explained how to decompose a sum, as well as a ratio. In this article, I\u0026rsquo;ll explain how to decompose a product.\nrevenue = impressions * click_rate * conversion_rate * spend The decomposition in this article isn\u0026rsquo;t limited to funnels. It can be applied to any metric that is expressed as a product of factors.","inLanguage":"en-US","author":"Max Halford","creator":"Max Halford","publisher":"Max Halford","accountablePerson":"Max Halford","copyrightHolder":"Max Halford","copyrightYear":"2023","datePublished":"2023-12-14 00:00:00 \u002b0000 UTC","dateModified":"2023-12-14 00:00:00 \u002b0000 UTC","url":"https:\/\/maxhalford.github.io\/blog\/funnel-decomposition\/","keywords":["data-science"]}</script><title>Funnel decomposition â€¢ Max Halford</title>
<meta property="og:title" content="Funnel decomposition â€¢ Max Halford"><meta property="og:type" content="article"><meta name=description content="Funnel metrics as products I talked about metric decomposition in a previous article, and how it can be used to explain why metrics change values over time. That article explained how to decompose a sum, as well as a ratio. In this article, I&rsquo;ll explain how to decompose a product.
revenue = impressions * click_rate * conversion_rate * spend The decomposition in this article isn&rsquo;t limited to funnels. It can be applied to any metric that is expressed as a product of factors."><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/github-markdown.min.css><link rel=stylesheet href=/css/highlight/github.css><link rel=stylesheet href=/css/index.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Permanent+Marker&display=swap" rel=stylesheet><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0,tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><article class=post id=article><div class="row center-xs" style=text-align:left><div class="col-xs-12 col-sm-10 col-md-7 col-lg-5"><div class=header><header class=header-parts><div class="signatures site-title"><a href=/>Max Halford ãƒ„</a></div><div class=header-links><a class=header-link href=/>Blog</a>
<a class=header-link href=/links/>Links</a>
<a class=header-link href=/bio/>Bio</a></div></header></div><header class=post-header><h1 class=post-title>Funnel decomposition</h1><div class="row post-desc"><div class="col-xs-12 post-desc-items"><time class=post-date datetime="2023-12-14 00:00:00 UTC">2023-12-14
</time><span class=posts-line-tag>data-science</span></div></div></header><div class="post-content markdown-body"><h2 id=toc>Table of contents</h2><nav id=TableOfContents><ul><li><a href=#funnel-metrics-as-products>Funnel metrics as products</a></li><li><a href=#the-intuition>The intuition</a></li><li><a href=#the-math>The math</a></li><li><a href=#python-code>Python code</a></li><li><a href=#towards-a-general-solution>Towards a general solution</a></li></ul></nav><h2 id=funnel-metrics-as-products>Funnel metrics as products</h2><p>I talked about metric decomposition in a <a href=/blog/kpi-evolution-decomposition>previous article</a>, and how it can be used to explain why metrics change values over time. That article explained how to decompose a sum, as well as a ratio. In this article, I&rsquo;ll explain how to decompose a product.</p><pre tabindex=0><code>revenue = impressions * click_rate * conversion_rate * spend
</code></pre><p>The decomposition in this article isn&rsquo;t limited to funnels. It can be applied to any metric that is expressed as a product of factors. For instance, at Carbonfact, we decompose the carbon footprint of a clothing line as so:</p><pre tabindex=0><code>footprint = products * kg_per_product * footprint_per_kg
</code></pre><p>This allows us to understand whether a clothing line&rsquo;s total footprint has increased &ndash; or decreased &ndash; because of an increase in the number of products, an increase in the weight of each product, or an increase in the footprint intensity of each product.</p><h2 id=the-intuition>The intuition</h2><p>Let&rsquo;s take a typical revenue funnel as an example. People come to a website, which are counted as impressions. They are presented with a <a href=https://www.wikiwand.com/en/Call_to_action_(marketing)>CTA</a>, which may or not result into a click. Each user may then subscribe to a service, or not. Each user will then spend some money through their subscription, which is often defined as their <a href=https://www.wikiwand.com/en/Customer_lifetime_value>LTV</a>. This funnel has 4 steps:</p><div align=center><figure><img style=box-shadow:none src=/img/blog/funnel-decomposition/revenue-funnel.png></figure></div><p>The revenue of this website can be expressed as a product of four factors:</p><pre tabindex=0><code>revenue = impressions * click_rate * subscription_rate * average_spend
</code></pre><p>Let&rsquo;s say the revenue changes between two time periods. We want to understand why. The overall change can be attributed to a change in any of the factors. For example, the revenue may have increased because of an increase in the number of impressions, or because of an increase in the subscription rate. Decomposing the change would allow us attribute part of the change to each of the funnel&rsquo;s steps.</p><p>Let&rsquo;s focus on the amount of clicks. The number of clicks can change between two periods for two reasons:</p><ol><li>The number of impressions changed.</li><li>The click rate evolved.</li></ol><p>Let&rsquo;s say both of these factors increased. This is illustrated in the following figure:</p><div align=center><figure style=width:50%><img style=box-shadow:none src=/img/blog/funnel-decomposition/clicks-left-right.png></figure></div><p>The increase in number of clicks can be decomposed as the sum of two terms:</p><ol><li>The increase in number of impressions, multiplied by the click rate:</li></ol><p>$$
(I&rsquo; - I) \times C
$$</p><ol start=2><li>The increase in click rate, multiplied by the new number of impressions:</li></ol><p>$$
I&rsquo; \times (C&rsquo; - C)
$$</p><p>The first term would be attributed to impressions evolutions, whilst the second would be attributed to the click rate change. Note that this is a purely geometric intepretation. An alternative slicing is shown in the following figure:</p><div align=center><figure style=width:50%><img style=box-shadow:none src=/img/blog/funnel-decomposition/clicks-right-left.png></figure></div><p>This is the <a href=/blog/kpi-evolution-decomposition/#leftright-vs-rightleft-decomposition>same story</a> as in the previous article. The take-away is that there are different ways to decompose a metric, and that all of them are valid. Each one gives slightly different results, but they all yield figures with the same order of magnitude.</p><p>In both cases, the decomposition provides the contribution of each factor to the evolution of the amount of clicks. What we want is the contribution to the evolution of the overall revenue. This can be obtained by multiplying each contribution by the other factors, namely the subscription rate $S$ and the average spend $A$. All in all, the decomposition of the revenue evolution is:</p><p>$$
\textcolor{royalblue}{(I&rsquo; - I) \times C \times S \times A} + \textcolor{indianred}{I&rsquo; \times (C&rsquo; - C) \times S \times A}
$$</p><p>One may ask why we would use the previous subscription rate and average spend, rather than the new values. The easy answer is that this wouldn&rsquo;t add up mathematically. The more intuitive answer is that the contribution of a factor&rsquo;s evolution should comprise the change of the attribute itself, as well as the change of the factors that precede it. Indeed, if the click rate increases, then its contribution should be compounded by the fact that there are more impressions.</p><h2 id=the-math>The math</h2><p>We&rsquo;ve established a funnel metric $m$ can be expressed a product of $k$ factors $f_i$:</p><p>$$
m = \prod_{i=1}^k f_i
$$</p><p>We&rsquo;re interested in explaining the evolution of the metric over time. The metric can be indexed with a timestamp $t$:</p><p>$$
m_t = \prod_{i=1}^k f_{i,t}
$$</p><p>The metric&rsquo;s evolution between two timestamps $t$ and $t&rsquo;$ &ndash; which doesn&rsquo;t necessarily have to be $t+1$ &ndash; can be expressed as:</p><p>$$
m_{t&rsquo;} - m_t = \prod_{i=1}^k f_{i,t&rsquo;} - \prod_{i=1}^k f_{i,t}
$$</p><p>This difference is a single number. We want to decompose it into a sum of factors. That is, we want to measure the contribution of each factor to the metric&rsquo;s evolution. Each factor&rsquo;s contribution should be proportional to said factor&rsquo;s evolution between $t$ and $t&rsquo;$.</p><p>Our goal is to understand the impact of this change on the overall metric change. Therefore, we want a factor&rsquo;s contribution to be expressed as a function of $f_{i,t&rsquo;} - f_{i,t}$. I haven&rsquo;t yet derived the formula here, but the final result is:</p><p>$$
m_{t&rsquo;} - m_t = \sum_{i=1}^k \left( \textcolor{royalblue}{\prod_{j=1}^{i-1} f_{j,t&rsquo;}} \times \textcolor{purple}{(f_{i,t&rsquo;} - f_{i,t})} \times \textcolor{indianred}{\prod_{j=i+1}^k f_{j,t}} \right)
$$</p><p>This is mathematical equivalent to the geometric explanation from above. The purple term is the factor&rsquo;s evolution. The blue term is the product of the factors that precede the factor of interest, evaluated at the new timestamp. The red term is the product of the factors that follow the factor of interest, evaluated at the old timestamp.</p><p>Note that an alternative decomposition is:</p><p>$$
m_{t&rsquo;} - m_t = \sum_{i=1}^k \left( \textcolor{royalblue}{\prod_{j=1}^{i-1} f_{j,t}} \times \textcolor{purple}{(f_{i,t&rsquo;} - f_{i,t})} \times \textcolor{indianred}{\prod_{j=i+1}^k f_{j,t&rsquo;}} \right)
$$</p><p>where we intervert the timestamps in the blue and red terms. This is the same as the previous decomposition, but with the timestamps swapped. There is no better formula. Both are valid, and simply differ in interpretation. The first decomposition compounds the change with the factors that precede the factor of interest, whilst the second compounds the change with the factors that follow.</p><h2 id=python-code>Python code</h2><p>Here&rsquo;s a toy dataset to illustrate:</p><details><summary>See code</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pandas</span> <span class=k>as</span> <span class=nn>pd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>df</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;date&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;2018-01-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2018-01-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2018-01-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2019-01-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2019-01-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2019-01-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2018-02-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2018-02-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2018-02-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2019-02-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2019-02-01&#39;</span><span class=p>,</span> <span class=s1>&#39;2019-02-01&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;group&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;B&#39;</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;B&#39;</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;B&#39;</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>,</span> <span class=s1>&#39;A&#39;</span><span class=p>,</span> <span class=s1>&#39;B&#39;</span><span class=p>,</span> <span class=s1>&#39;C&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;impressions&#39;</span><span class=p>:</span> <span class=p>[</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>2000</span><span class=p>,</span> <span class=mi>2500</span><span class=p>,</span> <span class=mi>1000</span><span class=p>,</span> <span class=mi>2150</span><span class=p>,</span> <span class=mi>2000</span><span class=p>,</span> <span class=mi>50</span><span class=p>,</span> <span class=mi>2000</span><span class=p>,</span> <span class=mi>2500</span><span class=p>,</span> <span class=mi>2500</span><span class=p>,</span> <span class=mi>2150</span><span class=p>,</span> <span class=mi>2000</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;clicks&#39;</span><span class=p>:</span> <span class=p>[</span><span class=mi>150</span><span class=p>,</span> <span class=mi>150</span><span class=p>,</span> <span class=mi>250</span><span class=p>,</span> <span class=mi>120</span><span class=p>,</span> <span class=mi>200</span><span class=p>,</span> <span class=mi>400</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>300</span><span class=p>,</span> <span class=mi>250</span><span class=p>,</span> <span class=mi>1000</span><span class=p>,</span> <span class=mi>323</span><span class=p>,</span> <span class=mi>320</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;conversions&#39;</span><span class=p>:</span> <span class=p>[</span><span class=mi>120</span><span class=p>,</span> <span class=mi>150</span><span class=p>,</span> <span class=mi>125</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>145</span><span class=p>,</span> <span class=mi>166</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>150</span><span class=p>,</span> <span class=mi>125</span><span class=p>,</span> <span class=mi>500</span><span class=p>,</span> <span class=mi>145</span><span class=p>,</span> <span class=mi>166</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;revenue&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;$8,600&#39;</span><span class=p>,</span> <span class=s1>&#39;$9,400&#39;</span><span class=p>,</span> <span class=s1>&#39;$10,750&#39;</span><span class=p>,</span> <span class=s1>&#39;$9,055&#39;</span><span class=p>,</span> <span class=s1>&#39;$8,739&#39;</span><span class=p>,</span> <span class=s1>&#39;$10,147&#39;</span><span class=p>,</span> <span class=s1>&#39;$500&#39;</span><span class=p>,</span> <span class=s1>&#39;$11,400&#39;</span><span class=p>,</span> <span class=s1>&#39;$8,750&#39;</span><span class=p>,</span> <span class=s1>&#39;$50,000&#39;</span><span class=p>,</span> <span class=s1>&#39;$10,739&#39;</span><span class=p>,</span> <span class=s1>&#39;$12,147&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>pd</span><span class=o>.</span><span class=n>to_datetime</span><span class=p>(</span><span class=n>df</span><span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>df</span><span class=p>[</span><span class=s1>&#39;revenue&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=s1>&#39;revenue&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>str</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;$&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>regex</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>str</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>regex</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>float</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>df</span>
</span></span></code></pre></div></details><table><thead><tr><th style=text-align:left>date</th><th style=text-align:left>group</th><th style=text-align:right>impressions</th><th style=text-align:right>clicks</th><th style=text-align:right>conversions</th><th style=text-align:right>revenue</th></tr></thead><tbody><tr><td style=text-align:left>2018-01-01</td><td style=text-align:left>A</td><td style=text-align:right>1000</td><td style=text-align:right>150</td><td style=text-align:right>120</td><td style=text-align:right>8600</td></tr><tr><td style=text-align:left>2018-01-01</td><td style=text-align:left>B</td><td style=text-align:right>2000</td><td style=text-align:right>150</td><td style=text-align:right>150</td><td style=text-align:right>9400</td></tr><tr><td style=text-align:left>2018-01-01</td><td style=text-align:left>C</td><td style=text-align:right>2500</td><td style=text-align:right>250</td><td style=text-align:right>125</td><td style=text-align:right>10750</td></tr><tr><td style=text-align:left>2019-01-01</td><td style=text-align:left>A</td><td style=text-align:right>1000</td><td style=text-align:right>120</td><td style=text-align:right>100</td><td style=text-align:right>9055</td></tr><tr><td style=text-align:left>2019-01-01</td><td style=text-align:left>B</td><td style=text-align:right>2150</td><td style=text-align:right>200</td><td style=text-align:right>145</td><td style=text-align:right>8739</td></tr><tr><td style=text-align:left>2019-01-01</td><td style=text-align:left>C</td><td style=text-align:right>2000</td><td style=text-align:right>400</td><td style=text-align:right>166</td><td style=text-align:right>10147</td></tr><tr><td style=text-align:left>2018-02-01</td><td style=text-align:left>A</td><td style=text-align:right>50</td><td style=text-align:right>20</td><td style=text-align:right>10</td><td style=text-align:right>500</td></tr><tr><td style=text-align:left>2018-02-01</td><td style=text-align:left>B</td><td style=text-align:right>2000</td><td style=text-align:right>300</td><td style=text-align:right>150</td><td style=text-align:right>11400</td></tr><tr><td style=text-align:left>2018-02-01</td><td style=text-align:left>C</td><td style=text-align:right>2500</td><td style=text-align:right>250</td><td style=text-align:right>125</td><td style=text-align:right>8750</td></tr><tr><td style=text-align:left>2019-02-01</td><td style=text-align:left>A</td><td style=text-align:right>2500</td><td style=text-align:right>1000</td><td style=text-align:right>500</td><td style=text-align:right>50000</td></tr><tr><td style=text-align:left>2019-02-01</td><td style=text-align:left>B</td><td style=text-align:right>2150</td><td style=text-align:right>323</td><td style=text-align:right>145</td><td style=text-align:right>10739</td></tr><tr><td style=text-align:left>2019-02-01</td><td style=text-align:left>C</td><td style=text-align:right>2000</td><td style=text-align:right>320</td><td style=text-align:right>166</td><td style=text-align:right>12147</td></tr></tbody></table><p>The overall change in revenue between 2018 and 2019 is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>df</span><span class=o>.</span><span class=n>assign</span><span class=p>(</span><span class=n>year</span><span class=o>=</span><span class=n>df</span><span class=o>.</span><span class=n>date</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>year</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;year&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>agg</span><span class=p>({</span><span class=s1>&#39;revenue&#39;</span><span class=p>:</span> <span class=s1>&#39;sum&#39;</span><span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>diff</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>dropna</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><pre tabindex=0><code>51427
</code></pre><p>That&rsquo;s the total amount we want to explain. The first step is to define the funnel&rsquo;s factors:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>funnel</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;impressions&#39;</span><span class=p>,</span> <span class=s1>&#39;clicks&#39;</span><span class=p>,</span> <span class=s1>&#39;conversions&#39;</span><span class=p>,</span> <span class=s1>&#39;revenue&#39;</span><span class=p>]</span>
</span></span></code></pre></div><p>This list can then be used to create additional ratio columns:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>ratio_names</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>num</span><span class=si>}</span><span class=s1>_over_</span><span class=si>{</span><span class=n>den</span><span class=si>}</span><span class=s1>&#39;</span> <span class=k>if</span> <span class=n>den</span> <span class=k>else</span> <span class=n>num</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>den</span><span class=p>,</span> <span class=n>num</span> <span class=ow>in</span> <span class=p>[(</span><span class=kc>None</span><span class=p>,</span> <span class=n>funnel</span><span class=p>[</span><span class=mi>0</span><span class=p>]),</span> <span class=o>*</span><span class=nb>zip</span><span class=p>(</span><span class=n>funnel</span><span class=p>,</span> <span class=n>funnel</span><span class=p>[</span><span class=mi>1</span><span class=p>:])]</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>ratio_names</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;impressions&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;clicks_over_impressions&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;conversions_over_clicks&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;revenue_over_conversions&#39;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>decomp</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>den</span><span class=p>,</span> <span class=n>num</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span><span class=n>ratio_names</span><span class=p>,</span> <span class=n>funnel</span><span class=p>,</span> <span class=n>funnel</span><span class=p>[</span><span class=mi>1</span><span class=p>:]):</span>
</span></span><span class=line><span class=cl>    <span class=n>decomp</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>df</span><span class=p>[</span><span class=n>num</span><span class=p>]</span> <span class=o>/</span> <span class=n>df</span><span class=p>[</span><span class=n>den</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>decomp</span>
</span></span></code></pre></div><table><thead><tr><th style=text-align:left>date</th><th style=text-align:right>impressions</th><th style=text-align:right>clicks_over_impressions</th><th style=text-align:right>conversions_over_clicks</th><th style=text-align:right>revenue_over_conversions</th></tr></thead><tbody><tr><td style=text-align:left>2018-01-01</td><td style=text-align:right>1000</td><td style=text-align:right>15%</td><td style=text-align:right>80%</td><td style=text-align:right>$72</td></tr><tr><td style=text-align:left>2018-01-01</td><td style=text-align:right>2000</td><td style=text-align:right>7.5%</td><td style=text-align:right>100%</td><td style=text-align:right>$63</td></tr><tr><td style=text-align:left>2018-01-01</td><td style=text-align:right>2500</td><td style=text-align:right>10%</td><td style=text-align:right>50%</td><td style=text-align:right>$86</td></tr><tr><td style=text-align:left>2019-01-01</td><td style=text-align:right>1000</td><td style=text-align:right>12%</td><td style=text-align:right>83%</td><td style=text-align:right>$57</td></tr><tr><td style=text-align:left>2019-01-01</td><td style=text-align:right>2150</td><td style=text-align:right>9%</td><td style=text-align:right>72.5%</td><td style=text-align:right>$60</td></tr><tr><td style=text-align:left>2019-01-01</td><td style=text-align:right>2000</td><td style=text-align:right>20%</td><td style=text-align:right>41.5%</td><td style=text-align:right>$61</td></tr><tr><td style=text-align:left>2018-02-01</td><td style=text-align:right>50</td><td style=text-align:right>40%</td><td style=text-align:right>50%</td><td style=text-align:right>$50</td></tr><tr><td style=text-align:left>2018-02-01</td><td style=text-align:right>2000</td><td style=text-align:right>15%</td><td style=text-align:right>50%</td><td style=text-align:right>$76</td></tr><tr><td style=text-align:left>2018-02-01</td><td style=text-align:right>2500</td><td style=text-align:right>10%</td><td style=text-align:right>50%</td><td style=text-align:right>$70</td></tr><tr><td style=text-align:left>2019-02-01</td><td style=text-align:right>2500</td><td style=text-align:right>40%</td><td style=text-align:right>50%</td><td style=text-align:right>$100</td></tr><tr><td style=text-align:left>2019-02-01</td><td style=text-align:right>2150</td><td style=text-align:right>15%</td><td style=text-align:right>45%</td><td style=text-align:right>$74</td></tr><tr><td style=text-align:left>2019-02-01</td><td style=text-align:right>2000</td><td style=text-align:right>16%</td><td style=text-align:right>52%</td><td style=text-align:right>73</td></tr></tbody></table><p>I&rsquo;ve formatted the columns for readability. In practice, you might have these columns directly available, and won&rsquo;t need to create them. The next step is to define the dimensions along which to decompose the evolution:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>dimensions</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;month&#39;</span><span class=p>,</span> <span class=s1>&#39;group&#39;</span><span class=p>]</span>
</span></span></code></pre></div><p>This then allows us to add additional columns that allow comparing the current ratios to the previous ones. This can be done with pandas&rsquo; <code>lag</code> method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>decomp</span><span class=p>[</span><span class=s1>&#39;month&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>decomp</span><span class=o>.</span><span class=n>date</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>month</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=n>ratio_names</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>decomp</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s1>_lag&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>decomp</span><span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=n>dimensions</span><span class=p>)[</span><span class=n>name</span><span class=p>]</span><span class=o>.</span><span class=n>shift</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span></code></pre></div><p>We can finally apply the decomposition formula one factor at a time:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>ratio_names</span><span class=p>):</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>before</span> <span class=o>=</span> <span class=n>ratio_names</span><span class=p>[:</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>current</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;(</span><span class=si>{</span><span class=n>ratio_names</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=si>}</span><span class=s1> - </span><span class=si>{</span><span class=n>ratio_names</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=si>}</span><span class=s1>_lag)&#39;</span>
</span></span><span class=line><span class=cl>    <span class=n>after</span> <span class=o>=</span> <span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>x</span><span class=si>}</span><span class=s1>_lag&#39;</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>ratio_names</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>:]]</span>
</span></span><span class=line><span class=cl>    <span class=n>formula</span> <span class=o>=</span> <span class=s1>&#39; * &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=nb>filter</span><span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=p>[</span><span class=o>*</span><span class=n>before</span><span class=p>,</span> <span class=n>current</span><span class=p>,</span> <span class=o>*</span><span class=n>after</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>decomp</span><span class=p>[</span><span class=sa>f</span><span class=s1>&#39;</span><span class=si>{</span><span class=n>ratio_names</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=si>}</span><span class=s1>_contribution&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>decomp</span><span class=o>.</span><span class=n>eval</span><span class=p>(</span><span class=n>formula</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>decomp</span>
</span></span></code></pre></div><table><thead><tr><th style=text-align:left>date</th><th style=text-align:left>group</th><th style=text-align:right>impressions_contribution</th><th style=text-align:right>clicks_over_impressions_contribution</th><th style=text-align:right>conversions_over_clicks_contribution</th><th style=text-align:right>revenue_over_conversions_contribution</th></tr></thead><tbody><tr><td style=text-align:left>2019-01-01</td><td style=text-align:left>A</td><td style=text-align:right>$0</td><td style=text-align:right>-$1720</td><td style=text-align:right>$286.667</td><td style=text-align:right>$1888.33</td></tr><tr><td style=text-align:left>2019-01-01</td><td style=text-align:left>B</td><td style=text-align:right>$705</td><td style=text-align:right>$2428.33</td><td style=text-align:right>-$3446.67</td><td style=text-align:right>-$347.667</td></tr><tr><td style=text-align:left>2019-01-01</td><td style=text-align:left>C</td><td style=text-align:right>-$2150</td><td style=text-align:right>$8600</td><td style=text-align:right>-$2924</td><td style=text-align:right>-$4129</td></tr><tr><td style=text-align:left>2019-02-01</td><td style=text-align:left>A</td><td style=text-align:right>$24500</td><td style=text-align:right>$0</td><td style=text-align:right>$0</td><td style=text-align:right>$25000</td></tr><tr><td style=text-align:left>2019-02-01</td><td style=text-align:left>B</td><td style=text-align:right>$855</td><td style=text-align:right>$19</td><td style=text-align:right>-$1254</td><td style=text-align:right>-$281</td></tr><tr><td style=text-align:left>2019-02-01</td><td style=text-align:left>C</td><td style=text-align:right>-$1750</td><td style=text-align:right>$4200</td><td style=text-align:right>$420</td><td style=text-align:right>$527</td></tr></tbody></table><p>We observe that the highest contributor to the revenue growth of Februrary 2019 is the increase in average spend. This makes sense, because the average spend increased by $25,000. Meanwhile, the number of conversions slightly decreased for group B in both January and February, each time resulting in a negative contribution to revenue. I think it&rsquo;s very powerful to be able to attribute a loss of revenue to a specific factor this way.</p><p>Note that the contribution columns can be summed up to verify the decomposition is valid:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>contribution_columns</span> <span class=o>=</span> <span class=p>[</span><span class=n>x</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>decomp</span><span class=o>.</span><span class=n>columns</span> <span class=k>if</span> <span class=n>x</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s1>&#39;_contribution&#39;</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>decomp</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>assign</span><span class=p>(</span><span class=n>year</span><span class=o>=</span><span class=n>x</span><span class=o>.</span><span class=n>date</span><span class=o>.</span><span class=n>dt</span><span class=o>.</span><span class=n>year</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;year&#39;</span><span class=p>)[</span><span class=n>contribution_columns</span><span class=p>]</span><span class=o>.</span><span class=n>sum</span><span class=p>()</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>axis</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><pre tabindex=0><code>51427
</code></pre><p>This is a good sanity check if you&rsquo;re going to implement this yourself.</p><h2 id=towards-a-general-solution>Towards a general solution</h2><p>Alas I don&rsquo;t have time to dive more into this. I&rsquo;ve just had a baby and don&rsquo;t have the leasure to write as I used to. I wanted to put this on paper while the topic was hot in my mind. I will come back to it later, and hopefully derive a more general solution that can be applied to any metric formula. Indeed, the previous article and this one cover sums, ratios, and products. I suspect there is a general decomposition framework that can be applied to any formula.</p></div><script type=text/javascript>var s=document.createElement("script");s.setAttribute("src","https://utteranc.es/client.js"),s.setAttribute("repo","MaxHalford/maxhalford.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",null),s.setAttribute("theme","github-light"),document.body.appendChild(s)</script><div style=display:flex;flex-direction:row;justify-content:center;align-items:center;gap:20px;margin-bottom:30px><div class=do-the-thing><div class=elevator><svg class="sweet-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" enable-background="new 0 0 100 100" height="100" width="100"><path d="M70 47.5H30c-1.4.0-2.5 1.1-2.5 2.5v40c0 1.4 1.1 2.5 2.5 2.5h40c1.4.0 2.5-1.1 2.5-2.5V50C72.5 48.6 71.4 47.5 70 47.5zm-22.5 40h-5v-25h5v25zm10 0h-5v-25h5v25zm10 0h-5V60c0-1.4-1.1-2.5-2.5-2.5H40c-1.4.0-2.5 1.1-2.5 2.5v27.5h-5v-35h35v35z"/><path d="M50 42.5c1.4.0 2.5-1.1 2.5-2.5V16l5.7 5.7c.5.5 1.1.7 1.8.7s1.3-.2 1.8-.7c1-1 1-2.6.0-3.5l-10-10c-1-1-2.6-1-3.5.0l-10 10c-1 1-1 2.6.0 3.5 1 1 2.6 1 3.5.0l5.7-5.7v24c0 1.4 1.1 2.5 2.5 2.5z"/></svg>Back to the top</div></div><iframe src=https://github.com/sponsors/MaxHalford/button title="Sponsor MaxHalford" height=32 width=114 style=border:0;border-radius:6px></iframe></div><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script><script>var elementButton=document.querySelector(".elevator"),elevator=new Elevator({element:elementButton,mainAudio:"/music/elevator.mp3",endAudio:"/music/ding.mp3"})</script><style>.down-arrow{font-size:120px;margin-top:90px;margin-bottom:90px;text-shadow:0 -20px #0c1f31,0 0 #c33329;color:transparent;-webkit-transform:scaleY(.8);-moz-transform:scaleY(.8);transform:scaleY(.8)}.elevator{text-align:center;cursor:pointer;width:140px;margin:auto}.elevator:hover{opacity:.7}.elevator svg{width:40px;height:40px;display:block;margin:auto;margin-bottom:5px}</style><div class=related-content><h3 style=margin-top:10px!important;margin-bottom:10px!important>Related posts</h3><ul style=margin-top:0><li><a href=/blog/consistent-metrics/>Metric correctness doesn't matter, consistency does</a></li><li><a href="https://www.youtube.com/watch?v=vQGdzKkyPP0">Predire la disponibilitÃ© des Velib' @ Toulouse Data Science Meetup</a></li><li><a href=/blog/graph-components-duckdb/>Graph components with DuckDB</a></li></ul></div></div></div></article></body></html>