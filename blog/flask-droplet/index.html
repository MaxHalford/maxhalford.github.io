<!doctype html><html lang=en><head><script defer src=https://unpkg.com/@tinybirdco/flock.js data-host=https://api.tinybird.co data-token=p.eyJ1IjogImMwMjJhMjg1LWJmY2YtNDc0OC1hYzczLTJhMDQ1Njk3NTI0YyIsICJpZCI6ICIzNjc3NjQ3Ny04MTE2LTRmYWQtYjcwMy1iZmM3YjMwZGJjMjMifQ.A0vHm-VWbXG6uBFZiwuspN_AyfSYNrdZE3IgwgWSt4g></script><meta charset=utf-8><meta name=generator content="Hugo 0.123.8"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Max Halford"><meta property="og:url" content="https://maxhalford.github.io/blog/flask-droplet/"><link rel=canonical href=https://maxhalford.github.io/blog/flask-droplet/><meta property="og:title" content="Setting up a droplet to host a Flask app"><meta property="og:description" content="After having worked for some weeks on the OpenBikes website, it was time to put it online. Digital Ocean seemed to provide a good service and so I decided to give it a spin. Their documentation is quite good but it doesn&rsquo;t cover exactly everything for setting up Flask. In this post I simply want to record every single step I took.
OpenBikes is a project with a Flask backend and a few upstart jobs."><meta property="og:type" content="article"><meta property="og:url" content="https://maxhalford.github.io/blog/flask-droplet/"><meta property="og:image" content="https://maxhalford.github.io/img/belle-ile.jpg"><meta property="article:section" content="blog"><meta property="article:published_time" content="2015-07-14T00:00:00+00:00"><meta property="article:modified_time" content="2015-07-14T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maxhalford.github.io/img/belle-ile.jpg"><meta name=twitter:title content="Setting up a droplet to host a Flask app"><meta name=twitter:description content="After having worked for some weeks on the OpenBikes website, it was time to put it online. Digital Ocean seemed to provide a good service and so I decided to give it a spin. Their documentation is quite good but it doesn&rsquo;t cover exactly everything for setting up Flask. In this post I simply want to record every single step I took.
OpenBikes is a project with a Flask backend and a few upstart jobs."><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦†</text></svg>"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/maxhalford.github.io\/"},"articleSection":"blog","name":"Setting up a droplet to host a Flask app","headline":"Setting up a droplet to host a Flask app","description":"After having worked for some weeks on the OpenBikes website, it was time to put it online. Digital Ocean seemed to provide a good service and so I decided to give it a spin. Their documentation is quite good but it doesn\u0026rsquo;t cover exactly everything for setting up Flask. In this post I simply want to record every single step I took.\nOpenBikes is a project with a Flask backend and a few upstart jobs.","inLanguage":"en-US","author":"Max Halford","creator":"Max Halford","publisher":"Max Halford","accountablePerson":"Max Halford","copyrightHolder":"Max Halford","copyrightYear":"2015","datePublished":"2015-07-14 00:00:00 \u002b0000 UTC","dateModified":"2015-07-14 00:00:00 \u002b0000 UTC","url":"https:\/\/maxhalford.github.io\/blog\/flask-droplet\/","keywords":["web-dev"]}</script><title>Setting up a droplet to host a Flask app â€¢ Max Halford</title>
<meta property="og:title" content="Setting up a droplet to host a Flask app â€¢ Max Halford"><meta property="og:type" content="article"><meta name=description content="After having worked for some weeks on the OpenBikes website, it was time to put it online. Digital Ocean seemed to provide a good service and so I decided to give it a spin. Their documentation is quite good but it doesn&rsquo;t cover exactly everything for setting up Flask. In this post I simply want to record every single step I took.
OpenBikes is a project with a Flask backend and a few upstart jobs."><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/github-markdown.min.css><link rel=stylesheet href=/css/highlight/github.css><link rel=stylesheet href=/css/index.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Permanent+Marker&display=swap" rel=stylesheet><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0,tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><article class=post id=article><div class="row center-xs" style=text-align:left><div class="col-xs-12 col-sm-10 col-md-7 col-lg-5"><div class=header><header class=header-parts><div class="signatures site-title"><a href=/>Max Halford ðŸ¦†</a></div><div class=header-links><a class=header-link href=/>Blog</a>
<a class=header-link href=/links/>Links</a>
<a class=header-link href=/bio/>Bio</a></div></header></div><header class=post-header><h1 class=post-title>Setting up a droplet to host a Flask app</h1><div class="row post-desc"><div class="col-xs-12 post-desc-items"><time class=post-date datetime="2015-07-14 00:00:00 UTC">2015-07-14
</time><span class=posts-line-tag>web-dev</span></div></div></header><div class="post-content markdown-body"><p>After having worked for some weeks on the <a href=http://openbikes.co>OpenBikes website</a>, it was time to put it online. <a href=https://www.digitalocean.com/>Digital Ocean</a> seemed to provide a good service and so I decided to give it a spin. Their documentation is quite good but it doesn&rsquo;t cover exactly everything for setting up Flask. In this post I simply want to record every single step I took.</p><p>OpenBikes is a project with a Flask backend and a few upstart jobs. It lives at the <a href=http://openbikes.co>openbikes.co</a> domain name. In this blog post I will list every step it takes to make it happen on Ubuntu 14.04 with Apache (it&rsquo;s robust and easy to setup). I didn&rsquo;t always say when to use <code>sudo</code> before the commands to avoid clutter, however you can safely use it everywhere.</p><h2 id=create-and-connect-to-a-droplet>Create and connect to a droplet</h2><p>Digital Ocean call their virtual machines (VMs) <em>droplets</em>. The first step is to log on to their website, create an account and register a bank card. There are many droplet capacity/power offers, personally I began with the 10 dollars per month deal. Once you&rsquo;ve created the droplet you will receive a mail with the IP adress of the droplet and the password.</p><ul><li>Open a terminal.</li><li>Connect to the droplet : <code>ssh root@&lt;IP adress></code></li><li>Copy/paste the password sent by mail.</li><li>Choose a new very very very secure password</li></ul><h2 id=add-some-security>Add some security</h2><p>Here are some basic security settings. You will want to install <em>fail2ban</em> to blacklist frequent attacks from bots and forbid them from trying to connect with the root user. Like this not only do they have to discover a password, they also have to guess what other users exist on the droplet.</p><ul><li><code>apt-get install fail2ban</code></li><li><code>sudo nano /etc/ssh/sshd_config</code></li><li>At <code>PermitRootLogin</code> replace <code>yes</code> by <code>no</code></li></ul><h2 id=some-more-optional-settings>Some more optional settings</h2><p>It&rsquo;s a good practice to use another user account with non-permanent <code>sudo</code> rights. You will also want to set the server&rsquo;s timezone and update it&rsquo;s packages for further installations.</p><ul><li>Create a new user : <code>adduser max</code></li><li>Allow it to use sudo : <code>adduser max sudo</code></li><li>Switch users : <code>su - max</code></li><li>Set timezone : <code>dpkg-reconfigure tzdata</code></li><li>Update packages : <code>sudo apt-get update</code></li></ul><p>Finally adding a swapfile equal to around twice the system&rsquo;s RAM is a good idea to avoid overloading.</p><ul><li><code>fallocate -l 4G /swapfile</code></li><li><code>chmod 600 /swapfile</code></li><li><code>mkswap /swapfile</code></li><li><code>swapon /swapfile</code></li><li><code>sh -c 'echo "/swapfile none swap sw 0 0" >> /etc/fstab'</code></li></ul><h2 id=prepare-the-website>Prepare the website</h2><ul><li>Install Apache: <code>apt-get install apache2</code></li><li>Navigate to the newly create folder: <code>cd /var/www/</code></li></ul><p>I&rsquo;m going to suppose you have all your code on GitHub (if you don&rsquo;t know what this is then you better do some googling).</p><ul><li>Install git: <code>apt-get install git</code></li><li>Clone the repository: <code>git clone https://github.com/MaxHalford/OpenBikes</code></li><li>Make all the files usable by everyone <code>sudo chmod 755 /var/www/OpenBikes -R</code></li></ul><p>The droplet has Python 3 installed. As this droplet will only host this website there is no point in using a virtual environment, we can directly install the dependencies with the native Python.</p><ul><li>pip is the best for installing Python modules: <code>apt-get install python3-pip</code></li><li>Install all the modules you should have listed: <code>pip3 install -r OpenBikes/setup/requirements.txt</code></li></ul><h2 id=creating-an-upstart-job>Creating an upstart job</h2><p>OpenBikes uses a never ending script to collect it&rsquo;s data. The modern way to make this run in the background and start when the server reboots is with an upstart script.</p><ul><li>Create the upstart script: <code>nano /etc/init/ob-collect.conf</code></li><li>Copy paste the following</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>start on runlevel <span class=o>[</span>2345<span class=o>]</span>
</span></span><span class=line><span class=cl>stop on runlevel <span class=o>[</span>016<span class=o>]</span>
</span></span><span class=line><span class=cl>respawn
</span></span><span class=line><span class=cl>chdir /var/www/OpenBikes/
</span></span><span class=line><span class=cl><span class=nb>exec</span> python3 collect.py
</span></span></code></pre></div><ul><li>Start the upstart script: <code>start ob-collect</code></li></ul><h2 id=launch-the-website>Launch the website</h2><p>A Flask app always has a main script to run the website in the localhost. The only you need to add to the repository is a file ending in <code>.wsgi</code>, for example <code>openbikes.wsgi</code>, and add the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span><span class=o>,</span> <span class=nn>os</span><span class=o>,</span> <span class=nn>logging</span>
</span></span><span class=line><span class=cl><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>stream</span><span class=o>=</span><span class=n>sys</span><span class=o>.</span><span class=n>stderr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sys</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>insert</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;/var/www/OpenBikes&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>chdir</span><span class=p>(</span><span class=s1>&#39;/var/www/OpenBikes&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>serve</span> <span class=kn>import</span> <span class=n>app</span>
</span></span><span class=line><span class=cl><span class=n>application</span> <span class=o>=</span> <span class=n>app</span>
</span></span></code></pre></div><p>Now we have to tell Apache where to point visitors who type <code>openbikes.co</code> in their browser.</p><ul><li><code>nano /etc/apache2/sites-available/OpenBikes.conf</code></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>&lt;VirtualHost *:80&gt;
</span></span><span class=line><span class=cl>	ServerName openbikes.co
</span></span><span class=line><span class=cl>	ServerAdmin maxhalford25@gmail.com
</span></span><span class=line><span class=cl>	WSGIScriptAlias / /var/www/OpenBikes/openbikes.wsgi
</span></span><span class=line><span class=cl>	&lt;Directory /var/www/OpenBikes/&gt;
</span></span><span class=line><span class=cl>		Order allow,deny
</span></span><span class=line><span class=cl>		Allow from all
</span></span><span class=line><span class=cl>	&lt;/Directory&gt;
</span></span><span class=line><span class=cl>	Alias /static /var/www/OpenBikes/static
</span></span><span class=line><span class=cl>	&lt;Directory /var/www/OpenBikes/static/&gt;
</span></span><span class=line><span class=cl>		Order allow,deny
</span></span><span class=line><span class=cl>		Allow from all
</span></span><span class=line><span class=cl>	&lt;/Directory&gt;
</span></span><span class=line><span class=cl>	ErrorLog <span class=si>${</span><span class=nv>APACHE_LOG_DIR</span><span class=si>}</span>/openbikes-error.log
</span></span><span class=line><span class=cl>	LogLevel warn
</span></span><span class=line><span class=cl>	CustomLog <span class=si>${</span><span class=nv>APACHE_LOG_DIR</span><span class=si>}</span>/openbikes-access.log combined
</span></span><span class=line><span class=cl>&lt;/VirtualHost&gt;
</span></span></code></pre></div><p>Next we have to add the possibility to Apache to serve websites with wsgi.</p><ul><li><code>apt-get install apache2-dev</code></li><li><code>pip3 install mod_wsgi</code></li><li><code>/usr/local/bin/mod_wsgi-express install-module</code></li><li><code>nano /etc/apache2/mods-available/wsgi_express.load</code></li><li>Copy/paste <code>LoadModule wsgi_module /usr/lib/apache2/modules/mod_wsgi-py34.cpython-34m.so</code></li><li><code>nano /etc/apache2/mods-available/wsgi_express.conf</code></li><li>Copy/paste <code>WSGIPythonHome /usr</code></li><li><code>a2enmod wsgi_express</code></li><li><code>a2ensite OpenBikes</code></li><li><code>service apache2 restart</code></li></ul><p>Finally we have to set the DNS record of the server so that everything works and point the openbikes.co website to Digital Ocean.</p><ul><li>Add the site in the DNS section of Digital Ocean</li></ul><p><img src=http://i.imgur.com/OTroktF.png alt="DNS setup"></p><ul><li>Add the Digital Ocean server records to your host provider (in this case <a href="https://www.godaddy.com/?countryview=1">GoDaddy</a>)<ul><li>NS1.DIGITALOCEAN.COM</li><li>NS2.DIGITALOCEAN.COM</li><li>NS3.DIGITALOCEAN.COM</li></ul></li></ul><p><img src=http://i.imgur.com/CE0IzrP.png alt=GoDaddy></p><p>And voilÃ , you should be done.</p><h2 id=remarks>Remarks</h2><ul><li>To update the website from GitHub use <code>git pull origin master</code></li><li>If you update your website you will have to restart Apache with <code>service apache2 restart</code></li><li>Some configurations might require a server reboot with <code>shutdown -r now</code></li><li>If you get errors when connecting to the website&rsquo;s URL check the error log with <code>cat /var/log/apache2/error.log</code></li><li>To reinstall Apache is case something is broken:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>sudo apt-get remove apache2
</span></span><span class=line><span class=cl>sudo apt-get purge apache2
</span></span><span class=line><span class=cl>sudo apt-get autoremove
</span></span><span class=line><span class=cl>sudo apt-get -y install apache2
</span></span></code></pre></div><h2 id=post-scriptum>Post-scriptum</h2><p>I voluntarily decided not to fully detail every step. If there is a point you are having a hard time with please put it in the comments so that I can elaborate on it and update this post. The script for deploying OpenBikes is available <a href=https://github.com/OpenBikes/Website/blob/master/setup/setup.sh>here</a>.</p></div><script type=text/javascript>var s=document.createElement("script");s.setAttribute("src","https://utteranc.es/client.js"),s.setAttribute("repo","MaxHalford/maxhalford.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",null),s.setAttribute("theme","github-light"),document.body.appendChild(s)</script><div style=display:flex;flex-direction:row;justify-content:center;align-items:center;gap:20px;margin-bottom:30px><div class=do-the-thing><div class=elevator><svg class="sweet-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" enable-background="new 0 0 100 100" height="100" width="100"><path d="M70 47.5H30c-1.4.0-2.5 1.1-2.5 2.5v40c0 1.4 1.1 2.5 2.5 2.5h40c1.4.0 2.5-1.1 2.5-2.5V50C72.5 48.6 71.4 47.5 70 47.5zm-22.5 40h-5v-25h5v25zm10 0h-5v-25h5v25zm10 0h-5V60c0-1.4-1.1-2.5-2.5-2.5H40c-1.4.0-2.5 1.1-2.5 2.5v27.5h-5v-35h35v35z"/><path d="M50 42.5c1.4.0 2.5-1.1 2.5-2.5V16l5.7 5.7c.5.5 1.1.7 1.8.7s1.3-.2 1.8-.7c1-1 1-2.6.0-3.5l-10-10c-1-1-2.6-1-3.5.0l-10 10c-1 1-1 2.6.0 3.5 1 1 2.6 1 3.5.0l5.7-5.7v24c0 1.4 1.1 2.5 2.5 2.5z"/></svg>
Back to the top</div></div><iframe src=https://github.com/sponsors/MaxHalford/button title="Sponsor MaxHalford" height=32 width=114 style=border:0;border-radius:6px></iframe></div><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script><script>var elementButton=document.querySelector(".elevator"),elevator=new Elevator({element:elementButton,mainAudio:"/music/elevator.mp3",endAudio:"/music/ding.mp3"})</script><style>.down-arrow{font-size:120px;margin-top:90px;margin-bottom:90px;text-shadow:0 -20px #0c1f31,0 0 #c33329;color:transparent;-webkit-transform:scaleY(.8);-moz-transform:scaleY(.8);transform:scaleY(.8)}.elevator{text-align:center;cursor:pointer;width:140px;margin:auto}.elevator:hover{opacity:.7}.elevator svg{width:40px;height:40px;display:block;margin:auto;margin-bottom:5px}</style></div></div></article></body></html>