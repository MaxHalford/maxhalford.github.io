<!doctype html><html lang=en><head><script defer src=https://unpkg.com/@tinybirdco/flock.js data-host=https://api.tinybird.co data-token=p.eyJ1IjogImMwMjJhMjg1LWJmY2YtNDc0OC1hYzczLTJhMDQ1Njk3NTI0YyIsICJpZCI6ICIzNjc3NjQ3Ny04MTE2LTRmYWQtYjcwMy1iZmM3YjMwZGJjMjMifQ.A0vHm-VWbXG6uBFZiwuspN_AyfSYNrdZE3IgwgWSt4g></script><meta charset=utf-8><meta name=generator content="Hugo 0.123.8"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Max Halford"><meta property="og:url" content="https://maxhalford.github.io/blog/carbonfact-nlp-open-problem/"><link rel=canonical href=https://maxhalford.github.io/blog/carbonfact-nlp-open-problem/><meta property="og:title" content="NLP at Carbonfact: how would you do it?"><meta property="og:description" content="The task I work at a company called Carbonfact. Our core value proposal is computing the carbon footprint of clothing items, expressed in carbon dioxide equivalent &ndash; $kgCO_2e$ in short. For instance, we started by measuring the footprint of shoes &ndash; no pun intended. We do these measurements with life cycle analysis (LCA) software we built ourselves. We use these analyses to fuel higher-level tasks for our clients, such as carbon accounting and sustainable procurement."><meta property="og:type" content="article"><meta property="og:url" content="https://maxhalford.github.io/blog/carbonfact-nlp-open-problem/"><meta property="og:image" content="https://maxhalford.github.io/img/belle-ile.jpg"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-09-06T00:00:00+00:00"><meta property="article:modified_time" content="2022-09-06T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maxhalford.github.io/img/belle-ile.jpg"><meta name=twitter:title content="NLP at Carbonfact: how would you do it?"><meta name=twitter:description content="The task I work at a company called Carbonfact. Our core value proposal is computing the carbon footprint of clothing items, expressed in carbon dioxide equivalent &ndash; $kgCO_2e$ in short. For instance, we started by measuring the footprint of shoes &ndash; no pun intended. We do these measurements with life cycle analysis (LCA) software we built ourselves. We use these analyses to fuel higher-level tasks for our clients, such as carbon accounting and sustainable procurement."><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦†</text></svg>"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/maxhalford.github.io\/"},"articleSection":"blog","name":"NLP at Carbonfact: how would you do it?","headline":"NLP at Carbonfact: how would you do it?","description":"The task I work at a company called Carbonfact. Our core value proposal is computing the carbon footprint of clothing items, expressed in carbon dioxide equivalent \u0026ndash; $kgCO_2e$ in short. For instance, we started by measuring the footprint of shoes \u0026ndash; no pun intended. We do these measurements with life cycle analysis (LCA) software we built ourselves. We use these analyses to fuel higher-level tasks for our clients, such as carbon accounting and sustainable procurement.","inLanguage":"en-US","author":"Max Halford","creator":"Max Halford","publisher":"Max Halford","accountablePerson":"Max Halford","copyrightHolder":"Max Halford","copyrightYear":"2022","datePublished":"2022-09-06 00:00:00 \u002b0000 UTC","dateModified":"2022-09-06 00:00:00 \u002b0000 UTC","url":"https:\/\/maxhalford.github.io\/blog\/carbonfact-nlp-open-problem\/","keywords":["text-processing"]}</script><title>NLP at Carbonfact: how would you do it? â€¢ Max Halford</title>
<meta property="og:title" content="NLP at Carbonfact: how would you do it? â€¢ Max Halford"><meta property="og:type" content="article"><meta name=description content="The task I work at a company called Carbonfact. Our core value proposal is computing the carbon footprint of clothing items, expressed in carbon dioxide equivalent &ndash; $kgCO_2e$ in short. For instance, we started by measuring the footprint of shoes &ndash; no pun intended. We do these measurements with life cycle analysis (LCA) software we built ourselves. We use these analyses to fuel higher-level tasks for our clients, such as carbon accounting and sustainable procurement."><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/github-markdown.min.css><link rel=stylesheet href=/css/highlight/github.css><link rel=stylesheet href=/css/index.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Permanent+Marker&display=swap" rel=stylesheet><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0,tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><article class=post id=article><div class="row center-xs" style=text-align:left><div class="col-xs-12 col-sm-10 col-md-7 col-lg-5"><div class=header><header class=header-parts><div class="signatures site-title"><a href=/>Max Halford ðŸ¦†</a></div><div class=header-links><a class=header-link href=/>Blog</a>
<a class=header-link href=/links/>Links</a>
<a class=header-link href=/bio/>Bio</a></div></header></div><header class=post-header><h1 class=post-title>NLP at Carbonfact: how would you do it?</h1><div class="row post-desc"><div class="col-xs-12 post-desc-items"><time class=post-date datetime="2022-09-06 00:00:00 UTC">2022-09-06
</time><span class=posts-line-tag>text-processing</span></div></div></header><div class="post-content markdown-body"><h2 id=toc>Table of contents</h2><nav id=TableOfContents><ul><li><a href=#the-task>The task</a></li><li><a href=#the-data>The data</a></li><li><a href=#a-tedious-working-solution>A (tedious) working solution</a></li><li><a href=#room-for-improvement>Room for improvement</a></li></ul></nav><h2 id=the-task>The task</h2><p>I work at a company called <a href=https://www.carbonfact.com/>Carbonfact</a>. Our core value proposal is computing the <a href=https://www.wikiwand.com/en/Carbon_footprint>carbon footprint</a> of clothing items, expressed in <a href=https://www.wikiwand.com/en/Carbon_Dioxide_Equivalent>carbon dioxide equivalent</a> &ndash; $kgCO_2e$ in short. For instance, we started by measuring the footprint of shoes &ndash; no pun intended. We do these measurements with <a href=https://www.wikiwand.com/en/Life-cycle_assessment>life cycle analysis (LCA)</a> software we built ourselves. We use these analyses to fuel higher-level tasks for our clients, such as <a href=https://www.wikiwand.com/en/Carbon_accounting>carbon accounting</a> and <a href=https://www.wikiwand.com/en/Sustainable_procurement>sustainable procurement</a>.</p><p>A life cycle analysis is essentially a recipe, the output of which is a carbon footprint assessment. Like any recipe, an LCA necessitates ingredients. In a <a href=https://www.wikiwand.com/en/Life-cycle_assessment#/Cradle-to-gate>cradle-to-gate</a> scenario, this includes everything that is needed to make the product: the materials, the mass, the manufacturing methods, the transport between factories, etc. In our experience, the biggest impact on a product&rsquo;s footprint come from the materials which it is made of.</p><p>Part of my job at Carbonfact involves massaging whatever data our clients can provide us with. My goal is to normalize their data so that it adheres to our internal product data model &ndash; i.e. the ingredients. Alas, this process is difficult to automate, because all of our clients store their data in different ways. Some have a big Google Sheet, some have one Excel file per product, some provide us with a BigQuery table, etc. It gets worse: clients have differing naming conventions for materials, or they might have different expectations as to what components make up a product, etc.</p><p>We&rsquo;ve come to accept that we have to write bespoke data normalization logic for each one of our clients. This initial resource investment is unavoidable. The upside is that we can perform LCA consistently once a client&rsquo;s data has been normalized.</p><p>I&rsquo;m constantly thinking of ways for scaling this process. Indeed, building a bespoke parser for a new catalog of products is a tedious task. It also takes time: I recently spent three days on a catalog of roughly 5000 products. There&rsquo;s definitely opportunities to improve this process with machine learning, which is why I&rsquo;m writing this blog post. I&rsquo;d like to zoom in on a specific task I had to perform, present my existing solution that is not ML based, and do a light retrospective. I&rsquo;m also going to share some labeled data, which I hope will encourage people to suggest their solution.</p><p>In this article, I want to focus on an NLP task I recently performed. I had to take human inputs that follow a rough template, and parse them into a structured schema. Here are a few input samples:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>top body: 100% polyester lace: 88% nylon 12% spandex, string: 88% nylon 12% spandex
</span></span><span class=line><span class=cl>92% polyester, 8% spandex
</span></span><span class=line><span class=cl>95% rayon 5% spandex
</span></span><span class=line><span class=cl>lace 87% nylon 13% spandex; mesh: 95% nylon 5% spandex
</span></span><span class=line><span class=cl>body &amp; panty: 85% nylon 15% spandex
</span></span><span class=line><span class=cl>86%polyamide,14%elastane
</span></span></code></pre></div><p>And here&rsquo;s the expected output for the following input string:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>lace 87% nylon 13% spandex; mesh: 95% nylon 5% spandex
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;lace&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;nylon&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>87.0</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>13.0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;mesh&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;nylon&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>95.0</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;material&#34;</span><span class=p>:</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;proportion&#34;</span><span class=p>:</span> <span class=mf>5.0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Here, <code>lace</code> and <code>mesh</code> are component names. Indeed, clothing items are made of several components. For the sake of normalization, we usually enforce each product to have a set list of components, but for the purpose of this task we&rsquo;ll ignore that aspect. Note that I made a short list of the material names that can be encountered, which you can find <a href=/files/datasets/nlp-carbonfact/materials.txt>here</a>.</p><h2 id=the-data>The data</h2><p>There are 600 (input, output) pairs, all of which can be found in these two datasets:</p><div><a href=/files/datasets/nlp-carbonfact/inputs.txt><b>inputs.txt</b></a></div><div><a href=/files/datasets/nlp-carbonfact/outputs.json><b>outputs.json</b></a></div><h2 id=a-tedious-working-solution>A (tedious) working solution</h2><p>When faced with this kind of task, it&rsquo;s difficult to decide between:</p><ol><li>Spending time working on a generic machine learning based solution.</li><li>Spending less time writing a scrappy rule-based solution.</li></ol><p>I opted with the latter for the sake of saving time in the short-term. The solution I wrote is not generic, as it is only guaranteed to work for the dataset linked above. Also, if our client adds more data to their catalog, it&rsquo;s likely that I&rsquo;ll have to dive back into the code to handle new cases. However, this option is risk-free, and has the merit of being easy to debug. Here is the Python code:</p><details><summary>Click to see the code</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pathlib</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>regex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>normalize_composition_format</span><span class=p>(</span><span class=n>text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; normalize_composition_format(&#39;(body) 82% nylon 18</span><span class=si>% s</span><span class=s2>pandex (forro)100% polyester&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>    &#39;body: 82% nylon 18</span><span class=si>% s</span><span class=s2>pandex forro: 100% polyester&#39;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; normalize_composition_format(&#39;fabric - 80% polyamide 20</span><span class=si>% e</span><span class=s2>lastane/lining - 100% polyester&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>    &#39;fabric: 80% polyamide 20</span><span class=si>% e</span><span class=s2>lastane lining: 100% polyester&#39;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>text</span> <span class=o>==</span> <span class=s2>&#34;100% polyester woven (pant) and 95% viscose  5</span><span class=si>%s</span><span class=s2>pandex knitted top&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s2>&#34;pants: 100% polyester knitted_top 95% viscose 5</span><span class=si>%s</span><span class=s2>pandex&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>r</span><span class=s2>&#34;\((?P&lt;component&gt;\w+)\)&#34;</span><span class=p>,</span> <span class=k>lambda</span> <span class=n>m</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>m</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=s1>&#39;component&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>: &#34;</span><span class=p>,</span> <span class=n>text</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;(?P&lt;component&gt;\w+)\ -&#34;</span><span class=p>,</span> <span class=k>lambda</span> <span class=n>m</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>m</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=s1>&#39;component&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>: &#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34; %&#34;</span><span class=p>,</span> <span class=s2>&#34;%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;ï¼š&#34;</span><span class=p>,</span> <span class=s2>&#34;: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;fabric \d:&#34;</span><span class=p>,</span> <span class=s2>&#34;fabric:&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;(\d+\.?\d*)%&#34;</span><span class=p>,</span> <span class=sa>r</span><span class=s2>&#34; \1%&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;top body&#34;</span><span class=p>,</span> <span class=s2>&#34;top_body&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;op body&#34;</span><span class=p>,</span> <span class=s2>&#34;top_body&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;body &amp; panty&#34;</span><span class=p>,</span> <span class=s2>&#34;body_panty&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;edge lace&#34;</span><span class=p>,</span> <span class=s2>&#34;edge_lace&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;edg lace&#34;</span><span class=p>,</span> <span class=s2>&#34;edge_lace&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;cup shell&#34;</span><span class=p>,</span> <span class=s2>&#34;cup_shell&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;centre front and wings&#34;</span><span class=p>,</span> <span class=s2>&#34;centre_front_and_wings&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;cup lining&#34;</span><span class=p>,</span> <span class=s2>&#34;cup_lining&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;front panel&#34;</span><span class=p>,</span> <span class=s2>&#34;front_panel&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;back panel&#34;</span><span class=p>,</span> <span class=s2>&#34;back_panel&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;marl fabric&#34;</span><span class=p>,</span> <span class=s2>&#34;marl_fabric&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;knited top&#34;</span><span class=p>,</span> <span class=s2>&#34;knitted_top&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;striped mesh&#34;</span><span class=p>,</span> <span class=s2>&#34;striped_mesh&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;trim lace&#34;</span><span class=p>,</span> <span class=s2>&#34;trim_lace&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;body-&#34;</span><span class=p>,</span> <span class=s2>&#34;body:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;liner-&#34;</span><span class=p>,</span> <span class=s2>&#34;liner:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;mesh-&#34;</span><span class=p>,</span> <span class=s2>&#34;mesh:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;&amp;&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;lace &#34;</span><span class=p>,</span> <span class=s2>&#34;lace: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;mesh &#34;</span><span class=p>,</span> <span class=s2>&#34;mesh: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;gusset &#34;</span><span class=p>,</span> <span class=s2>&#34;gusset: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;top &#34;</span><span class=p>,</span> <span class=s2>&#34;top: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;body &#34;</span><span class=p>,</span> <span class=s2>&#34;body: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;fabric &#34;</span><span class=p>,</span> <span class=s2>&#34; fabric: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;bottom &#34;</span><span class=p>,</span> <span class=s2>&#34; bottom: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34; :&#34;</span><span class=p>,</span> <span class=s2>&#34;:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;;&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;,&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;. &#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;ï¼Œ&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;pa-00462-tho pa-00464-tho&#34;</span><span class=p>,</span> <span class=s2>&#34;pa-00464-tho&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;pa-00462-tho:&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;g string &#34;</span><span class=p>,</span> <span class=s2>&#34;g-string: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;95</span><span class=si>% 5%</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;100%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>,</span> <span class=s2>&#34;: &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\t</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;$&#34;</span><span class=p>,</span> <span class=s2>&#34;%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34; with &#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;  &#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>%s</span><span class=s2> &#34;</span><span class=p>,</span> <span class=s2>&#34;% &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;bci cotton&#34;</span><span class=p>,</span> <span class=s2>&#34;cotton&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;pa-\d</span><span class=si>{5}</span><span class=s2>-tho:&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;spandexbottom:&#34;</span><span class=p>,</span> <span class=s2>&#34;spandex bottom:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># typos</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;sapndex&#34;</span><span class=p>,</span> <span class=s2>&#34;spandex&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;spadnex&#34;</span><span class=p>,</span> <span class=s2>&#34;spandex&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;spandexndex&#34;</span><span class=p>,</span> <span class=s2>&#34;spandex&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=s2>&#34;span$&#34;</span><span class=p>,</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=s2>&#34;spande$&#34;</span><span class=p>,</span> <span class=s2>&#34;spandex&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;polyest &#34;</span><span class=p>,</span> <span class=s2>&#34;polyester &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=s2>&#34;polyeste$&#34;</span><span class=p>,</span> <span class=s2>&#34;polyester&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>sub</span><span class=p>(</span><span class=s2>&#34;poly$&#34;</span><span class=p>,</span> <span class=s2>&#34;polyester&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;polyster&#34;</span><span class=p>,</span> <span class=s2>&#34;polyester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;polyeste &#34;</span><span class=p>,</span> <span class=s2>&#34;polyester &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;elastanee&#34;</span><span class=p>,</span> <span class=s2>&#34;elastane&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34; poly &#34;</span><span class=p>,</span> <span class=s2>&#34; polyester &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;cotton algodÃ³n coton&#34;</span><span class=p>,</span> <span class=s2>&#34;cotton&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;poliamide&#34;</span><span class=p>,</span> <span class=s2>&#34;polyamide&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;recycle polyamide&#34;</span><span class=p>,</span> <span class=s2>&#34;recycled polyamide&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;polyester poliÃ©ster&#34;</span><span class=p>,</span> <span class=s2>&#34;polyester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;polystester&#34;</span><span class=p>,</span> <span class=s2>&#34;polyester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;regualar polyamide&#34;</span><span class=p>,</span> <span class=s2>&#34;regular polyamide&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;recycle nylon&#34;</span><span class=p>,</span> <span class=s2>&#34;recycled nylon&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;buttom&#34;</span><span class=p>,</span> <span class=s2>&#34;bottom&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;recycle polyester&#34;</span><span class=p>,</span> <span class=s2>&#34;recycled polyester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;125&#34;</span><span class=p>,</span> <span class=s2>&#34;12%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;135&#34;</span><span class=p>,</span> <span class=s2>&#34;13%&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;recycled polyeser&#34;</span><span class=p>,</span> <span class=s2>&#34;recycled polyester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;polyeter&#34;</span><span class=p>,</span> <span class=s2>&#34;polyester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;polyeseter&#34;</span><span class=p>,</span> <span class=s2>&#34;polyester&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;viscouse&#34;</span><span class=p>,</span> <span class=s2>&#34;viscose&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;ctton&#34;</span><span class=p>,</span> <span class=s2>&#34;cotton&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>text</span> <span class=o>=</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;ryaon&#34;</span><span class=p>,</span> <span class=s2>&#34;rayon&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>text</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&#34;  &#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>named_pattern</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>pattern</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;(?P&lt;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>&gt;</span><span class=si>{</span><span class=n>pattern</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>multiple</span><span class=p>(</span><span class=n>pattern</span><span class=p>,</span> <span class=n>at_least_one</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;(</span><span class=si>{</span><span class=n>pattern</span><span class=si>}</span><span class=s2>)+&#34;</span> <span class=k>if</span> <span class=n>at_least_one</span> <span class=k>else</span> <span class=sa>f</span><span class=s2>&#34;(</span><span class=si>{</span><span class=n>pattern</span><span class=si>}</span><span class=s2>)*&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sep</span><span class=p>(</span><span class=n>pattern</span><span class=p>,</span> <span class=n>sep</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>pattern</span> <span class=o>+</span> <span class=n>multiple</span><span class=p>(</span><span class=n>sep</span> <span class=o>+</span> <span class=n>pattern</span><span class=p>,</span> <span class=n>at_least_one</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>split_composition_into_component_materials</span><span class=p>(</span><span class=n>text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; split_composition_into_component_materials(&#39;fabric: 80% polyamide 20</span><span class=si>% e</span><span class=s2>lastane lining: 100% polyester&#39;)
</span></span></span><span class=line><span class=cl><span class=s2>    {&#39;fabric&#39;: [(&#39;80&#39;, &#39;polyamide&#39;), (&#39;20&#39;, &#39;elastane&#39;)], &#39;lining&#39;: [(&#39;100&#39;, &#39;polyester&#39;)]}
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>component</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>materials</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>component_materials</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>token</span> <span class=ow>in</span> <span class=n>re</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;\s+&#34;</span><span class=p>,</span> <span class=n>text</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>token</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>materials</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>component_materials</span><span class=p>[</span><span class=n>component</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34; &#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>materials</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>materials</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>            <span class=n>component</span> <span class=o>=</span> <span class=n>token</span><span class=o>.</span><span class=n>rstrip</span><span class=p>(</span><span class=s2>&#34;:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>materials</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>materials</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>component_materials</span><span class=p>[</span><span class=n>component</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34; &#34;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>materials</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Parse the materials</span>
</span></span><span class=line><span class=cl>    <span class=n>material_pat</span> <span class=o>=</span> <span class=n>named_pattern</span><span class=p>(</span><span class=s2>&#34;material&#34;</span><span class=p>,</span> <span class=sa>r</span><span class=s2>&#34;[a-zA-ZÃ€-Ã¿\-\s&#39;]+[a-zA-ZÃ€-Ã¿\-&#39;]&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>proportion_pat</span> <span class=o>=</span> <span class=n>named_pattern</span><span class=p>(</span><span class=s2>&#34;proportion&#34;</span><span class=p>,</span> <span class=sa>r</span><span class=s2>&#34;\d{1,3}([,\.]\d{1,2})?&#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;%?&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>component</span><span class=p>,</span> <span class=n>materials</span> <span class=ow>in</span> <span class=n>component_materials</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>        <span class=n>pattern</span> <span class=o>=</span> <span class=n>sep</span><span class=p>(</span><span class=sa>rf</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>proportion_pat</span><span class=si>}</span><span class=s2>\s*</span><span class=si>{</span><span class=n>material_pat</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>match</span> <span class=o>=</span> <span class=n>regex</span><span class=o>.</span><span class=k>match</span><span class=p>(</span><span class=n>pattern</span><span class=p>,</span> <span class=n>materials</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>component_materials</span><span class=p>[</span><span class=n>component</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;material&#34;</span><span class=p>:</span> <span class=n>m</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;proportion&#34;</span><span class=p>:</span> <span class=nb>float</span><span class=p>(</span><span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>m</span><span class=p>,</span> <span class=n>p</span> <span class=ow>in</span> <span class=nb>zip</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=k>match</span><span class=o>.</span><span class=n>capturesdict</span><span class=p>()[</span><span class=s2>&#34;material&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=k>match</span><span class=o>.</span><span class=n>capturesdict</span><span class=p>()[</span><span class=s2>&#34;proportion&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>component_materials</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>inputs</span> <span class=o>=</span> <span class=n>pathlib</span><span class=o>.</span><span class=n>Path</span><span class=p>(</span><span class=s1>&#39;inputs.txt&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read_text</span><span class=p>()</span><span class=o>.</span><span class=n>splitlines</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>outputs</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>inp</span> <span class=ow>in</span> <span class=n>inputs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>inp</span> <span class=o>=</span> <span class=n>normalize_composition_format</span><span class=p>(</span><span class=n>inp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>out</span> <span class=o>=</span> <span class=n>split_composition_into_component_materials</span><span class=p>(</span><span class=n>inp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>outputs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>out</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>expected_outputs</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>pathlib</span><span class=o>.</span><span class=n>Path</span><span class=p>(</span><span class=s1>&#39;outputs.json&#39;</span><span class=p>)</span><span class=o>.</span><span class=n>read_text</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>outputs</span> <span class=o>==</span> <span class=n>expected_outputs</span>
</span></span></code></pre></div></details><p>The core parsing logic happens in <code>split_composition_into_component_materials</code>. It begins by splitting the text into tokens. Tokens that end with a <code>:</code> are classified as component names. That allows regrouping tokens into groups, each group corresponding to one component. Once that&rsquo;s done, a regex pattern is used to recognize all the <code>(proportion, material)</code> pairs within a group. This logic is straightforward and dead easy to unit test. The only problem is that each piece of text doesn&rsquo;t always follow this idealized pattern.</p><p>There&rsquo;s a second function called <code>normalize_composition_format</code> which cleans each piece of text. For instance, in some texts, the component names end with a <code>-</code> rather than a <code>:</code>. Sometimes a <code>;</code> might be used to separate components. There are also a whole bunch of typos, such as <code>polyeseter -> polyester</code> &ndash; in fact, I found 10 different spellings for polyester. There&rsquo;s also some more esoteric corrections to make like <code>cotton algodÃ³n coton -> cotton</code>.</p><p>The details are not very interesting. I guess what&rsquo;s more important is the process it took to build this normalization function. Essentially, I looped through the inputs, tried to parse them, and stopped each time something went wrong &ndash; i.e. when my Python script raised an exception. Then I diagnosed the error, edited the code to accommodate the new case, and moved on. Rinse and repeat. It&rsquo;s essentially a boring feedback loop with myself.</p><h2 id=room-for-improvement>Room for improvement</h2><p>What I dislike with my current solution is that the parsing system is dumb and isn&rsquo;t learning by itself. I would love to build a feedback loop between the system and myself, which would enable the system to <em>learn</em> how to parse each sentence from the examples I provide it with. If the system is unsure, then it asks me to confirm/edit a parsing. For this to work, the feedback loop must be data-driven: I only label parts of the sentence, and I delegate the parsing logic to the system.</p><p>Of course, what I&rsquo;m describing has a name: it&rsquo;s an <a href=https://www.wikiwand.com/en/Active_learning_(machine_learning)>active learning</a> scenario. I&rsquo;m also well aware that I could create this feedback loop with a tool like <a href=https://prodi.gy/>Prodigy</a>. For instance, I&rsquo;ve spotted <a href=https://prodi.gy/docs/dependencies-relations#ner>this</a> recipe for combining named entity recognition with relation extraction.</p><p>I haven&rsquo;t yet reached the point where I feel overwhelmed and in need of setting up this feedback loop. As of now, I can manage the workload. I don&rsquo;t feel like the initial investment of setting up something more complex will yield significant benefits. On the contrary, I&rsquo;m still in doubt as to what an all-in-one solution would look like. For instance, I haven&rsquo;t seen good examples of using Prodigy to correct spelling errors and normalize names, which are important aspects to me. But that&rsquo;s likely because I&rsquo;m just lacking NLP experience. At some point, I will likely spend some time and put a smarter solution in place.</p><p>I have written bespoke parsing functions for several catalogs I&rsquo;ve had to work on. In each case, the parsing logic is rule-based, just like the piece of code above. The nice thing is that this generates a whole bunch of <code>input -> output</code> labeled data from different sources. That way I won&rsquo;t have to start from scratch the day I decide to begin a machine learning based solution. <a href=https://www.cidrdb.org/cidr2020/papers/p31-sheng-cidr20.pdf>This</a> paper describes a similar situation, wherein a team at Google moved from a rule-based setup to a &ldquo;Software 2.0&rdquo; solution for an email information extraction task.</p><p>I&rsquo;m very curious to understand how would others do it. I imagine this kind of problem is faced by many practitioners. I can&rsquo;t be the only one hesitating between sticking to my rules, and moving on to a machine learning system. Feel free to reach out and/or leave a comment below if you want to share your experience! Note that I&rsquo;m very interested in the underlying thought process and the user experience that is involved, more so than the solution in itself.</p><p>Dear reader, how would you do it?</p></div><script type=text/javascript>var s=document.createElement("script");s.setAttribute("src","https://utteranc.es/client.js"),s.setAttribute("repo","MaxHalford/maxhalford.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",null),s.setAttribute("theme","github-light"),document.body.appendChild(s)</script><div style=display:flex;flex-direction:row;justify-content:center;align-items:center;gap:20px;margin-bottom:30px><div class=do-the-thing><div class=elevator><svg class="sweet-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" enable-background="new 0 0 100 100" height="100" width="100"><path d="M70 47.5H30c-1.4.0-2.5 1.1-2.5 2.5v40c0 1.4 1.1 2.5 2.5 2.5h40c1.4.0 2.5-1.1 2.5-2.5V50C72.5 48.6 71.4 47.5 70 47.5zm-22.5 40h-5v-25h5v25zm10 0h-5v-25h5v25zm10 0h-5V60c0-1.4-1.1-2.5-2.5-2.5H40c-1.4.0-2.5 1.1-2.5 2.5v27.5h-5v-35h35v35z"/><path d="M50 42.5c1.4.0 2.5-1.1 2.5-2.5V16l5.7 5.7c.5.5 1.1.7 1.8.7s1.3-.2 1.8-.7c1-1 1-2.6.0-3.5l-10-10c-1-1-2.6-1-3.5.0l-10 10c-1 1-1 2.6.0 3.5 1 1 2.6 1 3.5.0l5.7-5.7v24c0 1.4 1.1 2.5 2.5 2.5z"/></svg>
Back to the top</div></div><iframe src=https://github.com/sponsors/MaxHalford/button title="Sponsor MaxHalford" height=32 width=114 style=border:0;border-radius:6px></iframe></div><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script><script>var elementButton=document.querySelector(".elevator"),elevator=new Elevator({element:elementButton,mainAudio:"/music/elevator.mp3",endAudio:"/music/ding.mp3"})</script><style>.down-arrow{font-size:120px;margin-top:90px;margin-bottom:90px;text-shadow:0 -20px #0c1f31,0 0 #c33329;color:transparent;-webkit-transform:scaleY(.8);-moz-transform:scaleY(.8);transform:scaleY(.8)}.elevator{text-align:center;cursor:pointer;width:140px;margin:auto}.elevator:hover{opacity:.7}.elevator svg{width:40px;height:40px;display:block;margin:auto;margin-bottom:5px}</style><div class=related-content><h3 style=margin-top:10px!important;margin-bottom:10px!important>Related posts</h3><ul style=margin-top:0><li><a href=/blog/ocr-spelling-correction-is-hard/>OCR spelling correction is hard</a></li><li><a href=/blog/homoglyphs/>Homoglyphs: different characters that look identical</a></li><li><a href=/blog/text-classification-by-compression/>Text classification by data compression</a></li></ul></div></div></div></article></body></html>