<!doctype html><html lang=en><head><script defer src=https://unpkg.com/@tinybirdco/flock.js data-host=https://api.tinybird.co data-token=p.eyJ1IjogImMwMjJhMjg1LWJmY2YtNDc0OC1hYzczLTJhMDQ1Njk3NTI0YyIsICJpZCI6ICIzNjc3NjQ3Ny04MTE2LTRmYWQtYjcwMy1iZmM3YjMwZGJjMjMifQ.A0vHm-VWbXG6uBFZiwuspN_AyfSYNrdZE3IgwgWSt4g></script><meta charset=utf-8><meta name=generator content="Hugo 0.123.8"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Max Halford"><meta property="og:url" content="https://maxhalford.github.io/blog/ogd-in-sql/"><link rel=canonical href=https://maxhalford.github.io/blog/ogd-in-sql/><meta property="og:title" content="Online gradient descent written in SQL"><meta property="og:description" content="Edit &ndash; this post generated a few insightful comments on Hacker News. I&rsquo;ve also put the code in a notebook for ease of use.
Introduction Modern MLOps is complex because it involves too many components. You need a message bus, a stream processing engine, an API, a model store, a feature store, a monitoring service, etc. Sadly, containerisation software and the unbundling trend have encouraged an appetite for complexity. I believe MLOps shouldn&rsquo;t be this complex."><meta property="og:type" content="article"><meta property="og:url" content="https://maxhalford.github.io/blog/ogd-in-sql/"><meta property="og:image" content="https://maxhalford.github.io/img/belle-ile.jpg"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-03-07T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-07T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maxhalford.github.io/img/belle-ile.jpg"><meta name=twitter:title content="Online gradient descent written in SQL"><meta name=twitter:description content="Edit &ndash; this post generated a few insightful comments on Hacker News. I&rsquo;ve also put the code in a notebook for ease of use.
Introduction Modern MLOps is complex because it involves too many components. You need a message bus, a stream processing engine, an API, a model store, a feature store, a monitoring service, etc. Sadly, containerisation software and the unbundling trend have encouraged an appetite for complexity. I believe MLOps shouldn&rsquo;t be this complex."><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🦆</text></svg>"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/maxhalford.github.io\/"},"articleSection":"blog","name":"Online gradient descent written in SQL","headline":"Online gradient descent written in SQL","description":"Edit \u0026ndash; this post generated a few insightful comments on Hacker News. I\u0026rsquo;ve also put the code in a notebook for ease of use.\nIntroduction Modern MLOps is complex because it involves too many components. You need a message bus, a stream processing engine, an API, a model store, a feature store, a monitoring service, etc. Sadly, containerisation software and the unbundling trend have encouraged an appetite for complexity. I believe MLOps shouldn\u0026rsquo;t be this complex.","inLanguage":"en-US","author":"Max Halford","creator":"Max Halford","publisher":"Max Halford","accountablePerson":"Max Halford","copyrightHolder":"Max Halford","copyrightYear":"2023","datePublished":"2023-03-07 00:00:00 \u002b0000 UTC","dateModified":"2023-03-07 00:00:00 \u002b0000 UTC","url":"https:\/\/maxhalford.github.io\/blog\/ogd-in-sql\/","keywords":["online-machine-learning","sql"]}</script><title>Online gradient descent written in SQL • Max Halford</title>
<meta property="og:title" content="Online gradient descent written in SQL • Max Halford"><meta property="og:type" content="article"><meta name=description content="Edit &ndash; this post generated a few insightful comments on Hacker News. I&rsquo;ve also put the code in a notebook for ease of use.
Introduction Modern MLOps is complex because it involves too many components. You need a message bus, a stream processing engine, an API, a model store, a feature store, a monitoring service, etc. Sadly, containerisation software and the unbundling trend have encouraged an appetite for complexity. I believe MLOps shouldn&rsquo;t be this complex."><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/github-markdown.min.css><link rel=stylesheet href=/css/highlight/github.css><link rel=stylesheet href=/css/index.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Permanent+Marker&display=swap" rel=stylesheet><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0,tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><article class=post id=article><div class="row center-xs" style=text-align:left><div class="col-xs-12 col-sm-10 col-md-7 col-lg-5"><div class=header><header class=header-parts><div class="signatures site-title"><a href=/>Max Halford 🦆</a></div><div class=header-links><a class=header-link href=/>Blog</a>
<a class=header-link href=/links/>Links</a>
<a class=header-link href=/bio/>Bio</a></div></header></div><header class=post-header><h1 class=post-title>Online gradient descent written in SQL</h1><div class="row post-desc"><div class="col-xs-12 post-desc-items"><time class=post-date datetime="2023-03-07 00:00:00 UTC">2023-03-07
</time><span class=posts-line-tag>online-machine-learning</span>
<span class=posts-line-tag>sql</span></div></div></header><div class="post-content markdown-body"><h2 id=toc>Table of contents</h2><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#some-data>Some data</a></li><li><a href=#running-average>Running average</a></li><li><a href=#running-covariance>Running covariance</a></li><li><a href=#handling-many-variables>Handling many variables</a></li><li><a href=#online-gradient-descent>Online gradient descent</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav><p><strong>Edit</strong> &ndash; <em>this post <a href="https://news.ycombinator.com/item?id=35054786">generated</a> a few insightful comments on Hacker News. I&rsquo;ve also put the code in a <a href=https://gist.github.com/MaxHalford/823c4e7f9216607dc853724ec74ec692>notebook</a> for ease of use.</em></p><h2 id=introduction>Introduction</h2><p>Modern MLOps is complex because it involves too many components. You need a message bus, a stream processing engine, an API, a model store, a feature store, a monitoring service, etc. Sadly, containerisation software and the unbundling trend have encouraged an appetite for complexity. I believe MLOps shouldn&rsquo;t be this complex. For instance, MLOps can be made simpler by <a href=https://www.ethanrosenthal.com/2022/05/10/database-bundling/>bundling the logic into your database</a>.</p><p>In this post, I want to push this idea, and actually implement a machine learning algorithm within a relational database, using SQL. <a href=https://mindsdb.com/>Some</a> <a href=https://supabase.com/blog/openai-embeddings-postgres-vector>databases</a> allow doing inference with an already trained model. Actually training the model in the database would remove altogether the need for a separate inference/training service.</p><p>Being familiar with online machine learning, I picked online gradient descent. My gut feeling is that this should be a straightforward implementation using <code>WITH RECURSIVE</code>. I decided to work my way up to it by first implementing simpler online algorithms, starting with a running average.</p><h2 id=some-data>Some data</h2><p>To illustrate, I took some Yahoo! Finance data:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>import</span> <span class=nn>yfinance</span> <span class=k>as</span> <span class=nn>yf</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>figures</span> <span class=o>=</span> <span class=n>yf</span><span class=o>.</span><span class=n>download</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>tickers</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;AAPL&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=n>start</span><span class=o>=</span><span class=s1>&#39;2020-01-01&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>end</span><span class=o>=</span><span class=s1>&#39;2022-01-01&#39;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>figures</span> <span class=o>/=</span> <span class=n>figures</span><span class=o>.</span><span class=n>std</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>figures</span><span class=o>.</span><span class=n>tail</span><span class=p>()</span>
</span></span></code></pre></div><table><thead><tr><th style=text-align:left>Date</th><th style=text-align:right>Open</th><th style=text-align:right>High</th><th style=text-align:right>Low</th><th style=text-align:right>Close</th><th style=text-align:right>Adj Close</th><th style=text-align:right>Volume</th></tr></thead><tbody><tr><td style=text-align:left>2021-12-27</td><td style=text-align:right>2.00543</td><td style=text-align:right>2.06042</td><td style=text-align:right>2.06425</td><td style=text-align:right>2.11303</td><td style=text-align:right>2.11677</td><td style=text-align:right>-0.7789</td></tr><tr><td style=text-align:left>2021-12-28</td><td style=text-align:right>2.10966</td><td style=text-align:right>2.09118</td><td style=text-align:right>2.11413</td><td style=text-align:right>2.0777</td><td style=text-align:right>2.08174</td><td style=text-align:right>-0.712006</td></tr><tr><td style=text-align:left>2021-12-29</td><td style=text-align:right>2.08148</td><td style=text-align:right>2.06752</td><td style=text-align:right>2.1008</td><td style=text-align:right>2.08076</td><td style=text-align:right>2.08477</td><td style=text-align:right>-0.977945</td></tr><tr><td style=text-align:left>2021-12-30</td><td style=text-align:right>2.08623</td><td style=text-align:right>2.06549</td><td style=text-align:right>2.0991</td><td style=text-align:right>2.04068</td><td style=text-align:right>2.04502</td><td style=text-align:right>-1.01873</td></tr><tr><td style=text-align:left>2021-12-31</td><td style=text-align:right>2.03938</td><td style=text-align:right>2.0202</td><td style=text-align:right>2.07074</td><td style=text-align:right>2.01928</td><td style=text-align:right>2.0238</td><td style=text-align:right>-0.950815</td></tr></tbody></table><p>☝️ <em>I normalized the data using standard scaling. This puts the figures on a friendlier scale. It will also help the online gradient descent converge. This could very well be done in SQL, but this is fine too.</em></p><h2 id=running-average>Running average</h2><p>With SQL, we could obviously just use <code>AVG</code> to obtain an average. We could also use a <a href=https://duckdb.org/docs/sql/window_functions.html>window function</a> if we wanted to calculate the average at every point in time.</p><p>I&rsquo;m not sure how common knowledge this is, but there is a formula that allows <a href=https://nestedsoftware.com/2018/03/20/calculating-a-moving-average-on-streaming-data-5a7k.22879.html>updating a running average</a> with a new data point in $\mathcal{O}(1)$ time. This can be applied to a data stream, because the update formula only requires the current data point, as well as the current average.</p><p>$$\mu_0 = 0$$
$$\mu_{t+1} = \mu_t + \frac{x - \mu_t}{t + 1}$$</p><p>I&rsquo;ll be using DuckDB. A nice feature is that it&rsquo;s aware of any existing pandas dataframe &ndash; provided you&rsquo;re running DuckDB <a href=https://duckdb.org/docs/api/python/overview>using Python</a>. Indeed, we can directly query the <code>figures</code> dataframe. Also, DuckDB supports <code>WITH RECURSIVE</code>, which is the cornerstone I&rsquo;ll make heavy use of.</p><p>There are many good tutorials about how <code>WITH RECURSIVE</code> works, so I won&rsquo;t expand on it. The way I will use it is a bit particular, in that I leverage it to update some current state. The current state points to the current row. At each recursion step, the current state is joined with the next row, which allows updating the state.</p><div align=center><figure><img width=75% src=/img/blog/sgd-in-sql/recursion.png style=box-shadow:none><figcaption>Recursive state update</figcaption></figure></div><p>The first idea is to assign a step number to each row. Assuming the rows are pre-sorted, a <code>ROW_NUMBER</code> can be used to assign an auto-incrementing integer to each row. This step column is then used to connect each state to the next row.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=k>RECURSIVE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>stream</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ROW_NUMBER</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>step</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s2>&#34;Adj Close&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>x</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>figures</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>state</span><span class=p>(</span><span class=n>step</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=k>avg</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>-- Initialize
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>step</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>avg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>stream</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>step</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>-- Update
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stream</span><span class=p>.</span><span class=n>step</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stream</span><span class=p>.</span><span class=n>x</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>state</span><span class=p>.</span><span class=k>avg</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>stream</span><span class=p>.</span><span class=n>x</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=k>state</span><span class=p>.</span><span class=k>avg</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=n>step</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>avg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>stream</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=k>state</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>state</span><span class=p>.</span><span class=n>step</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=n>step</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=k>state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>step</span><span class=w> </span><span class=k>DESC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LIMIT</span><span class=w> </span><span class=mi>5</span><span class=w>
</span></span></span></code></pre></div><pre tabindex=0><code>┌───────┬───────────────────┬────────────────────┐
│ step  │         x         │        avg         │
│ int64 │      double       │       double       │
├───────┼───────────────────┼────────────────────┤
│   505 │ 5.981568542028378 │ 3.9577706471349923 │
│   504 │ 6.002789566151079 │  3.953755175121315 │
│   503 │ 6.042539700173864 │  3.949681548101375 │
│   502 │ 6.039508125299193 │  3.945512507957804 │
│   501 │ 6.074541325571636 │  3.941332875987063 │
└───────┴───────────────────┴────────────────────┘
</code></pre><p>We can verify this is correct by doing a rolling mean in pandas:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>figures</span><span class=p>[</span><span class=s1>&#39;Adj Close&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>figures</span><span class=p>),</span> <span class=n>min_periods</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>tail</span><span class=p>()[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><pre tabindex=0><code>Date
2021-12-31    3.957771
2021-12-30    3.953755
2021-12-29    3.949682
2021-12-28    3.945513
2021-12-27    3.941333
</code></pre><p>☝️ <em>This usage of <code>WITH RECURSIVE</code> essentially boils down to a window function. This could be implemented as such, which would avoid the headache of thinking in terms of recursion. For instance, PostgreSQL supports <a href=https://www.postgresql.org/docs/current/xaggr.html>user-defined aggregates</a>, which can be applied over a window. However, the <code>WITH RECURSIVE</code> syntax has better support across databases.</em></p><h2 id=running-covariance>Running covariance</h2><p>The query above measures the running average for a single variable &ndash; namely <code>Adj Close</code>. What if we want to compute something that involves more than one variable? The naive way is to just copy/paste the logic for each variable. For instance, to calculate a running covariance, it is necessary to compute the running average of two variables. Check out <a href=https://www.wikiwand.com/en/Algorithms_for_calculating_variance#Covariance>Welford&rsquo;s algorithm</a> for more information.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=k>RECURSIVE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>stream</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ROW_NUMBER</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>step</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s2>&#34;Adj Close&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s2>&#34;Close&#34;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>figures</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>state</span><span class=p>(</span><span class=n>step</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>x_avg</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=n>y_avg</span><span class=p>,</span><span class=w> </span><span class=n>cov</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>-- Initialize
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>step</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>x</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>x</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>x_avg</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>y</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>y</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>y_avg</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mi>0</span><span class=p>::</span><span class=n>DOUBLE</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>cov</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>stream</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>step</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>-- Update
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>step</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>x</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>x_new_avg</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>x_avg</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>y</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>y_new_avg</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>y_avg</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>cov</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>((</span><span class=n>x</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>x_prev_avg</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>y</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>y_new_avg</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>cov</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>step</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>cov</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>stream</span><span class=p>.</span><span class=n>step</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>stream</span><span class=p>.</span><span class=n>x</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>stream</span><span class=p>.</span><span class=n>y</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>state</span><span class=p>.</span><span class=n>x_avg</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>x_prev_avg</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>state</span><span class=p>.</span><span class=n>x_avg</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>stream</span><span class=p>.</span><span class=n>x</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=k>state</span><span class=p>.</span><span class=n>x_avg</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=n>step</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>x_new_avg</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>state</span><span class=p>.</span><span class=n>y_avg</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>y_prev_avg</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>state</span><span class=p>.</span><span class=n>y_avg</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>stream</span><span class=p>.</span><span class=n>y</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=k>state</span><span class=p>.</span><span class=n>y_avg</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=n>step</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>y_new_avg</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>state</span><span class=p>.</span><span class=n>cov</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>FROM</span><span class=w> </span><span class=n>stream</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=k>state</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>state</span><span class=p>.</span><span class=n>step</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=n>step</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>step</span><span class=p>,</span><span class=w> </span><span class=n>cov</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=k>state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>step</span><span class=w> </span><span class=k>DESC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LIMIT</span><span class=w> </span><span class=mi>5</span><span class=w>
</span></span></span></code></pre></div><pre tabindex=0><code>┌───────┬────────────────────┐
│ step  │        cov         │
│ int64 │       double       │
├───────┼────────────────────┤
│   505 │ 0.9979967767965502 │
│   504 │ 0.9918524780369538 │
│   503 │  0.985478504290919 │
│   502 │ 0.9787158318485241 │
│   501 │ 0.9719167545245742 │
└───────┴────────────────────┘
</code></pre><p>Other than handling two variables, the major difference with this query is that a subquery is used to calculate some intermediary state. We will reuse this idea for online gradient descent.</p><p>We can also verify the output is correct by comparing to pandas:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>figures</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>figures</span><span class=p>),</span> <span class=n>min_periods</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>cov</span><span class=p>(</span><span class=n>ddof</span><span class=o>=</span><span class=mi>0</span><span class=p>)[</span><span class=s1>&#39;Adj Close&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>loc</span><span class=p>[:,</span> <span class=s1>&#39;Close&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>tail</span><span class=p>()[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><pre tabindex=0><code>Date
2021-12-31    0.997997
2021-12-30    0.991852
2021-12-29    0.985479
2021-12-28    0.978716
2021-12-27    0.971917
</code></pre><h2 id=handling-many-variables>Handling many variables</h2><p>The downside of the queries above is that the variable names have to be hardcoded. There is no way to handle an arbitrary number of variables. For instance, if we have several variables, how would we calculate the average of each variable, without expliciting them in the query?</p><p>As is often the case, converting the data to a <a href=https://r4ds.had.co.nz/tidy-data.html>tidy representation</a> makes life easier. In this case, tidy data is obtained by melting &ndash; i.e. unpivoting &ndash; the dataframe.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=n>figures_flat</span> <span class=o>=</span> <span class=n>figures</span><span class=o>.</span><span class=n>melt</span><span class=p>(</span><span class=n>ignore_index</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>reset_index</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>figures_flat</span><span class=o>.</span><span class=n>columns</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;date&#39;</span><span class=p>,</span> <span class=s1>&#39;variable&#39;</span><span class=p>,</span> <span class=s1>&#39;value&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>figures_flat</span> <span class=o>=</span> <span class=n>figures_flat</span><span class=o>.</span><span class=n>sort_values</span><span class=p>([</span><span class=s1>&#39;date&#39;</span><span class=p>,</span> <span class=s1>&#39;variable&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>figures_flat</span><span class=o>.</span><span class=n>head</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span></code></pre></div><table><thead><tr><th style=text-align:left>date</th><th style=text-align:left>variable</th><th style=text-align:right>value</th></tr></thead><tbody><tr><td style=text-align:left>2020-01-02</td><td style=text-align:left>Adj Close</td><td style=text-align:right>-1.46542</td></tr><tr><td style=text-align:left>2020-01-02</td><td style=text-align:left>Close</td><td style=text-align:right>-1.46182</td></tr><tr><td style=text-align:left>2020-01-02</td><td style=text-align:left>High</td><td style=text-align:right>-1.49763</td></tr><tr><td style=text-align:left>2020-01-02</td><td style=text-align:left>Low</td><td style=text-align:right>-1.46396</td></tr><tr><td style=text-align:left>2020-01-02</td><td style=text-align:left>Open</td><td style=text-align:right>-1.49242</td></tr><tr><td style=text-align:left>2020-01-02</td><td style=text-align:left>Volume</td><td style=text-align:right>0.180024</td></tr><tr><td style=text-align:left>2020-01-03</td><td style=text-align:left>Adj Close</td><td style=text-align:right>-1.48965</td></tr><tr><td style=text-align:left>2020-01-03</td><td style=text-align:left>Close</td><td style=text-align:right>-1.48662</td></tr><tr><td style=text-align:left>2020-01-03</td><td style=text-align:left>High</td><td style=text-align:right>-1.4978</td></tr><tr><td style=text-align:left>2020-01-03</td><td style=text-align:left>Low</td><td style=text-align:right>-1.45277</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=k>RECURSIVE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>stream</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>RANK_DENSE</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=nb>date</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>step</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>figures_flat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=nb>date</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>state</span><span class=p>(</span><span class=n>step</span><span class=p>,</span><span class=w> </span><span class=k>variable</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=k>avg</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>-- Initialize
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>step</span><span class=p>,</span><span class=w> </span><span class=k>variable</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>avg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>stream</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>step</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>-- Update
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stream</span><span class=p>.</span><span class=n>step</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stream</span><span class=p>.</span><span class=k>variable</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stream</span><span class=p>.</span><span class=n>value</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>state</span><span class=p>.</span><span class=k>avg</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>stream</span><span class=p>.</span><span class=n>value</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=k>state</span><span class=p>.</span><span class=k>avg</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=n>step</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>avg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>stream</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=k>state</span><span class=w> </span><span class=k>ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>state</span><span class=p>.</span><span class=n>step</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=n>step</span><span class=w> </span><span class=k>AND</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>state</span><span class=p>.</span><span class=k>variable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=k>variable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=k>state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>step</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>MAX</span><span class=p>(</span><span class=n>step</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=k>state</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>variable</span><span class=w>
</span></span></span></code></pre></div><pre tabindex=0><code>┌───────┬───────────┬────────────────────┬────────────────────┐
│ step  │ variable  │       value        │        avg         │
│ int64 │  varchar  │       double       │       double       │
├───────┼───────────┼────────────────────┼────────────────────┤
│   505 │ Adj Close │  5.981568542028378 │ 3.9577706471349923 │
│   505 │ Close     │   6.03165394229666 │  4.012373756823449 │
│   505 │ High      │  6.057853942108038 │   4.03765319364954 │
│   505 │ Low       │   6.05591789308585 │  3.985178489614261 │
│   505 │ Open      │  6.046125216781687 │  4.006746251814558 │
│   505 │ Volume    │ 1.0143664144585565 │ 1.9651814487272024 │
└───────┴───────────┴────────────────────┴────────────────────┘
</code></pre><p>The main difference with the first query is that the join condition in the recursion includes the variable name, as well as the step number. A <code>RANK_DENSE</code> statement is also used instead of <code>ROW_NUMBER</code> to assign a step number to each group of rows.</p><p>Here is the equivalent using pandas:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>figures_flat</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;variable&#39;</span><span class=p>)[</span><span class=s1>&#39;value&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>rolling</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>figures_flat</span><span class=p>),</span> <span class=n>min_periods</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>mean</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>groupby</span><span class=p>(</span><span class=s1>&#39;variable&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>tail</span><span class=p>(</span><span class=mi>1</span><span class=p>)[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>sort_index</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><pre tabindex=0><code>variable
Adj Close  3.957771
Close      4.012374
High       4.037653
Low        3.985178
Open       4.006746
Volume     1.965181
</code></pre><h2 id=online-gradient-descent>Online gradient descent</h2><p>Finally, we have enough experience to implement online gradient descent. To keep things simple, we will use a very vanilla version:</p><ul><li>Constant learning rate, as opposed to a <a href=https://www.wikiwand.com/en/Learning_rate#Learning_rate_schedule>schedule</a>.</li><li>Single epoch, we only do one pass on the data.</li><li>Not stochastic: the rows are not shuffled.</li><li>Squared loss, which is the standard loss for regression.</li><li>No gradient clipping.</li><li>No weight regularisation.</li><li>No intercept term.</li></ul><p>None of these are impossible to implement using SQL. I just thought I&rsquo;d keep things simple in order to keep the code digest. Anyway, these assumptions lead to the following update formulas:</p><p>$$p_t = \dot{w}_t \cdot \dot{x}_t$$</p><p>$$l_t = p_t - y_t$$</p><p>$$\dot{g}_t = l_t \dot{x}_t$$</p><p>$$\dot{w}_{t+1} = \dot{w}_t - \eta \dot{g}_t$$</p><p>I&rsquo;ve added a $\dot{}$ symbol to the vector variables. Therefore $p_t$ is the prediction, defined as the dot product between weights $\dot{w}_t$ and features $\dot{x}_t$. The gradient of the loss $l_t$ is used to obtain the error gradient for the features $\dot{g}_t$, which respect to the current weights. This all leads to the simple weight update formula $\dot{w}_t - \eta \dot{g}_t$.</p><p>As an example, I decided to predict the <code>Adj Close</code> variable using the other variables. I&rsquo;m not saying this makes a lot of sense, it&rsquo;s just for the sake of example.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=k>RECURSIVE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>X</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>RANK_DENSE</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=nb>date</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>step</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>figures_flat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=k>variable</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s1>&#39;Adj Close&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=nb>date</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>y</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>RANK_DENSE</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=nb>date</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>step</span><span class=p>,</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>figures_flat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=k>variable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Adj Close&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=nb>date</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>stream</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SELECT</span><span class=w> </span><span class=n>X</span><span class=p>.</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>.</span><span class=n>value</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>target</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>X</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>X</span><span class=p>.</span><span class=n>step</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>y</span><span class=p>.</span><span class=n>step</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>state</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>-- Initialize
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>step</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>target</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>variable</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>value</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mi>0</span><span class=p>::</span><span class=n>DOUBLE</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>weight</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mi>0</span><span class=p>::</span><span class=n>DOUBLE</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>prediction</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>stream</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>step</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>UNION</span><span class=w> </span><span class=k>ALL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>-- Update
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>step</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>target</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>variable</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>value</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>weight</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>SUM</span><span class=p>(</span><span class=n>weight</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>prediction</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>stream</span><span class=p>.</span><span class=n>step</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>stream</span><span class=p>.</span><span class=n>target</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>stream</span><span class=p>.</span><span class=k>variable</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>stream</span><span class=p>.</span><span class=n>value</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>state</span><span class=p>.</span><span class=n>prediction</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=k>state</span><span class=p>.</span><span class=n>target</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>loss_gradient</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>loss_gradient</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>state</span><span class=p>.</span><span class=n>value</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>gradient</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>state</span><span class=p>.</span><span class=n>weight</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>gradient</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>weight</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>FROM</span><span class=w> </span><span class=n>stream</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=k>state</span><span class=w> </span><span class=k>ON</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>state</span><span class=p>.</span><span class=n>step</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=n>step</span><span class=w> </span><span class=k>AND</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>state</span><span class=p>.</span><span class=k>variable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stream</span><span class=p>.</span><span class=k>variable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=k>state</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>step</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>MAX</span><span class=p>(</span><span class=n>step</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=k>state</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>variable</span><span class=w>
</span></span></span></code></pre></div><pre tabindex=0><code>┌───────┬──────────┬──────────────────────┬───────────────────┬───────────────────┐
│ step  │ variable │        weight        │      target       │    prediction     │
│ int64 │ varchar  │        double        │      double       │      double       │
├───────┼──────────┼──────────────────────┼───────────────────┼───────────────────┤
│   505 │ Close    │   0.2511547716803354 │ 5.981568542028378 │ 5.938875441702928 │
│   505 │ High     │  0.24043897039853313 │ 5.981568542028378 │ 5.938875441702928 │
│   505 │ Low      │   0.2447191283620627 │ 5.981568542028378 │ 5.938875441702928 │
│   505 │ Open     │  0.23603830762609726 │ 5.981568542028378 │ 5.938875441702928 │
│   505 │ Volume   │ 0.057510279698874206 │ 5.981568542028378 │ 5.938875441702928 │
└───────┴──────────┴──────────────────────┴───────────────────┴───────────────────┘
</code></pre><p>It seems to be working! How can we check it is correct though? Well, we can fit an instance of scikit-learn&rsquo;s <code>SGDRegressor</code>. The weights should correspond exactly to what we obtained in SQL, as long we provide the correct parameters. This is to align with the simplifying assumptions that were made in the SQL implementation.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pprint</span> <span class=kn>import</span> <span class=n>pprint</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn</span> <span class=kn>import</span> <span class=n>linear_model</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>linear_model</span><span class=o>.</span><span class=n>SGDRegressor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>loss</span><span class=o>=</span><span class=s1>&#39;squared_error&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>penalty</span><span class=o>=</span><span class=kc>None</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>fit_intercept</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>learning_rate</span><span class=o>=</span><span class=s1>&#39;constant&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>eta0</span><span class=o>=</span><span class=mf>0.01</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>max_iter</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>shuffle</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>X</span> <span class=o>=</span> <span class=n>figures</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>y</span> <span class=o>=</span> <span class=n>X</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;Adj Close&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>model</span><span class=o>.</span><span class=n>fit</span><span class=p>(</span><span class=n>X</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>pprint</span><span class=p>(</span><span class=nb>dict</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>X</span><span class=o>.</span><span class=n>columns</span><span class=p>,</span> <span class=n>model</span><span class=o>.</span><span class=n>coef_</span><span class=p>)))</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=p>{</span><span class=s1>&#39;Close&#39;</span><span class=p>:</span> <span class=mf>0.2511547716803354</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;High&#39;</span><span class=p>:</span> <span class=mf>0.2404389703985331</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;Low&#39;</span><span class=p>:</span> <span class=mf>0.2447191283620624</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;Open&#39;</span><span class=p>:</span> <span class=mf>0.23603830762609757</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;Volume&#39;</span><span class=p>:</span> <span class=mf>0.05751027969887417</span><span class=p>}</span>
</span></span></code></pre></div><p>Spot on! To be even more certain this is correct, we can compare with <a href=https://riverml.xyz>River</a>&rsquo;s linear regression implementation, which uses online gradient descent under the hood.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=kn>from</span> <span class=nn>river</span> <span class=kn>import</span> <span class=n>linear_model</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>river</span> <span class=kn>import</span> <span class=n>optim</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CustomSquaredLoss</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>gradient</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>y_true</span><span class=p>,</span> <span class=n>y_pred</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>y_pred</span> <span class=o>-</span> <span class=n>y_true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>model</span> <span class=o>=</span> <span class=n>linear_model</span><span class=o>.</span><span class=n>LinearRegression</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>optimizer</span><span class=o>=</span><span class=n>optim</span><span class=o>.</span><span class=n>SGD</span><span class=p>(</span><span class=n>lr</span><span class=o>=</span><span class=mf>0.01</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>loss</span><span class=o>=</span><span class=n>CustomSquaredLoss</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=n>intercept_lr</span><span class=o>=</span><span class=mf>0.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>l2</span><span class=o>=</span><span class=mf>0.0</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>figures</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>to_dict</span><span class=p>(</span><span class=n>orient</span><span class=o>=</span><span class=s1>&#39;records&#39;</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>y</span> <span class=o>=</span> <span class=n>x</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s1>&#39;Adj Close&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>.</span><span class=n>learn_one</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pprint</span><span class=p>(</span><span class=n>model</span><span class=o>.</span><span class=n>weights</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-py data-lang=py><span class=line><span class=cl><span class=p>{</span><span class=s1>&#39;Close&#39;</span><span class=p>:</span> <span class=mf>0.2511547716803356</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;High&#39;</span><span class=p>:</span> <span class=mf>0.2404389703985331</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;Low&#39;</span><span class=p>:</span> <span class=mf>0.24471912836206253</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;Open&#39;</span><span class=p>:</span> <span class=mf>0.2360383076260972</span><span class=p>,</span>
</span></span><span class=line><span class=cl> <span class=s1>&#39;Volume&#39;</span><span class=p>:</span> <span class=mf>0.057510279698874255</span><span class=p>}</span>
</span></span></code></pre></div><div align=center>✅ 🎯 💯 🎉</div><h2 id=conclusion>Conclusion</h2><p>A machine learning algorithm which can be trained using SQL opens a world of possibilities. The model and the data live in the same space. This is as simple as it gets in terms of architecture. Basically, you only need a database which runs SQL.</p><p>Of course, the implementation we made is quite basic. Moreover, models using online gradient descent aren&rsquo;t necessarily the strongest ones. However, one could argue that what matters most in a model are the features you feed it with. As such, online gradient descent done in the database can be a great baseline from which to start with.</p><p>The key advantage of online machine learning is that you don&rsquo;t need to revisit past data points to update a model. However, all the queries we&rsquo;ve written are stateless, and will run from the top when they are refreshed. This sort of defeats the purpose of doing things online. Thankfully, stream processing engines are popping up, and they usually provide an SQL interface. For instance, Materialize is working on <a href=https://materialize.com/blog/recursion-in-materialize/>providing</a> <code>WITH RECURSIVE</code> semantics. Doing online gradient descent on top of Materialize sounds very powerful to me.</p></div><script type=text/javascript>var s=document.createElement("script");s.setAttribute("src","https://utteranc.es/client.js"),s.setAttribute("repo","MaxHalford/maxhalford.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",null),s.setAttribute("theme","github-light"),document.body.appendChild(s)</script><div style=display:flex;flex-direction:row;justify-content:center;align-items:center;gap:20px;margin-bottom:30px><div class=do-the-thing><div class=elevator><svg class="sweet-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" enable-background="new 0 0 100 100" height="100" width="100"><path d="M70 47.5H30c-1.4.0-2.5 1.1-2.5 2.5v40c0 1.4 1.1 2.5 2.5 2.5h40c1.4.0 2.5-1.1 2.5-2.5V50C72.5 48.6 71.4 47.5 70 47.5zm-22.5 40h-5v-25h5v25zm10 0h-5v-25h5v25zm10 0h-5V60c0-1.4-1.1-2.5-2.5-2.5H40c-1.4.0-2.5 1.1-2.5 2.5v27.5h-5v-35h35v35z"/><path d="M50 42.5c1.4.0 2.5-1.1 2.5-2.5V16l5.7 5.7c.5.5 1.1.7 1.8.7s1.3-.2 1.8-.7c1-1 1-2.6.0-3.5l-10-10c-1-1-2.6-1-3.5.0l-10 10c-1 1-1 2.6.0 3.5 1 1 2.6 1 3.5.0l5.7-5.7v24c0 1.4 1.1 2.5 2.5 2.5z"/></svg>
Back to the top</div></div><iframe src=https://github.com/sponsors/MaxHalford/button title="Sponsor MaxHalford" height=32 width=114 style=border:0;border-radius:6px></iframe></div><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script><script>var elementButton=document.querySelector(".elevator"),elevator=new Elevator({element:elementButton,mainAudio:"/music/elevator.mp3",endAudio:"/music/ding.mp3"})</script><style>.down-arrow{font-size:120px;margin-top:90px;margin-bottom:90px;text-shadow:0 -20px #0c1f31,0 0 #c33329;color:transparent;-webkit-transform:scaleY(.8);-moz-transform:scaleY(.8);transform:scaleY(.8)}.elevator{text-align:center;cursor:pointer;width:140px;margin:auto}.elevator:hover{opacity:.7}.elevator svg{width:40px;height:40px;display:block;margin:auto;margin-bottom:5px}</style><div class=related-content><h3 style=margin-top:10px!important;margin-bottom:10px!important>Related posts</h3><ul style=margin-top:0><li><a href=/slides/online-decision-trees.pdf>Online machine learning with decision trees @ Toulouse AOC workgroup</a></li><li><a href=/blog/dbt-ref-rant/>A rant against dbt ref</a></li><li><a href="https://www.youtube.com/watch?v=pxs-ghWvr0M">Online machine learning in practice @ Applied AI</a></li></ul></div></div></div></article></body></html>