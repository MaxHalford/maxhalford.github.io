<!doctype html><html lang=en><head><script defer src=https://unpkg.com/@tinybirdco/flock.js data-host=https://api.tinybird.co data-token=p.eyJ1IjogImMwMjJhMjg1LWJmY2YtNDc0OC1hYzczLTJhMDQ1Njk3NTI0YyIsICJpZCI6ICIzNjc3NjQ3Ny04MTE2LTRmYWQtYjcwMy1iZmM3YjMwZGJjMjMifQ.A0vHm-VWbXG6uBFZiwuspN_AyfSYNrdZE3IgwgWSt4g></script><meta charset=utf-8><meta name=generator content="Hugo 0.119.0"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Max Halford"><meta property="og:url" content="https://maxhalford.github.io/blog/grouping-sets/"><link rel=canonical href=https://maxhalford.github.io/blog/grouping-sets/><meta property="og:title" content="Dashboards and GROUPING SETS"><meta property="og:description" content="Motivation At Alan, we do almost all our data analysis in SQL. Our data warehouse used to be PostgreSQL, and have since switched to Snowflake for performance reasons. We load data into our warehouse with Airflow. This includes dumps of our production database, third-party data, and health data from other actors in the health ecosystem. This is raw data. We transform this into prepared data via an in-house tool that resembles dbt."><meta property="og:type" content="article"><meta property="og:url" content="https://maxhalford.github.io/blog/grouping-sets/"><meta property="og:image" content="https://maxhalford.github.io/img/beach.jpg"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-09-10T00:00:00+00:00"><meta property="article:modified_time" content="2021-09-10T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maxhalford.github.io/img/beach.jpg"><meta name=twitter:title content="Dashboards and GROUPING SETS"><meta name=twitter:description content="Motivation At Alan, we do almost all our data analysis in SQL. Our data warehouse used to be PostgreSQL, and have since switched to Snowflake for performance reasons. We load data into our warehouse with Airflow. This includes dumps of our production database, third-party data, and health data from other actors in the health ecosystem. This is raw data. We transform this into prepared data via an in-house tool that resembles dbt."><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¦”</text></svg>"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/maxhalford.github.io\/"},"articleSection":"blog","name":"Dashboards and GROUPING SETS","headline":"Dashboards and GROUPING SETS","description":"Motivation At Alan, we do almost all our data analysis in SQL. Our data warehouse used to be PostgreSQL, and have since switched to Snowflake for performance reasons. We load data into our warehouse with Airflow. This includes dumps of our production database, third-party data, and health data from other actors in the health ecosystem. This is raw data. We transform this into prepared data via an in-house tool that resembles dbt.","inLanguage":"en-US","author":"Max Halford","creator":"Max Halford","publisher":"Max Halford","accountablePerson":"Max Halford","copyrightHolder":"Max Halford","copyrightYear":"2021","datePublished":"2021-09-10 00:00:00 \u002b0000 UTC","dateModified":"2021-09-10 00:00:00 \u002b0000 UTC","url":"https:\/\/maxhalford.github.io\/blog\/grouping-sets\/","keywords":["data-eng","sql"]}</script><title>Dashboards and GROUPING SETS â€¢ Max Halford</title><meta property="og:title" content="Dashboards and GROUPING SETS â€¢ Max Halford"><meta property="og:type" content="article"><meta name=description content="Motivation At Alan, we do almost all our data analysis in SQL. Our data warehouse used to be PostgreSQL, and have since switched to Snowflake for performance reasons. We load data into our warehouse with Airflow. This includes dumps of our production database, third-party data, and health data from other actors in the health ecosystem. This is raw data. We transform this into prepared data via an in-house tool that resembles dbt."><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.css><link rel=stylesheet href=/css/github-markdown.min.css><link rel=stylesheet href=/css/highlight/github.css><link rel=stylesheet href=/css/index.css><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=PT+Serif:wght@400;700&family=Permanent+Marker&display=swap" rel=stylesheet><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["\\[","\\]"]],processEscapes:!0,processEnvironments:!0,tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre"]}},window.addEventListener("load",e=>{document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"})})</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></head><body><article class=post id=article><div class="row center-xs" style=text-align:left><div class="col-xs-12 col-sm-10 col-md-7 col-lg-5"><div class=header><header class=header-parts><div class="signatures site-title"><a href=/>Max Halford ğŸ¦”</a></div><div class=header-links><a class=header-link href=/>Blog</a>
<a class=header-link href=/links/>Links</a>
<a class=header-link href=/bio/>Bio</a></div></header></div><header class=post-header><h1 class=post-title>Dashboards and GROUPING SETS</h1><div class="row post-desc"><div class="col-xs-12 post-desc-items"><time class=post-date datetime="2021-09-10 00:00:00 UTC">2021-09-10</time>
<span class=posts-line-tag>data-eng</span>
<span class=posts-line-tag>sql</span></div></div></header><div class="post-content markdown-body"><h2 id=toc>Table of contents</h2><nav id=TableOfContents><ul><li><a href=#motivation>Motivation</a></li><li><a href=#what-grouping-sets-does>What <code>GROUPING SETS</code> does</a></li><li><a href=#a-pattern-for-creating-dashboards>A pattern for creating dashboards</a></li><li><a href=#shortcuts-cube-and-rollup>Shortcuts: <code>CUBE</code> and <code>ROLLUP</code></a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav><h2 id=motivation>Motivation</h2><p>At <a href=https://alan.com/>Alan</a>, we do almost all our data analysis in SQL. Our data warehouse used to be <a href=https://www.postgresql.org/>PostgreSQL</a>, and have since switched to <a href=https://www.snowflake.com/>Snowflake</a> for performance reasons. We load data into our warehouse with <a href=https://airflow.apache.org/>Airflow</a>. This includes dumps of our production database, third-party data, and health data from other actors in the health ecosystem. This is raw data. We transform this into prepared data via an in-house tool that resembles <a href=https://www.getdbt.com/>dbt</a>. You can read more about it <a href=https://medium.com/alan/how-we-solve-the-problem-of-sharing-actionable-data-with-the-team-7e4afeff3cac>here</a>.</p><p>Our data analysis is done on top of our prepared data. We use <a href=https://www.metabase.com/>Metabase</a> to create dashboards. Recently, we&rsquo;ve been having a lot of discussion around our setup. Metabase allows querying the data warehouse with SQL. This gives us the liberty to do whatever we want between the data warehouse and the visualisation. This sounds great&mldr; but it&rsquo;s not. Indeed, it&rsquo;s too permissive.</p><p>One of the issues we&rsquo;re facing is that we have a lot of business logic that is stored in Metabase, rather than being versioned in our analytics codebase. There is also business logic that is duplicated in many places across Metabase. Moreover, when we make a change to our prepared data, it&rsquo;s burdensome to propagate the changes into our dashboards.</p><p>Generally speaking, we wish to change our relationship with Metabase. We&rsquo;ve agreed that the less SQL code is in Metabase, the better. We&rsquo;re addressing this via various initiatives. One of them is to prepare data in such a way that it can be consumed in a dashboard with minimal effort. We recently discovered that Snowflake has a <a href=https://docs.snowflake.com/en/sql-reference/constructs/group-by-grouping-sets.html><code>GROUPING SETS</code></a> operator. This has unlocked quite a powerful pattern for us. Before delving into said pattern, let us start by dwelling on what this operator does.</p><h2 id=what-grouping-sets-does>What <code>GROUPING SETS</code> does</h2><p>Let&rsquo;s use a toy example to illustrate.</p><p>As a health insurance company, it is key for us is to keep track of our margin. We do this by comparing premiums, which is the money we receive from the people we cover, with claims, which are the healthcare expenses we reimburse. Assuming we&rsquo;ve collected these figures at a company level, this might result in such a <a href=https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html>tidy</a> dataset:</p><table><thead><tr><th>week</th><th style=text-align:center>country</th><th style=text-align:center>industry</th><th style=text-align:right>premiums</th><th style=text-align:right>claims</th></tr></thead><tbody><tr><td>2021-01-01</td><td style=text-align:center>ğŸ‡«ğŸ‡·</td><td style=text-align:center>ğŸ¥</td><td style=text-align:right>10,000</td><td style=text-align:right>8,000</td></tr><tr><td>2021-01-01</td><td style=text-align:center>ğŸ‡«ğŸ‡·</td><td style=text-align:center>ğŸ­</td><td style=text-align:right>5,000</td><td style=text-align:right>7,000</td></tr><tr><td>2021-01-08</td><td style=text-align:center>ğŸ‡«ğŸ‡·</td><td style=text-align:center>ğŸ¥</td><td style=text-align:right>11,000</td><td style=text-align:right>8,500</td></tr><tr><td>2021-01-08</td><td style=text-align:center>ğŸ‡«ğŸ‡·</td><td style=text-align:center>ğŸ­</td><td style=text-align:right>4,000</td><td style=text-align:right>6,000</td></tr><tr><td>2021-01-01</td><td style=text-align:center>ğŸ‡ªğŸ‡¸</td><td style=text-align:center>ğŸ¥</td><td style=text-align:right>2,000</td><td style=text-align:right>1,800</td></tr><tr><td>2021-01-01</td><td style=text-align:center>ğŸ‡ªğŸ‡¸</td><td style=text-align:center>ğŸ­</td><td style=text-align:right>3,000</td><td style=text-align:right>3,500</td></tr></tbody></table><details><summary>Table definition in SQL</summary><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=n>accounts</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>week</span><span class=p>,</span><span class=w> </span><span class=n>country</span><span class=p>,</span><span class=w> </span><span class=n>industry</span><span class=p>,</span><span class=w> </span><span class=n>premiums</span><span class=p>,</span><span class=w> </span><span class=n>claims</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=k>VALUES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=s1>&#39;2021-01-01&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ğŸ‡«ğŸ‡·&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ğŸ¥&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>10000</span><span class=p>,</span><span class=w> </span><span class=mi>8000</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=s1>&#39;2021-01-01&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ğŸ‡«ğŸ‡·&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ğŸ­&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>5000</span><span class=p>,</span><span class=w> </span><span class=mi>7000</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=s1>&#39;2021-01-08&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ğŸ‡«ğŸ‡·&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ğŸ¥&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>11000</span><span class=p>,</span><span class=w> </span><span class=mi>8500</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=s1>&#39;2021-01-08&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ğŸ‡«ğŸ‡·&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ğŸ­&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>4000</span><span class=p>,</span><span class=w> </span><span class=mi>6000</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=s1>&#39;2021-01-01&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ğŸ‡ªğŸ‡¸&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ğŸ¥&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>2000</span><span class=p>,</span><span class=w> </span><span class=mi>1800</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=s1>&#39;2021-01-01&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ğŸ‡ªğŸ‡¸&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;ğŸ­&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>3000</span><span class=p>,</span><span class=w> </span><span class=mi>3500</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>AS</span><span class=w> </span><span class=n>accounts</span><span class=w> </span><span class=p>(</span><span class=n>week</span><span class=p>,</span><span class=w> </span><span class=n>country</span><span class=p>,</span><span class=w> </span><span class=n>industry</span><span class=p>,</span><span class=w> </span><span class=n>premiums</span><span class=p>,</span><span class=w> </span><span class=n>claims</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>accounts</span><span class=w>
</span></span></span></code></pre></div></details><p>Typically, we compute a <a href=https://www.wikiwand.com/en/Loss_ratio>loss ratio</a> by comparing the premiums with the claims:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>claims</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>premiums</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>loss_ratio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>accounts</span><span class=w>
</span></span></span></code></pre></div><pre tabindex=0><code>0.994286
</code></pre><p>We would like to break this metric down across a few dimensions to get a better understanding. We might want to look at the evolution through time, the country the company is based in, as well as the type of industry it belongs to. But we&rsquo;re greedy, so we also want to look at combinations of these dimensions.</p><p>The naÃ¯ve approach in SQL would be to write down many queries with different <code>GROUP BY</code> statements. This can quickly get verbose and difficult to maintain. This is exactly what the <code>GROUPING SETS</code> operator is meant for. Let&rsquo;s start with a small example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>week</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>industry</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SUM</span><span class=p>(</span><span class=n>claims</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>premiums</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>loss_ratio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>accounts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>country</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;ğŸ‡«ğŸ‡·&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>GROUPING</span><span class=w> </span><span class=k>SETS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>week</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>industry</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>week</span><span class=p>,</span><span class=w> </span><span class=n>industry</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><table><thead><tr><th style=text-align:left>week</th><th style=text-align:center>industry</th><th style=text-align:left>loss_ratio</th></tr></thead><tbody><tr><td style=text-align:left>2021-01-01</td><td style=text-align:center>ğŸ¥</td><td style=text-align:left>0.80</td></tr><tr><td style=text-align:left>2021-01-01</td><td style=text-align:center>ğŸ­</td><td style=text-align:left>1.40</td></tr><tr><td style=text-align:left>2021-01-08</td><td style=text-align:center>ğŸ¥</td><td style=text-align:left>0.77</td></tr><tr><td style=text-align:left>2021-01-08</td><td style=text-align:center>ğŸ­</td><td style=text-align:left>1.50</td></tr><tr><td style=text-align:left>2021-01-01</td><td style=text-align:center>NULL</td><td style=text-align:left>1.00</td></tr><tr><td style=text-align:left>2021-01-08</td><td style=text-align:center>NULL</td><td style=text-align:left>0.97</td></tr><tr><td style=text-align:left>NULL</td><td style=text-align:center>ğŸ¥</td><td style=text-align:left>0.79</td></tr><tr><td style=text-align:left>NULL</td><td style=text-align:center>ğŸ­</td><td style=text-align:left>1.44</td></tr></tbody></table><p>This is in fact the concatenation of three smaller tables:</p><p><strong>(<code>week</code>, <code>industry</code>)</strong></p><table><thead><tr><th style=text-align:left>week</th><th style=text-align:center>industry</th><th style=text-align:left>loss_ratio</th></tr></thead><tbody><tr><td style=text-align:left>2021-01-01</td><td style=text-align:center>ğŸ¥</td><td style=text-align:left>0.80</td></tr><tr><td style=text-align:left>2021-01-01</td><td style=text-align:center>ğŸ­</td><td style=text-align:left>1.40</td></tr><tr><td style=text-align:left>2021-01-08</td><td style=text-align:center>ğŸ¥</td><td style=text-align:left>0.77</td></tr><tr><td style=text-align:left>2021-01-08</td><td style=text-align:center>ğŸ­</td><td style=text-align:left>1.50</td></tr></tbody></table><p><strong>(<code>week</code>)</strong></p><table><thead><tr><th style=text-align:left>week</th><th style=text-align:center>industry</th><th style=text-align:left>loss_ratio</th></tr></thead><tbody><tr><td style=text-align:left>2021-01-01</td><td style=text-align:center>NULL</td><td style=text-align:left>1.00</td></tr><tr><td style=text-align:left>2021-01-08</td><td style=text-align:center>NULL</td><td style=text-align:left>0.97</td></tr></tbody></table><p><strong>(<code>industry</code>)</strong></p><table><thead><tr><th style=text-align:left>week</th><th style=text-align:center>industry</th><th style=text-align:left>loss_ratio</th></tr></thead><tbody><tr><td style=text-align:left>NULL</td><td style=text-align:center>ğŸ¥</td><td style=text-align:left>0.79</td></tr><tr><td style=text-align:left>NULL</td><td style=text-align:center>ğŸ­</td><td style=text-align:left>1.44</td></tr></tbody></table><p>In fact, you could just as well implement a <code>GROUPING SET</code> yourself by concatenating many <code>GROUP BY</code> query results together via some <code>UNION</code> operators. This is nicely illustrated <a href="https://docs.microsoft.com/en-us/previous-versions/sql/sql-server-2008-r2/bb510427(v=sql.105)">here</a>. That&rsquo;s it really, the <code>GROUPING SET</code> operator simply performs and collates many <code>GROUP BY</code> in one fell swoop.</p><h2 id=a-pattern-for-creating-dashboards>A pattern for creating dashboards</h2><p>Data analysis very often boils down to looking at a metric, and drilling down to understand its distribution. This is why the tidy data concept data is so powerful: the data is ready to be aggregated. A dashboard is very often just an interface to display metrics grouped by various dimensions. Ideally, dashboards allow choosing which dimensions to drill down on. Sadly, this isn&rsquo;t available in Metabase. Moreover, the desired aggregation has to be performed live. This costs precious seconds as well as compute credits.</p><p>The nice thing with <code>GROUPING SETS</code> is that all the computation has already been performed. You can just filter the resulting table to look at the set of dimensions you&rsquo;re interested in. One way to do this is by checking on the nullity of the columns:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=n>groups</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>week</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>industry</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SUM</span><span class=p>(</span><span class=n>claims</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>premiums</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>loss_ratio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>accounts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>country</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;ğŸ‡«ğŸ‡·&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>GROUPING</span><span class=w> </span><span class=k>SETS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>week</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>industry</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>week</span><span class=p>,</span><span class=w> </span><span class=n>industry</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>groups</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>week</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>industry</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span></code></pre></div><table><thead><tr><th style=text-align:left>week</th><th style=text-align:center>industry</th><th style=text-align:left>loss_ratio</th></tr></thead><tbody><tr><td style=text-align:left>2021-01-01</td><td style=text-align:center>ğŸ¥</td><td style=text-align:left>0.80</td></tr><tr><td style=text-align:left>2021-01-01</td><td style=text-align:center>ğŸ­</td><td style=text-align:left>1.40</td></tr><tr><td style=text-align:left>2021-01-08</td><td style=text-align:center>ğŸ¥</td><td style=text-align:left>0.77</td></tr><tr><td style=text-align:left>2021-01-08</td><td style=text-align:center>ğŸ­</td><td style=text-align:left>1.50</td></tr></tbody></table><p>This works just fine. It drastically simplifies the query that would have to be written in dashboard. Indeed, there&rsquo;s no need to write a <code>GROUP BY</code> statement.</p><p>If there&rsquo;s a lot of dimensions, writing many <code>WHERE ... IS NOT NULL</code> can get a bit boring. A colleague at Alan found a nice trick to make this easier. The idea is to build a string that indicates which dimensions participate in a group. It&rsquo;s possible to do this in Snowflake by using <a href=https://docs.snowflake.com/en/sql-reference/functions/grouping_id.html><code>GROUPING_ID</code></a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>groups</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>week</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>industry</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ARRAY_TO_STRING</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ARRAY_CONSTRUCT_COMPACT</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>IFF</span><span class=p>(</span><span class=n>GROUPING_ID</span><span class=p>(</span><span class=n>week</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;week&#39;</span><span class=p>,</span><span class=w> </span><span class=k>NULL</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>IFF</span><span class=p>(</span><span class=n>GROUPING_ID</span><span class=p>(</span><span class=n>industry</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;industry&#39;</span><span class=p>,</span><span class=w> </span><span class=k>NULL</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s1>&#39; x &#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>group_by</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>SUM</span><span class=p>(</span><span class=n>claims</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=k>SUM</span><span class=p>(</span><span class=n>premiums</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>loss_ratio</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>accounts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>country</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;ğŸ‡«ğŸ‡·&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>GROUPING</span><span class=w> </span><span class=k>SETS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>week</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>industry</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>(</span><span class=n>week</span><span class=p>,</span><span class=w> </span><span class=n>industry</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>groups</span><span class=w>
</span></span></span></code></pre></div><table><thead><tr><th style=text-align:left>week</th><th style=text-align:left>industry</th><th style=text-align:left>group_by</th><th style=text-align:left>loss_ratio</th></tr></thead><tbody><tr><td style=text-align:left>2021-01-01</td><td style=text-align:left>ğŸ¥</td><td style=text-align:left>week x industry</td><td style=text-align:left>0.80</td></tr><tr><td style=text-align:left>2021-01-01</td><td style=text-align:left>ğŸ­</td><td style=text-align:left>week x industry</td><td style=text-align:left>1.40</td></tr><tr><td style=text-align:left>2021-01-08</td><td style=text-align:left>ğŸ¥</td><td style=text-align:left>week x industry</td><td style=text-align:left>0.77</td></tr><tr><td style=text-align:left>2021-01-08</td><td style=text-align:left>ğŸ­</td><td style=text-align:left>week x industry</td><td style=text-align:left>1.50</td></tr><tr><td style=text-align:left>2021-01-01</td><td style=text-align:left>NULL</td><td style=text-align:left>week</td><td style=text-align:left>1.00</td></tr><tr><td style=text-align:left>2021-01-08</td><td style=text-align:left>NULL</td><td style=text-align:left>week</td><td style=text-align:left>0.97</td></tr><tr><td style=text-align:left>NULL</td><td style=text-align:left>ğŸ¥</td><td style=text-align:left>industry</td><td style=text-align:left>0.79</td></tr><tr><td style=text-align:left>NULL</td><td style=text-align:left>ğŸ­</td><td style=text-align:left>industry</td><td style=text-align:left>1.44</td></tr></tbody></table><p>This is nice, because now we can access a particular group as so:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Before
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>groups</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>week</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>industry</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- After
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>groups</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>group_by</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;week x industry&#39;</span><span class=w>
</span></span></span></code></pre></div><table><thead><tr><th style=text-align:left>week</th><th style=text-align:center>industry</th><th style=text-align:left>loss_ratio</th></tr></thead><tbody><tr><td style=text-align:left>2021-01-01</td><td style=text-align:center>ğŸ¥</td><td style=text-align:left>0.80</td></tr><tr><td style=text-align:left>2021-01-01</td><td style=text-align:center>ğŸ­</td><td style=text-align:left>1.40</td></tr><tr><td style=text-align:left>2021-01-08</td><td style=text-align:center>ğŸ¥</td><td style=text-align:left>0.77</td></tr><tr><td style=text-align:left>2021-01-08</td><td style=text-align:center>ğŸ­</td><td style=text-align:left>1.50</td></tr></tbody></table><p>That&rsquo;s as simple as a query can get. It&rsquo;s just a very readable <code>SELECT FROM WHERE</code>. This is great for us, as it minimizes the amount of SQL we put in Metabase. It also speeds up our dashboards because the heavy-lifting has already been done.</p><h2 id=shortcuts-cube-and-rollup>Shortcuts: <code>CUBE</code> and <code>ROLLUP</code></h2><p>Writing down a <code>GROUPING SETS</code> operator can be a bit tedious. It&rsquo;s also slightly error-prone if you&rsquo;re juggling with a lot of dimensions. Thankfully, in Snowflake there are a couple of operators to ease this process.</p><p>You can use <a href=https://docs.snowflake.com/en/sql-reference/constructs/group-by-cube.html><code>CUBE</code></a> when you want to group on all the combinations of dimensions. It&rsquo;s a good default mode when you&rsquo;re not sure what dimensions are going to be used in the dashboard. By the way, I really think that this notion of having prepared data that does not know how it&rsquo;s going to be used is a powerful idea. It&rsquo;s yet another instance of <a href=https://www.wikiwand.com/en/Data_independence>data independence</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>CUBE</span><span class=w> </span><span class=p>(</span><span class=n>week</span><span class=p>,</span><span class=w> </span><span class=n>country</span><span class=p>,</span><span class=w> </span><span class=n>industry</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- is short for
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>GROUPING</span><span class=w> </span><span class=k>SETS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>week</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>country</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>industry</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>week</span><span class=p>,</span><span class=w> </span><span class=n>country</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>week</span><span class=p>,</span><span class=w> </span><span class=n>industry</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>country</span><span class=p>,</span><span class=w> </span><span class=n>industry</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>week</span><span class=p>,</span><span class=w> </span><span class=n>country</span><span class=p>,</span><span class=w> </span><span class=n>industry</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>You can also the <a href=https://docs.snowflake.com/en/sql-reference/constructs/group-by-rollup.html><code>ROLLUP</code></a> operator if you want to do a <code>GROUPING SETS</code> which drills down over dimensions. It&rsquo;s useful when your dimensions have a hierarchy.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>ROLLUP</span><span class=w> </span><span class=p>(</span><span class=n>week</span><span class=p>,</span><span class=w> </span><span class=n>country</span><span class=p>,</span><span class=w> </span><span class=n>industry</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- is short for
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>GROUPING</span><span class=w> </span><span class=k>SETS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>week</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>week</span><span class=p>,</span><span class=w> </span><span class=n>country</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=n>week</span><span class=p>,</span><span class=w> </span><span class=n>country</span><span class=p>,</span><span class=w> </span><span class=n>industry</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>I hope you found this post useful! Taking a step back, it does feel that this is reinventing the wheel somehow. Writing SQL to connect a data warehouse to a dashboard may seem awkward. But sometimes you&rsquo;re limited by your tools, and you don&rsquo;t have access to an expensive no-code interface to do all this for you.</p><p>Note that I&rsquo;ve been using Snowflake as an example because that&rsquo;s we use at work. But this is also available in <a href=https://www.postgresql.org/docs/10/queries-table-expressions.html#QUERIES-GROUPING-SETS>PostgreSQL</a>, as well as in <a href=https://mysqlserverteam.com/mysql-8-0-grouping-function/>MySQL</a>, but sadly not in SQLite ğŸ˜¢</p></div><script type=text/javascript>var s=document.createElement("script");s.setAttribute("src","https://utteranc.es/client.js"),s.setAttribute("repo","MaxHalford/maxhalford.github.io"),s.setAttribute("issue-term","pathname"),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",null),s.setAttribute("theme","github-light"),document.body.appendChild(s)</script><div style=display:flex;flex-direction:row;justify-content:center;align-items:center;gap:20px;margin-bottom:30px><div class=do-the-thing><div class=elevator><svg class="sweet-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" enable-background="new 0 0 100 100" height="100" width="100"><path d="M70 47.5H30c-1.4.0-2.5 1.1-2.5 2.5v40c0 1.4 1.1 2.5 2.5 2.5h40c1.4.0 2.5-1.1 2.5-2.5V50C72.5 48.6 71.4 47.5 70 47.5zm-22.5 40h-5v-25h5v25zm10 0h-5v-25h5v25zm10 0h-5V60c0-1.4-1.1-2.5-2.5-2.5H40c-1.4.0-2.5 1.1-2.5 2.5v27.5h-5v-35h35v35z"/><path d="M50 42.5c1.4.0 2.5-1.1 2.5-2.5V16l5.7 5.7c.5.5 1.1.7 1.8.7s1.3-.2 1.8-.7c1-1 1-2.6.0-3.5l-10-10c-1-1-2.6-1-3.5.0l-10 10c-1 1-1 2.6.0 3.5 1 1 2.6 1 3.5.0l5.7-5.7v24c0 1.4 1.1 2.5 2.5 2.5z"/></svg>Back to the top</div></div><iframe src=https://github.com/sponsors/MaxHalford/button title="Sponsor MaxHalford" height=32 width=114 style=border:0;border-radius:6px></iframe></div><script src=https://cdnjs.cloudflare.com/ajax/libs/elevator.js/1.0.1/elevator.min.js></script>
<script>var elementButton=document.querySelector(".elevator"),elevator=new Elevator({element:elementButton,mainAudio:"/music/elevator.mp3",endAudio:"/music/ding.mp3"})</script><style>.down-arrow{font-size:120px;margin-top:90px;margin-bottom:90px;text-shadow:0 -20px #0c1f31,0 0 #c33329;color:transparent;-webkit-transform:scaleY(.8);-moz-transform:scaleY(.8);transform:scaleY(.8)}.elevator{text-align:center;cursor:pointer;width:140px;margin:auto}.elevator:hover{opacity:.7}.elevator svg{width:40px;height:40px;display:block;margin:auto;margin-bottom:5px}</style><div class=related-content><h3 style=margin-top:10px!important;margin-bottom:10px!important>Related posts</h3><ul style=margin-top:0><li><a href=/blog/sql-cross-correlations/>Computing cross-correlations in SQL</a></li><li><a href=/blog/pandas-tricks/>A few intermediate pandas tricks</a></li><li><a href=/blog/dataset-time-travel/>An overview of dataset time travel</a></li></ul></div></div></div></article></body></html>